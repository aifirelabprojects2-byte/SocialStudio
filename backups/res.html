<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Intelligence Engine</title>
    
    <!-- Tailwind CSS -->
    <script src="/static/tailwind.js"></script>
    
    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Google Fonts: Inter and DM Serif Display for that professional look -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['DM Serif Display', 'serif'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Markdown Styles to make the output look professional */
        .markdown-body h1 { font-size: 1.5em; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #111827; }
        .markdown-body h2 { font-size: 1.25em; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; color: #374151; }
        .markdown-body h3 { font-size: 1.1em; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.7; color: #4B5563; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.25em; }
        .markdown-body strong { font-weight: 600; color: #111827; }
        .markdown-body em { font-style: italic; color: #4B5563; }
        .markdown-body blockquote { border-left: 4px solid #E5E7EB; padding-left: 1em; color: #6B7280; font-style: italic; }
        
        /* Smooth fade in for content */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom scrollbar for the results area */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-white min-h-screen text-slate-800 font-sans selection:bg-blue-100">

    <div class="max-w-5xl mx-auto px-6 pt-16 pb-20">
        
        <!-- Header Section -->
        <div class="text-center mb-10 mx-20">
            <h1 class="text-5xl font-serif text-slate-900 mb-4 tracking-tight">Product Intelligence</h1>
            <p class="text-lg text-slate-500 font-light max-w-xl mx-auto">
                Instant market feedback. Enter a product and company to stream real-time sentiment analysis and review summaries.
            </p>
        </div>

        <!-- Input Card -->
        <div class="bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 p-3 mx-20 transition-shadow duration-300 hover:shadow-[0_8px_30px_rgb(0,0,0,0.08)]">
            <form id="reviewFormRes" class="relative">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-slate-300 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input
                        type="text"
                        id="productCompanyInputRes"
                        placeholder="e.g., iPhone 15 Apple"
                        class="w-full pl-12 pr-4 py-6 bg-transparent text-xl text-slate-800 placeholder-slate-300 outline-none rounded-2xl"
                        autocomplete="off"
                        required
                    >
                </div>

                <div id="customFilterContainer" class="hidden p-4">
                    <input 
                        type="text" 
                        id="customFilterInput" 
                        placeholder="Filter criteria (e.g., 'Focus on battery life', 'Ignore shipping complaints')" 
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-200 transition-all text-slate-700 placeholder-slate-400"
                    >
                </div>

                <!-- Controls Bar -->
                <div class="flex items-center justify-between px-4 pb-4 pt-2 border-t border-slate-50 mt-2">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center cursor-pointer group">
                            <div class="relative">
                                <input type="checkbox" id="deepSearchToggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-slate-900"></div>
                            </div>
                            <span class="ml-2 text-sm font-medium text-slate-500 group-hover:text-slate-700 transition-colors">Deep Search</span>
                        </label>
                        
                        <div class="h-4 w-px bg-slate-200"></div>

                        <button type="button" id="customFilterToggle" class="flex items-center text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Custom Filters
                        </button>
                    </div>

                    <button
                        type="submit"
                        id="submitButtonRes"
                        class="flex items-center px-6 py-2.5 bg-slate-900 text-white text-sm font-medium rounded-xl hover:bg-slate-800 focus:ring-4 focus:ring-slate-200 transition-all transform active:scale-95 shadow-lg shadow-slate-900/10"
                    >
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Generate Report
                    </button>
                </div>
            </form>
        </div>

        <!-- Status & Error Messages -->
        <div id="loadingIndicatorRes" class="hidden mt-8 text-center fade-in">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-2 h-2 bg-gray-800 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-2 h-2 bg-gray-800 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-800 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
            <p class="mt-3 text-sm text-slate-400 font-medium tracking-wide uppercase">Analysing Sentiment</p>
        </div>

        <div id="errorMessageRes" class="hidden mt-6 mx-auto max-w-lg bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-xl text-sm text-center fade-in"></div>

        <div id="resultsContainer" class="hidden mt-10">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Analysis Results</h2>
                <button onclick="copyToClipboard()" class="text-xs text-slate-400 hover:text-blue-600 transition-colors flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    Copy Report
                </button>
            </div>
            
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100 fade-in relative overflow-hidden">
                <div id="reviewsDisplayRes" class="markdown-body font-sans text-base text-slate-700 leading-relaxed overflow-y-auto custom-scrollbar pr-2"></div>

                <div id="cursor" class="hidden w-2 h-5 bg-slate-900 inline-block align-middle ml-1 animate-pulse"></div>
            </div>
        </div>

    </div>

    <script>
        const formRes = document.getElementById('reviewFormRes');
        const inputRes = document.getElementById('productCompanyInputRes');
        const submitButtonRes = document.getElementById('submitButtonRes');
        const loadingIndicatorRes = document.getElementById('loadingIndicatorRes');
        const errorMessageRes = document.getElementById('errorMessageRes');
        const reviewsDisplayRes = document.getElementById('reviewsDisplayRes');
        const resultsContainer = document.getElementById('resultsContainer');
        const cursor = document.getElementById('cursor');

        // New Input Elements
        const deepSearchToggle = document.getElementById('deepSearchToggle');
        const customFilterToggle = document.getElementById('customFilterToggle');
        const customFilterContainer = document.getElementById('customFilterContainer');
        const customFilterInput = document.getElementById('customFilterInput');

        // Toggle Custom Filter Visibility
        customFilterToggle.addEventListener('click', () => {
            customFilterContainer.classList.toggle('hidden');
            if (!customFilterContainer.classList.contains('hidden')) {
                customFilterInput.focus();
            }
        });


        marked.use({
            breaks: true, 
            gfm: true    
        });

        async function handleSubmitRes(event) {
            event.preventDefault();
            const productCompanyRes = inputRes.value.trim();
 
            const isDeepResearch = deepSearchToggle.checked;
            const customFilter = customFilterInput.value.trim() || null;

            if (!productCompanyRes) return;

            reviewsDisplayRes.innerHTML = '';
            resultsContainer.classList.add('hidden');
            errorMessageRes.classList.add('hidden');
            loadingIndicatorRes.classList.remove('hidden');

            const originalBtnContent = submitButtonRes.innerHTML;
            submitButtonRes.disabled = true;
            submitButtonRes.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;

            let fullTextBuffer = '';

            try {

                const payload = { 
                    product_company: productCompanyRes,
                    is_deepresearch_needed: isDeepResearch,
                    custom_filter: customFilter
                };

                const responseRes = await fetch('/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!responseRes.ok) {
                    const errorDataRes = await responseRes.json();
                    throw new Error(errorDataRes.detail || 'Request failed');
                }

                loadingIndicatorRes.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                cursor.classList.remove('hidden'); 

                const readerRes = responseRes.body.getReader();
                const decoderRes = new TextDecoder();

                while (true) {
                    const { done, value } = await readerRes.read();
                    if (done) break;

                    const chunk = decoderRes.decode(value, { stream: true });
                    fullTextBuffer += chunk;

                    reviewsDisplayRes.innerHTML = marked.parse(fullTextBuffer);

                    reviewsDisplayRes.scrollTop = reviewsDisplayRes.scrollHeight;
                }

                if (fullTextBuffer.trim()) {
                     reviewsDisplayRes.innerHTML = marked.parse(fullTextBuffer);
                }

            } catch (errorRes) {
                errorMessageRes.textContent = errorRes.message || 'An error occurred while fetching reviews.';
                errorMessageRes.classList.remove('hidden');
                loadingIndicatorRes.classList.add('hidden');
            } finally {
                submitButtonRes.disabled = false;
                submitButtonRes.innerHTML = originalBtnContent;
                cursor.classList.add('hidden'); 
            }
        }

        formRes.addEventListener('submit', handleSubmitRes);

        function copyToClipboard() {
            const text = reviewsDisplayRes.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Report copied to clipboard!');
            });
        }

        // Health check on load (Non-blocking)
        window.addEventListener('load', async () => {
            try {
                await fetch('/health');
                console.log('System ready');
            } catch (e) {
                console.warn('API health check pending:', e);
            }
        });
    </script>
</body>
</html>