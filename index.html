<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Monochrome minimalist scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .loading-spinner-Vds {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 2px solid #000000;
            width: 18px;
            height: 18px;
            animation: spinVds 0.8s linear infinite;
        }
        @keyframes spinVds {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        input[type="color"] {
            -webkit-appearance: none;
            appearance: initial;
            border: 1px solid #e5e7eb;
            padding: 2px;
            border-radius: 0.375rem;
            background: white;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.25rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen font-sans selection:bg-slate-900 selection:text-white flex items-center justify-center">

    <div class="container mx-auto px-6 py-4 max-w-7xl">

        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-slate-900 dark:text-white mb-3">
                VideoGen
            </h1>
            <p class="text-gray-600 dark:text-slate-400 text-lg">
                Minimalist content creator tool.
            </p>
        </div>
        
        <form id="videoFormVds" class="w-full">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                
                <div class="lg:col-span-4 flex flex-col gap-5 h-full">
                    <div class="group relative flex-grow">
                        <div class="border-2 border-dashed border-gray-300 rounded-xl bg-white p-6 text-center transition-all duration-300 hover:border-black hover:bg-gray-50 cursor-pointer h-48 lg:h-[20rem] flex flex-col items-center justify-center" id="dropZoneVds">
                            <input type="file" id="videoFileVds" name="video" class="hidden" accept="video/*" required>
                            <label for="videoFileVds" class="cursor-pointer flex flex-col items-center justify-center w-full h-full">
                                <div class="w-12 h-12 mb-3 rounded-full bg-gray-100 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                    <i class="fa-solid fa-plus text-xl text-gray-600"></i>
                                </div>
                                <span class="text-gray-900 font-medium text-lg" id="fileNameVds">Upload Video</span>
                                <span class="text-sm text-gray-400 mt-2 font-mono">MP4, MOV (MAX 100MB)</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="submitBtnVds" class="w-full bg-black text-white font-bold py-4 rounded-full shadow-lg hover:bg-slate-900 transform active:scale-[0.99] transition-all duration-200 flex items-center justify-center border border-transparent">
                        <span id="btnTextVds" class="flex items-center">
                            Generate Video <i class="fa-solid fa-arrow-right ml-2 text-sm"></i>
                        </span>
                    </button>
                </div>

                <div class="lg:col-span-8 bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="space-y-3">
                            <div class="flex items-center space-x-2 border-b border-gray-100 pb-2 mb-3">
                                <span class="w-5 h-5 rounded-full bg-slate-900 text-white flex items-center justify-center text-[10px] font-bold">1</span>
                                <h3 class="text-sm font-bold uppercase tracking-wider text-gray-900">Heading</h3>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Text</label>
                                    <input type="text" name="caption_heading" placeholder="ENTER TITLE" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black focus:border-black outline-none transition font-medium">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Size</label>
                                        <input type="number" name="caption_heading_font_size" value="70" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Color</label>
                                        <select name="caption_heading_color" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none cursor-pointer">
                                            <option value="white">White</option>
                                            <option value="black">Black</option>
                                            <option value="yellow">Yellow</option>
                                            <option value="red">Red</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Font</label>
                                    <select name="caption_heading_font" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none">
                                        <option value="Arial">Arial</option>
                                        <option value="Arial Bold">Arial Bold</option>
                                        <option value="Calibri">Calibri</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center space-x-2 border-b border-gray-100 pb-2 mb-3">
                                <span class="w-5 h-5 rounded-full bg-slate-900 text-white flex items-center justify-center text-[10px] font-bold">2</span>
                                <h3 class="text-sm font-bold uppercase tracking-wider text-gray-900">Captions</h3>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Content</label>
                                    <textarea name="caption_text" placeholder="Type caption..." rows="2" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none transition font-medium">Your Caption Here</textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Size</label>
                                        <input type="number" name="caption_text_font_size" value="45" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Color</label>
                                        <select name="caption_text_color" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none cursor-pointer">
                                            <option value="white">White</option>
                                            <option value="yellow">Yellow</option>
                                            <option value="cyan">Cyan</option>
                                            <option value="lime">Lime</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Font</label>
                                    <select name="caption_text_font" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none">
                                        <option value="Arial">Arial</option>
                                        <option value="Arial Bold">Arial Bold</option>
                                        <option value="Calibri">Calibri</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2 pt-2">
                            <div class="flex items-center space-x-2 border-b border-gray-100 pb-2 mb-3">
                                <span class="w-5 h-5 rounded-full bg-slate-900 text-white flex items-center justify-center text-[10px] font-bold">3</span>
                                <h3 class="text-sm font-bold uppercase tracking-wider text-gray-900">Output Settings</h3>
                            </div>

                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Framerate</label>
                                    <select name="fps" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none cursor-pointer">
                                        <option value="30">30 FPS</option>
                                        <option value="60" selected>60 FPS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Bitrate</label>
                                    <select name="bitrate" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded focus:ring-1 focus:ring-black outline-none cursor-pointer">
                                        <option value="4000k">Medium</option>
                                        <option value="8000k" selected>High (HQ)</option>
                                        <option value="20000k">4k</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Bg Color</label>
                                    <div class="flex items-center">
                                        <input type="color" name="background_color" value="#000000" class="w-full h-9 cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </form>
        <div id="progressSectionVds" class="hidden mt-3">
            <div class="flex justify-between items-end mb-1">
                <span id="progressStatusVds" class="text-sm font-bold uppercase tracking-wider text-gray-600">Initializing...</span>
                <span id="progressPercentVds" class="text-sm font-mono font-bold text-black">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2">
                <div id="progressBarVds" class="bg-slate-900 h-3  transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="logContainerVds" class="bg-white border border-gray-200 text-gray-600 text-[12px] p-2 rounded-lg h-24 overflow-y-auto font-mono">
                <p class="text-gray-400">> Ready for instructions...</p>
            </div>
        </div>

        <div id="resultSectionVds" class="hidden mt-3">
            <div class="border border-gray-200 bg-white rounded-xl p-4 text-center shadow-sm">
                <div class="inline-flex items-center justify-center w-10 h-10 bg-slate-900 text-white rounded-full mb-2">
                    <i class="fa-solid fa-check text-sm"></i>
                </div>
                <h3 class="text-sm font-bold text-gray-900">Process Complete</h3>
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <a id="downloadLinkVds" href="#" class="bg-slate-900 text-white py-2 rounded-lg font-bold hover:bg-slate-800 transition text-sm flex items-center justify-center">
                        <i class="fa-solid fa-download mr-1"></i> Download
                    </a>
                    <button type="button" onclick="location.reload()" class="bg-white border border-gray-300 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-50 transition text-sm">
                        New
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const clientIdVds = 'client_' + Math.random().toString(36).substr(2, 9);
        let wsVds;
        const formVds = document.getElementById('videoFormVds');
        const fileInputVds = document.getElementById('videoFileVds');
        const fileNameDisplayVds = document.getElementById('fileNameVds');
        const submitBtnVds = document.getElementById('submitBtnVds');
        const btnTextVds = document.getElementById('btnTextVds');
        const progressSectionVds = document.getElementById('progressSectionVds');
        const progressBarVds = document.getElementById('progressBarVds');
        const progressPercentVds = document.getElementById('progressPercentVds');
        const progressStatusVds = document.getElementById('progressStatusVds');
        const resultSectionVds = document.getElementById('resultSectionVds');
        const downloadLinkVds = document.getElementById('downloadLinkVds');
        const logContainerVds = document.getElementById('logContainerVds');

        // File Selection Logic
        fileInputVds.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileNameDisplayVds.textContent = e.target.files[0].name;
                fileNameDisplayVds.classList.add('underline');
            }
        });

        // Setup WebSocket
        function connectWebSocketVds() {
            // Determine WS protocol based on current page protocol
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Assuming the endpoint logic remains the same, just adding Vds to client ID variable used here
            wsVds = new WebSocket(`${protocol}//${window.location.host}/ws/${clientIdVds}`);

            wsVds.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'progress') {
                    const percent = data.progress;
                    progressBarVds.style.width = percent + '%';
                    progressPercentVds.textContent = percent + '%';
                    progressStatusVds.textContent = data.message;
                } else if (data.type === 'log') {
                    const p = document.createElement('p');
                    p.textContent = '> ' + data.message;
                    p.className = "mb-1 border-b border-gray-100 pb-1 last:border-0";
                    logContainerVds.appendChild(p);
                    logContainerVds.scrollTop = logContainerVds.scrollHeight;
                } else if (data.type === 'status') {
                    progressStatusVds.textContent = data.message;
                } else if (data.type === 'complete') {
                    progressBarVds.style.width = '100%';
                    progressPercentVds.textContent = '100%';
                    progressStatusVds.textContent = 'Complete';
                    
                    // Bug Fix: Reset button animation immediately on completion
                    resetButtonStateVds();

                    setTimeout(() => {
                        progressSectionVds.classList.add('hidden');
                        resultSectionVds.classList.remove('hidden');
                        downloadLinkVds.href = data.download_url;
                    }, 800);
                } else if (data.type === 'error') {
                    alert(data.message);
                    resetUIVds();
                }
            };

            wsVds.onerror = (error) => {
                console.error("WebSocket Error:", error);
            };
        }

        function resetButtonStateVds() {
            submitBtnVds.disabled = false;
            btnTextVds.innerHTML = 'Generate Video <i class="fa-solid fa-arrow-right ml-2 text-sm"></i>';
            submitBtnVds.classList.remove('opacity-75', 'cursor-not-allowed');
        }

        function resetUIVds() {
            resetButtonStateVds();
            progressSectionVds.classList.add('hidden');
        }

        // Form Submit
        formVds.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!fileInputVds.files.length) {
                alert("Please select a video file first.");
                return;
            }

            // UI Loading State
            submitBtnVds.disabled = true;
            submitBtnVds.classList.add('opacity-75', 'cursor-not-allowed');
            // Using black spinner styling defined in CSS
            btnTextVds.innerHTML = '<div class="loading-spinner-Vds mr-3"></div> Processing...';
            
            progressSectionVds.classList.remove('hidden');
            resultSectionVds.classList.add('hidden');
            logContainerVds.innerHTML = '<p class="text-gray-400">> Connection established...</p>';
            progressBarVds.style.width = '0%';
            progressPercentVds.textContent = '0%';

            // Ensure WebSocket is connected
            if (!wsVds || wsVds.readyState !== WebSocket.OPEN) {
                connectWebSocketVds();
                // Give it a moment to connect
                await new Promise(r => setTimeout(r, 1000));
            }

            const formData = new FormData(formVds);
            formData.append('client_id', clientIdVds);

            try {
                const response = await fetch('/process-video', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                console.error("Upload Error:", error);
                alert("Upload failed: " + error.message);
                resetUIVds();
            }
        });

        // Initialize connection immediately to be ready
        connectWebSocketVds();

    </script>
</body>
</html>