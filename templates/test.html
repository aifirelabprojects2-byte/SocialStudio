<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Post Rephraser</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }

        /* Shimmer Animation */
        .shimmer-text-rfx {
            background: linear-gradient(to right, #1f2937 0%, #9ca3af 50%, #1f2937 100%);
            background-size: 200% auto;
            color: #000;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerRfx 3s linear infinite;
            font-weight: 500;
        }

        @keyframes shimmerRfx {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .icon-input-wrapper { position: relative; }
        .icon-input-wrapper svg {
            position: absolute;
            left: 13px;
            top: 23px;
            transform: translateY(-50%);
            color: #6b7280;
            pointer-events: none;
        }
        .icon-input-wrapper input, .icon-input-wrapper textarea, .icon-input-wrapper select {
            padding-left: 40px; /* Space for icon */
        }

        /* Transition for collapsible content */
        .collapse-content {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8">

    <div class="text-center mb-10">
        <div class="flex items-center justify-center space-x-3 mb-2">
            <svg class="w-8 h-8 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">Social Post Rephraser</h1>
        </div>
        <p class="text-sm text-gray-500">
            Fetch, reimagine, and optimize your social content.
        </p>
    </div>

    <div class="w-full max-w-3xl space-y-6">

        <div class="bg-white border border-gray-200 rounded-3xl p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center space-x-2 mb-4">
            </div>

            <form id="fetchFormRfx" class="space-y-4">
                <div>
                    <label for="urlRfx" class="sr-only">Post URL</label>
                    <div class="icon-input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        <input type="url" id="urlRfx" 
                            class="block w-full rounded-3xl border-gray-300 shadow-sm focus:border-gray-800 focus:ring-gray-800 sm:text-sm py-3 border transition-colors" 
                            placeholder="Paste Instagram/Social URL here..." required>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="submit" id="fetchBtnRfx"
                        class="w-full sm:w-auto flex justify-center items-center py-3 px-6 border border-transparent rounded-2xl shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-all transform active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed">
                        <span id="fetchBtnTextRfx" class="flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            Fetch Details
                        </span>
                        <svg id="fetchBtnSpinnerRfx" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>

        <div id="statusContainerRfx" class="min-h-[20px] text-center">
            <div id="statusRfx" class="text-left"></div>

            <div id="processAnimationRfx" class="hidden flex flex-row gap-2 items-center justify-center space-y-4 px-10 py-4 border border-gray-200 rounded-2xl ">
                <svg class="relative w-6 h-6 text-gray-800 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <span style="margin: 0;" id="shimmerTextRfx" class="text-lg shimmer-text-rfx">Initializing...</span>
            </div>
        </div>

        <!-- Skeleton Loader -->
        <div id="skeletonLoaderRfx" class="hidden bg-white border border-gray-200 rounded-2xl p-6 shadow-sm space-y-4">
            <div class="flex items-center space-x-2 mb-4">
                <div class="h-4 bg-gray-200 rounded w-1/4 animate-pulse"></div>
            </div>
            <div class="w-full h-64 bg-gray-100 rounded-2xl animate-pulse flex items-center justify-center">
                <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
            <div class="space-y-3 pt-4">
                <div class="h-3 bg-gray-200 rounded w-full animate-pulse"></div>
                <div class="h-3 bg-gray-200 rounded w-5/6 animate-pulse"></div>
                <div class="h-3 bg-gray-200 rounded w-4/6 animate-pulse"></div>
            </div>
        </div>

        <!-- Actual Fetched Content -->
        <div id="fetchedDetailsRfx" class="hidden bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
            
            <!-- Collapsible Header -->
            <div id="fetchedHeaderBtn" class="p-6 bg-white flex justify-between items-center cursor-pointer border-b border-gray-100 hover:bg-gray-50 transition-colors select-none">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <h2 class="text-lg font-semibold text-gray-800">Fetched Content</h2>
                    <span class="ml-2 px-2.5 py-0.5 bg-gray-100 text-xs font-medium text-gray-600 rounded-full">Ready to Edit</span>
                </div>
                <!-- Chevron Icon -->
                <svg id="fetchedChevron" class="w-5 h-5 text-gray-400 chevron-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>

            <div id="fetchedContentBody" class="collapse-content">
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="space-y-2 flex flex-col">
                        <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">Fetched Image</label>
                        <div id="mediaRfx" class="rounded-3xl overflow-hidden border border-gray-100 bg-gray-50 flex items-center justify-center max-h-[350px]">
                        </div>
                    </div>

                        <div class="space-y-2 flex flex-col">
                            <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">Original Caption</label>
                            <div id="captionRfx" class="text-sm text-gray-600 bg-gray-50 p-4 rounded-2xl border border-gray-100 h-full overflow-y-auto custom-scrollbar max-h-[350px]">
                            </div>
                        </div>
                    </div>

                    <!-- Create Form -->
                    <form id="createFormRfx" class="space-y-5 border-t border-gray-100 pt-6">
                        <!-- Hidden fields -->
                        <input type="hidden" id="fetched_captionRfx">
                        <input type="hidden" id="fetched_imgpathRfx">

                        <div>
                            <label for="rephrase_promptRfx" class="block text-sm font-medium text-gray-700 mb-1">Rephrase Prompt</label>
                            <div class="icon-input-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                <textarea id="rephrase_promptRfx" rows="3" 
                                    class="block w-full rounded-2xl border-gray-300 shadow-sm focus:border-gray-800 focus:ring-gray-800 sm:text-sm py-3 border" 
                                    placeholder="e.g., Make it engaging for shoe lovers, add emojis" required></textarea>
                            </div>
                        </div>

                        <div>
                            <label for="image_suggestionRfx" class="block text-sm font-medium text-gray-700 mb-1">Image Edit Suggestion</label>
                            <div class="icon-input-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>
                                <textarea id="image_suggestionRfx" rows="2" 
                                    class="block w-full rounded-2xl border-gray-300 shadow-sm focus:border-gray-800 focus:ring-gray-800 sm:text-sm py-3 border" 
                                    placeholder="e.g., Add stylish sneakers in the background" required></textarea>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="theme_idRfx" class="block text-sm font-medium text-gray-700 mb-1">Select Theme</label>
                                <div class="icon-input-wrapper">

                                    <svg fill="currentColor" width="18" height="18" viewBox="0 0 32 32" id="icon" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:none;}</style></defs><title>api</title><path d="M26,22a3.86,3.86,0,0,0-2,.57l-3.09-3.1a6,6,0,0,0,0-6.94L24,9.43A3.86,3.86,0,0,0,26,10a4,4,0,1,0-4-4,3.86,3.86,0,0,0,.57,2l-3.1,3.09a6,6,0,0,0-6.94,0L9.43,8A3.86,3.86,0,0,0,10,6a4,4,0,1,0-4,4,3.86,3.86,0,0,0,2-.57l3.09,3.1a6,6,0,0,0,0,6.94L8,22.57A3.86,3.86,0,0,0,6,22a4,4,0,1,0,4,4,3.86,3.86,0,0,0-.57-2l3.1-3.09a6,6,0,0,0,6.94,0L22.57,24A3.86,3.86,0,0,0,22,26a4,4,0,1,0,4-4ZM26,4a2,2,0,1,1-2,2A2,2,0,0,1,26,4ZM4,6A2,2,0,1,1,6,8,2,2,0,0,1,4,6ZM6,28a2,2,0,1,1,2-2A2,2,0,0,1,6,28Zm10-8a4,4,0,1,1,4-4A4,4,0,0,1,16,20Zm10,8a2,2,0,1,1,2-2A2,2,0,0,1,26,28Z" transform="translate(0 0)"/><rect class="cls-1" width="32" height="32"/></svg>
                                    <select id="theme_idRfx" required
                                        class="block w-full rounded-2xl border-gray-300 shadow-sm focus:border-gray-800 focus:ring-gray-800 sm:text-sm py-3 border bg-white">
                                        <option value="">Loading themes...</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="modelRfx" class="block text-sm font-medium text-gray-700 mb-1">Gemini Model</label>
                                <div class="icon-input-wrapper">
                                    <svg fill="currentColor" width="18" height="18" viewBox="0 0 32 32" id="icon" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                          <style>
                                            .cls-1 {
                                              fill: none;
                                            }
                                          </style>
                                        </defs>
                                        <path d="M28.4473,16.1055,23,13.3818V7a1,1,0,0,0-.5527-.8945l-6-3a1.0008,1.0008,0,0,0-.8946,0l-6,3A1,1,0,0,0,9,7v6.3818L3.5527,16.1055A1,1,0,0,0,3,17v7a1,1,0,0,0,.5527.8945l6,3a1.001,1.001,0,0,0,.8946,0L16,25.1182l5.5527,2.7763a1.001,1.001,0,0,0,.8946,0l6-3A1,1,0,0,0,29,24V17A1,1,0,0,0,28.4473,16.1055ZM21,13.3818l-4,2V10.6182l4-2ZM16,5.1182,19.7637,7,16,8.8818,12.2363,7Zm-5,3.5,4,2v4.7636l-4-2ZM9,25.3818l-4-2V18.6182l4,2Zm1-6.5L6.2363,17,10,15.1182,13.7637,17Zm1,1.7364,4-2v4.7636l-4,2Zm10,4.7636-4-2V18.6182l4,2Zm1-6.5L18.2363,17,22,15.1182,25.7637,17Zm5,4.5-4,2V20.6182l4-2Z"/>
                                        <rect id="_Transparent_Rectangle_" data-name="&lt;Transparent Rectangle&gt;" class="cls-1" width="32" height="32"/>
                                      </svg>
                                    <select id="modelRfx" 
                                        class="block w-full rounded-2xl border-gray-300 shadow-sm focus:border-gray-800 focus:ring-gray-800 sm:text-sm py-3 border bg-white">
                                        <option value="gemini-2.5-flash-image" selected>gemini-2.5-flash-image</option>
                                        <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="createSubmitBtnRfx" disabled
                            class="w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-3xl shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all transform hover:scale-[1.02] mt-4">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Generate New Post
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fetchFormRfx = document.getElementById('fetchFormRfx');
        const createFormRfx = document.getElementById('createFormRfx');
        const fetchedDetailsRfx = document.getElementById('fetchedDetailsRfx');
        const skeletonLoaderRfx = document.getElementById('skeletonLoaderRfx');
        const statusRfx = document.getElementById('statusRfx');
        const processAnimationRfx = document.getElementById('processAnimationRfx');
        const shimmerTextRfx = document.getElementById('shimmerTextRfx');
        const createSubmitBtnRfx = document.getElementById('createSubmitBtnRfx');
        
        // Collapsible Elements
        const fetchedHeaderBtn = document.getElementById('fetchedHeaderBtn');
        const fetchedContentBody = document.getElementById('fetchedContentBody');
        const fetchedChevron = document.getElementById('fetchedChevron');

        let animationIntervalRfx;
        const animationPhrasesRfx = [
            "Analyzing aesthetics...",
            "Constructing composition...",
            "Polishing pixels...",
            "Rephrasing content...",
            "Applying themes...",
            "Finalizing edits..."
        ];

        // --- Toggle Logic ---
        fetchedHeaderBtn.addEventListener('click', () => {
            const isHidden = fetchedContentBody.classList.contains('hidden');
            if (isHidden) {
                fetchedContentBody.classList.remove('hidden');
                fetchedChevron.classList.add('rotate-180');
            } else {
                fetchedContentBody.classList.add('hidden');
                fetchedChevron.classList.remove('rotate-180');
            }
        });

        // Helper to force open state
        function openFetchedContent() {
            fetchedContentBody.classList.remove('hidden');
            fetchedChevron.classList.add('rotate-180');
        }

        // --- Animation Logic ---

        function startShimmerAnimationRfx() {
            processAnimationRfx.classList.remove('hidden');
            let index = 0;
            shimmerTextRfx.innerText = animationPhrasesRfx[0];
            
            animationIntervalRfx = setInterval(() => {
                index = (index + 1) % animationPhrasesRfx.length;
                shimmerTextRfx.style.opacity = '0.5';
                setTimeout(() => {
                    shimmerTextRfx.innerText = animationPhrasesRfx[index];
                    shimmerTextRfx.style.opacity = '1';
                }, 200);
            }, 1800);
        }

        function stopShimmerAnimationRfx() {
            clearInterval(animationIntervalRfx);
            processAnimationRfx.classList.add('hidden');
        }

        // --- Load Themes ---
        async function loadThemesRfx() {
            try {
                const response = await fetch(`/api/themes`);
                if (!response.ok) throw new Error('Failed to fetch themes');
                const themes = await response.json();
                
                const select = document.getElementById('theme_idRfx');
                select.innerHTML = '<option value="">Select a theme</option>';
                themes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme.theme_id; 
                    option.textContent = `${theme.name} - ${theme.description}`;
                    select.appendChild(option);
                });
            } catch (error) {
                statusRfx.innerHTML = `<p class="text-red-600 bg-red-50 p-3 rounded-2xl border border-red-200 text-sm flex items-center"><svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Failed to load themes: ${error.message}</p>`;
            }
        }

        loadThemesRfx();

        // --- Fetch Post Logic ---
        fetchFormRfx.addEventListener('submit', async (e) => {
            e.preventDefault();
            const urlVal = document.getElementById('urlRfx').value.trim();
        
            const fetchBtn = document.getElementById('fetchBtnRfx');
            const fetchBtnText = document.getElementById('fetchBtnTextRfx');
            const fetchBtnSpinner = document.getElementById('fetchBtnSpinnerRfx');
        
            // UI States
            fetchBtn.disabled = true;
            fetchBtn.classList.add('opacity-75', 'cursor-not-allowed');
            fetchBtnText.classList.add('hidden');
            fetchBtnSpinner.classList.remove('hidden');
        
            statusRfx.innerHTML = '';
            fetchedDetailsRfx.classList.add('hidden'); 
            skeletonLoaderRfx.classList.remove('hidden'); 

            try {
                const response = await fetch(`/api/fetch-post-details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: urlVal }) 
                });
                const data = await response.json();

                // Hide skeleton
                skeletonLoaderRfx.classList.add('hidden');

                if (response.ok) {
                    const captionHtml = `<p class="whitespace-pre-wrap leading-relaxed">${data.caption ? data.caption : 'No caption'}</p>`;
                    document.getElementById('captionRfx').innerHTML = captionHtml;

                    // Update Media
                    let mediaHtml = '';
                    if (data.media_urls && data.media_urls.length > 0) {
                        data.media_urls.forEach((url, index) => {
                            const ext = url.split('.').pop().toLowerCase();
                            if (['mp4', 'mov', 'avi'].includes(ext)) {
                                mediaHtml += `
                                    <video controls class="w-full h-auto rounded-lg shadow-sm">
                                        <source src="${url}" type="video/mp4">
                                        Your browser does not support video.
                                    </video>`;
                            } else {
                                mediaHtml += `
                                    <img src="${url}" alt="Post media ${index + 1}" class="w-full h-auto rounded-lg shadow-sm object-cover"
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div class="hidden text-center p-4 text-gray-400 bg-gray-100 rounded-lg">
                                        <span class="block text-2xl mb-2">⚠️</span>
                                        Image failed to load
                                    </div>`;
                            }
                        });
                    } else {
                        mediaHtml = '<div class="p-8 text-center text-gray-400 bg-gray-50 rounded-lg w-full"><p class="italic">No media found.</p></div>';
                    }
                    document.getElementById('mediaRfx').innerHTML = mediaHtml;

                    // Store Hidden Data
                    document.getElementById('fetched_captionRfx').value = data.caption || '';

                    // Image Logic
                    let imgpath = '';
                    if (data.media_urls && data.media_urls.length > 0) {
                        const firstImage = data.media_urls.find(url => {
                            const ext = url.split('.').pop().toLowerCase();
                            return !['mp4', 'mov', 'avi'].includes(ext);
                        });
                        imgpath = firstImage || data.media_urls[0];
                    }
                    document.getElementById('fetched_imgpathRfx').value = imgpath;

                    // Show Results Section
                    fetchedDetailsRfx.classList.remove('hidden');
                    openFetchedContent(); // Ensure it's expanded
                    createSubmitBtnRfx.disabled = false;

                } else {
                    statusRfx.innerHTML = `<p class="text-red-600 bg-red-50 p-4 rounded-2xl border border-red-200 text-sm">Error: ${data.detail || 'Unknown error'}</p>`;
                }
            } catch (error) {
                skeletonLoaderRfx.classList.add('hidden');
                statusRfx.innerHTML = `<p class="text-red-600 bg-red-50 p-4 rounded-2xl border border-red-200 text-sm">Fetch error: ${error.message}</p>`;
            }
            finally {
                fetchBtn.disabled = false;
                fetchBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                fetchBtnText.classList.remove('hidden');
                fetchBtnSpinner.classList.add('hidden');
            }
        });

        // --- Create Task Logic ---
        createFormRfx.addEventListener('submit', async (e) => {
            e.preventDefault();

            const captionVal = document.getElementById('fetched_captionRfx').value;
            const imgpathVal = document.getElementById('fetched_imgpathRfx').value;
            const rephrase_promptVal = document.getElementById('rephrase_promptRfx').value.trim();
            const image_suggestionVal = document.getElementById('image_suggestionRfx').value.trim();
            const theme_idVal = document.getElementById('theme_idRfx').value;
            const modelVal = document.getElementById('modelRfx').value;

            if (!imgpathVal) {
                statusRfx.innerHTML = '<p class="text-red-600 bg-red-50 p-3 rounded-2xl border border-red-200 text-sm">No image found in the post. Cannot proceed.</p>';
                return;
            }

            if (!theme_idVal) {
                statusRfx.innerHTML = '<p class="text-red-600 bg-red-50 p-3 rounded-2xl border border-red-200 text-sm">Please select a theme.</p>';
                return;
            }

            // Lock UI
            createSubmitBtnRfx.disabled = true;
            statusRfx.innerHTML = '';
            
            // KEY REQUEST LOGIC: Hide fetched content container during animation
            fetchedDetailsRfx.classList.add('hidden');
            
            // Start Animation
            startShimmerAnimationRfx();

            try {
                // Backend API call
                const response = await fetch(`/api/create-draft-task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rephrase_prompt: rephrase_promptVal,
                        image_suggestion: image_suggestionVal,
                        theme_id: theme_idVal,
                        model: modelVal,
                        imgpath: imgpathVal,
                        caption: captionVal
                    })
                });
                const data = await response.json();

                stopShimmerAnimationRfx();

                if (response.ok) {
                    statusRfx.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-2xl p-5 flex items-start space-x-3 shadow-sm">
                            <svg class="h-6 w-6 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <h3 class="text-sm font-semibold text-green-800">Task Created Successfully!</h3>
                                <p class="text-sm text-green-700 mt-1">Task ID: <span class="font-mono bg-green-100 px-1 rounded">${data.task_id}</span></p>
                                <p class="text-sm text-green-700 mt-1">${data.message}</p>
                            </div>
                        </div>
                    `;
                    createFormRfx.reset();
                    // Keep fetchedDetailsRfx hidden (as previously requested)
                    // Reset hidden fields
                    document.getElementById('fetched_captionRfx').value = '';
                    document.getElementById('fetched_imgpathRfx').value = '';
                    
                } else {
                    // Show Content again on Error
                    fetchedDetailsRfx.classList.remove('hidden');
                    openFetchedContent();
                    statusRfx.innerHTML = `<p class="text-red-600 bg-red-50 p-4 rounded-2xl border border-red-200 text-sm">Error: ${data.detail || 'Unknown error'}</p>`;
                    createSubmitBtnRfx.disabled = false;
                }
            } catch (error) {
                stopShimmerAnimationRfx();
                fetchedDetailsRfx.classList.remove('hidden'); 
                openFetchedContent();
                statusRfx.innerHTML = `<p class="text-red-600 bg-red-50 p-4 rounded-2xl border border-red-200 text-sm">Create error: ${error.message}</p>`;
                createSubmitBtnRfx.disabled = false;
            }
        });
    </script>
</body>
</html>
