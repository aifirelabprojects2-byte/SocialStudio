<!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design | Social Studio</title>
    <meta name="description" content="Describe your idea, and we'll craft the caption, hashtags, and visuals">
    <link rel="icon" href="/static/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js" integrity="sha512-CeIsOAsgJnmevfCi2C7Zsyy6bQKi43utIjdA87Q0ZY84oDqnI0uwfM9+bKiIkI75lUeI00WG/+uJzOmuHlesMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
    const originalRender = fabric.Textbox.prototype.render;
    fabric.Textbox.prototype.render = function(ctx) {
      if (this.backgroundColor && this.shadow) {
        const shadow = this.shadow;
        this.shadow = null;
        this.shadow = null;
        this.shadow = shadow; 
      }
      
      originalRender.call(this, ctx);
    };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;700&family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700;800&family=Lato:wght@300;400;700&family=Open+Sans:wght@300;400;500;600;700&family=Oswald:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&family=Raleway:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&family=Bebas+Neue&family=Archivo+Black&family=Anton&family=Pacifico&family=Dancing+Script:wght@400;500;600;700&family=Caveat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/canva.css">
    </head>
    <body>
    
      <div class="h-14 bg-white px-6 border-b border-gray-200 flex items-center justify-between shrink-0 z-50">
    
        <div class="h-14 flex items-center border-b border-slate-100 flex-shrink-0 bg-white z-10 sticky top-0 group">
          <div class="w-8 h-8 rounded-xl flex items-center border border-gray-200 justify-center shadow-xs mr-2">
               <svg width="23" height="23" viewBox="0 -2 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7601.000000)" fill="currentColor"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M102.8695,7446.25504 C101.3625,7444.73916 98.9185,7444.73916 97.4115,7446.25504 L91.2705,7452.43224 C90.8935,7452.81045 90.8935,7453.42505 91.2705,7453.80428 C91.6475,7454.1835 92.2585,7454.1835 92.6355,7453.80428 L98.7755,7447.62809 C99.5285,7446.86964 100.7515,7446.86964 101.5045,7447.62809 C102.2585,7448.38552 102.2585,7449.61473 101.5045,7450.37317 L95.4825,7456.43066 C96.2355,7457.1881 97.4575,7457.1881 98.2115,7456.43066 L102.8695,7451.74521 C104.3765,7450.22933 104.3765,7447.77092 102.8695,7446.25504 M100.8225,7448.31411 C100.4455,7447.93488 99.8345,7447.93488 99.4575,7448.31411 L93.3175,7454.49029 C92.5635,7455.24874 91.3415,7455.24874 90.5885,7454.49029 C90.2115,7454.11107 89.6005,7454.11107 89.2235,7454.49029 C88.8465,7454.86952 88.8465,7455.48412 89.2235,7455.86233 C90.7305,7457.37922 93.1745,7457.37922 94.6825,7455.86233 L100.8225,7449.68615 C101.1995,7449.30793 101.1995,7448.69232 100.8225,7448.31411 M98.7755,7442.13691 C97.2685,7440.62103 94.8245,7440.62103 93.3175,7442.13691 L87.1765,7448.31411 C86.8005,7448.69232 86.8005,7449.30793 87.1765,7449.68615 C87.5535,7450.06537 88.1645,7450.06537 88.5415,7449.68615 L94.6825,7443.50996 C95.4355,7442.75151 96.6575,7442.75151 97.4105,7443.50996 C97.7875,7443.88918 98.3985,7443.88918 98.7755,7443.50996 C99.1525,7443.13073 99.1525,7442.51613 98.7755,7442.13691 M96.7285,7444.19598 C96.3515,7443.81675 95.7405,7443.81675 95.3645,7444.19598 L89.2235,7450.37317 C88.4695,7451.13061 87.2485,7451.13061 86.4945,7450.37317 C85.7405,7449.61473 85.7405,7448.38552 86.4945,7447.62708 L92.5175,7441.56959 C91.7635,7440.81114 90.5415,7440.81114 89.7875,7441.56959 L85.1295,7446.25504 C83.6235,7447.77092 83.6235,7450.22933 85.1295,7451.74521 C86.6375,7453.2621 89.0805,7453.2621 90.5885,7451.74521 L96.7285,7445.56902 C97.1055,7445.1898 97.1055,7444.5752 96.7285,7444.19598" id="squarespace-[#132]"></path></g></g></g></svg>
          </div>
      
          <a href="/canvas" class="cursor-pointer">
              <div class="flex items-center overflow-hidden ">
                  <span class="font-medium text-slate-800 text-lg tracking-tight whitespace-nowrap">
                      Design<span class="text-gray-400">Studio</span>
                  </span>
              </div>
          </a>
          <div class="flex items-center ml-5  p-1 rounded-3xl border border-gray-100">
            <button onclick="History.undo()" title="Undo (Ctrl+Z)" 
                    class="px-2 py-1 hover:bg-white hover:shadow-sm rounded-md text-gray-600 hover:text-gray-900 transition-all active:scale-95">
                <i data-lucide="undo-2" class="w-4 h-4"></i>
            </button>
            <div class="w-px h-4 bg-gray-200 mx-1"></div>
            <button onclick="History.redo()" title="Redo (Ctrl+Y)" 
                    class="px-2 py-1 hover:bg-white hover:shadow-sm rounded-md text-gray-600 hover:text-gray-900 transition-all active:scale-95">
                <i data-lucide="redo-2" class="w-4 h-4"></i>
            </button>
        </div>
      </div>
    
        
    
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-3 pr-4 border-r border-gray-200">
                
                <div class="relative flex items-center">
                    <select id="export-quality" 
                            class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-xs font-medium rounded-md py-1.5 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all cursor-pointer" 
                            onchange="updateQuality(this.value)">
                        <option value="2">HD (1080p)</option>
                        <option value="3">2K (1440p)</option>
                        <option value="4">4K (2160p)</option>
                    </select>
                    <i data-lucide="chevron-down" class="w-3.5 h-3.5 absolute right-2.5 text-gray-400 pointer-events-none"></i>
                </div>
    
                <button class="flex items-center gap-2 px-5 py-2 bg-white border border-gray-200 rounded-full text-gray-700 text-sm font-medium hover:bg-gray-50 hover:border-gray-300 transition-all active:scale-95" 
                        onclick="Editor.openSaveModal()">
                    Save Template
                </button>
            </div>
    
            <button id="exportBtn" 
                    class="flex items-center gap-2 px-5 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-full  transition-all active:scale-95" 
                    onclick="Editor.exportProject()">
                <i data-lucide="download" class="w-4 h-4 text-gray-100"></i>
                Download
            </button>
        </div>
    </div>
    
    <div class="app-container">
      <aside class="w-[72px] bg-[#f0f1f5] h-full flex flex-col items-center py-3 gap-1 shrink-0 overflow-y-auto z-50">
  
        <div class="nav-item" data-color="purple" onclick="UI.showView('elements')">
          <div class="icon-container w-8 h-8 rounded-lg  justify-center flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shapes-icon lucide-shapes"><path d="M8.3 10a.7.7 0 0 1-.626-1.079L11.4 3a.7.7 0 0 1 1.198-.043L16.3 8.9a.7.7 0 0 1-.572 1.1Z"/><rect x="3" y="14" width="7" height="7" rx="1"/><circle cx="17.5" cy="17.5" r="3.5"/></svg>
          </div>
          <span>Elements</span>
        </div>
      
        <div class="nav-item" data-color="green" onclick="UI.showView('media')">
          <div class="icon-container w-8 h-8 rounded-lg  justify-center flex items-center">
            <svg class="w-6 h-6" viewBox="0 0 24 25" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M21.875 4.944c-1.526-.305-2.183-1.04-2.488-2.527a.188.188 0 0 0-.181-.142.188.188 0 0 0-.181.143c-.147.737-.39 1.276-.764 1.675-.027.03-.055.058-.084.085-.052.05-.109.094-.165.139a2.449 2.449 0 0 1-.398.258 3.17 3.17 0 0 1-.294.134c-.061.024-.12.05-.186.072-.12.04-.25.075-.383.108-.072.018-.138.04-.214.055a.19.19 0 0 0-.128.05h.007a.184.184 0 0 0-.07.14c0 .106.086.191.191.191 1.525.305 2.18 1.025 2.485 2.512.016.088.09.157.184.157.09 0 .162-.064.182-.148.016-.08.037-.147.055-.222.034-.14.07-.274.111-.399.022-.065.047-.126.071-.187.043-.108.088-.21.138-.306.047-.09.093-.182.147-.262l.01-.015a2.315 2.315 0 0 1 .315-.366c.393-.377.923-.617 1.64-.764a.19.19 0 1 0 0-.381ZM15.988 6.933c-.193.643-.503 1.018-1.146 1.146a.14.14 0 0 0 0 .28c.476.143.802.352.993.71.004.008.01.015.014.024.06.12.108.255.139.412a.14.14 0 0 0 .28 0c.048-.16.104-.304.17-.431v-.001c.2-.383.494-.617.976-.714a.14.14 0 0 0 0-.28c-.643-.193-1.017-.503-1.146-1.146a.14.14 0 1 0-.28 0Z" ></path><path d="M20.866 8.104a1.526 1.526 0 0 1-.054.214 1.692 1.692 0 0 1-1.326 1.153c.01.607.011 1.31.011 2.136v.039l-.853-.853a28.039 28.039 0 0 0-.922-.897 1.643 1.643 0 0 1-.985 1.132c.235.215.514.493.876.855l1.884 1.884c-.002 1.475-.013 2.521-.103 3.338-.098.884-.274 1.315-.498 1.613-.17.227-.371.428-.598.598-.298.224-.729.4-1.613.497-.913.102-2.113.104-3.878.104h-1.62c-1.765 0-2.965-.002-3.878-.104-.515-.057-.877-.14-1.147-.244l7.685-7.686c.522-.522.87-.869 1.163-1.103a5.07 5.07 0 0 1 .044-.035c-.226-.144-.685-1.062-1.025-1.1-.353.288-.747.682-1.213 1.148l-7.802 7.802c-.184-.294-.328-.72-.413-1.49-.102-.913-.104-2.113-.104-3.878v-1.62c0-1.765.002-2.965.104-3.878.098-.884.273-1.315.497-1.613.17-.227.371-.428.598-.598.298-.224.729-.4 1.613-.498.913-.101 2.113-.103 3.878-.103h1.62c.789 0 1.464 0 2.052.01a1.692 1.692 0 0 1 1.353-1.452c-.908-.058-2.018-.058-3.405-.058h-1.62c-3.46 0-5.191 0-6.392.901-.34.255-.641.557-.897.897-.9 1.2-.9 2.931-.9 6.392v1.62c0 3.46 0 5.191.9 6.392a4.5 4.5 0 0 0 .897.896c1.2.902 2.931.902 6.392.902h1.62c3.46 0 5.191 0 6.392-.902a4.5 4.5 0 0 0 .897-.896c.901-1.2.901-2.931.901-6.392v-1.62c0-1.55 0-2.753-.08-3.717a4.142 4.142 0 0 0-.05.214Z" ></path><path d="M8.497 10.917a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" ></path></svg>
          </div>
          <span>Media</span>
        </div>
      
        <div class="nav-item" data-color="blue" onclick="UI.showView('text')">
          <div class="icon-container w-8 h-8 rounded-lg  justify-center flex items-center">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M4.266 5.792a1.5 1.5 0 0 1 1.5-1.5h12.468a1.5 1.5 0 0 1 1.5 1.5v1.85a.75.75 0 0 1-1.5 0v-1.35a.5.5 0 0 0-.5-.5H12.75v11.939a.5.5 0 0 0 .5.5h1.875a.75.75 0 0 1 0 1.5h-6.25a.75.75 0 1 1 0-1.5h1.875a.5.5 0 0 0 .5-.5V5.792H6.266a.5.5 0 0 0-.5.5V7.67a.75.75 0 1 1-1.5 0V5.792Z" ></path></svg>
          </div>
          <span>Text</span>
        </div>
      
        <div class="nav-item" data-color="pink" onclick="UI.showView('templates')">
          <div class="icon-container w-8 h-8 rounded-lg  justify-center flex items-center">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 11.325c0-3.59 0-5.385.966-6.61a4.5 4.5 0 0 1 .748-.749C5.94 3 7.734 3 11.325 3h1.35c3.59 0 5.386 0 6.61.966.279.22.53.47.749.748C21 5.94 21 7.734 21 11.325v1.35c0 3.59 0 5.386-.966 6.61-.22.279-.47.53-.748.749-1.226.966-3.02.966-6.611.966h-1.35c-3.59 0-5.385 0-6.61-.966a4.497 4.497 0 0 1-.749-.748C3 18.06 3 16.266 3 12.675v-1.35ZM11.325 4.5H13.5v15h-2.175c-1.83 0-3.076-.002-4.021-.111-.914-.105-1.356-.293-1.661-.533a3.004 3.004 0 0 1-.499-.499c-.24-.305-.428-.747-.533-1.661-.109-.945-.111-2.19-.111-4.021v-1.35c0-1.83.002-3.076.11-4.021.106-.914.293-1.356.534-1.661a3 3 0 0 1 .499-.499c.305-.24.747-.428 1.661-.533.945-.109 2.19-.111 4.021-.111ZM15 19.486c.666-.014 1.22-.042 1.696-.097.914-.105 1.356-.293 1.661-.533.186-.146.353-.314.499-.499.24-.305.428-.747.533-1.661.109-.945.111-2.19.111-4.021v-1.657H15v8.468Zm4.494-9.968c-.01-.904-.037-1.619-.105-2.214-.105-.914-.293-1.356-.533-1.661a3.004 3.004 0 0 0-.499-.499c-.305-.24-.747-.428-1.661-.533A18.58 18.58 0 0 0 15 4.514v5.004h4.494Z" ></path></svg>
          </div>
          <span>Designs</span>
        </div>
      
        <div class="nav-item" data-color="orange" onclick="UI.showView('background')">
          <div class="icon-container w-8 h-8 rounded-lg  justify-center flex items-center">
           <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rainbow-icon lucide-rainbow"><path d="M22 17a10 10 0 0 0-20 0"/><path d="M6 17a6 6 0 0 1 12 0"/><path d="M10 17a2 2 0 0 1 4 0"/></svg>
        </div>
          <span>Colors</span>
        </div>
      
        <div class="nav-item" data-color="teal" onclick="UI.showView('resize')">
          <div class="icon-container w-8 h-8 rounded-lg  justify-center flex items-center">
           <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ratio-icon lucide-ratio"><rect width="12" height="20" x="6" y="2" rx="2"/><rect width="20" height="12" x="2" y="6" rx="2"/></svg></div>
          <span>Resize</span>
        </div>
      
        <div class="nav-item" data-color="violet" onclick="UI.showView('styles')">
          <div class="icon-container w-8 h-8 rounded-lg  justify-center flex items-center">
            
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eclipse-icon lucide-eclipse"><circle cx="12" cy="12" r="10"/><path d="M12 2a7 7 0 1 0 10 10"/></svg>
          </div>
          <span>Style</span>
        </div>

        <div class="nav-item" data-color="draw" onclick="UI.showView('draw')">
          <div class="icon-container w-8 h-8 rounded-lg justify-center flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-line-squiggle-icon lucide-line-squiggle"><path d="M7 3.5c5-2 7 2.5 3 4C1.5 10 2 15 5 16c5 2 9-10 14-7s.5 13.5-4 12c-5-2.5.5-11 6-2"/></svg>
          </div>
          <span>Draw</span>
        </div>
        
      </aside>
      <div id="sidebar-panel" class="sidebar collapsed bg-gradient-to-r from-[#f0f1f5] to-white w-80 flex flex-col z-30 border-r border-border-light relative transition-all duration-300 ease-in-out">
        <!-- Collapse Toggle Button -->
        <button id="sidebar-toggle" onclick="UI.toggleSidebar()" 
          class="absolute -right-3.5 top-1/2 -translate-y-1/2 z-20 w-7 h-11 bg-white border border-gray-200 rounded-full shadow-lg hover:bg-gray-50 hover:shadow-md transition-all duration-200 flex items-center justify-center text-gray-500 hover:text-gray-700">
          <i data-lucide="chevron-left" class="w-4 h-4 sidebar-toggle-icon transition-transform duration-300"></i>
        </button>
        <div class="sidebar-header" style="padding:15px; border-bottom:1px solid #eee;">
          <span id="sidebar-title" style="font-weight:500; font-size:16px;">Background</span>
        </div>
      
        <div class="sidebar-content" style="padding:0;">

        <div id="view-properties" class="sidebar-view ">
            <div id="selection-controls" class="p-4 flex flex-col gap-5">
                <div class="control-group">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3 block">Transform</span>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col flex flex-col gap-1">
                            <div class="flex justify-between items-center">
                                <small class="text-xs text-gray-500">Opacity</small>
                                <span class="text-xs text-gray-400 opacity-value">100%</span>
                            </div>
                            <input type="range" id="prop-opacity" min="0" max="1" step="0.1" 
                                    class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-800"
                                    oninput="Editor.updateProp('opacity', parseFloat(this.value)); this.previousElementSibling.querySelector('.opacity-value').innerText = Math.round(this.value * 100) + '%'">
                        </div>
        
                        <div class="col flex flex-col gap-1">
                            <small class="text-xs text-gray-500">Rotation</small>
                            <div class="relative">
                                <input type="number" id="prop-angle" value="0" 
                                        class="w-full h-8 pl-2 pr-6 text-sm bg-gray-50 border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all"
                                        oninput="Editor.updateProp('angle', parseFloat(this.value))">
                                <span class="absolute right-2 top-1.5 text-xs text-gray-400">Â°</span>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="control-group border-t border-gray-100 pt-4">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3 block">Align & Arrange</span>
                    
                    <div class="grid grid-cols-6 gap-1 mb-3 bg-gray-50 p-1 rounded-lg border border-gray-100">
                        <button class="btn-icon p-1.5 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" title="Align Left" onclick="Editor.align('left')">
                            <i data-lucide="align-horizontal-justify-start" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-icon p-1.5 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" title="Align Center" onclick="Editor.align('center')">
                            <i data-lucide="align-horizontal-justify-center" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-icon p-1.5 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" title="Align Right" onclick="Editor.align('right')">
                            <i data-lucide="align-horizontal-justify-end" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-icon p-1.5 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" title="Align Top" onclick="Editor.align('top')">
                            <i data-lucide="align-vertical-justify-start" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-icon p-1.5 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" title="Align Middle" onclick="Editor.align('middle')">
                            <i data-lucide="align-vertical-justify-center" class="w-4 h-4"></i>
                        </button>
                        <button class="btn-icon p-1.5 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" title="Align Bottom" onclick="Editor.align('bottom')">
                            <i data-lucide="align-vertical-justify-end" class="w-4 h-4"></i>
                        </button>
                    </div>
        
                    <div class="grid grid-cols-2 gap-2">
                        <button class="flex items-center justify-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50 hover:border-gray-300 transition-all" onclick="Editor.moveLayer('up')">
                            <i data-lucide="bring-to-front" class="w-3 h-3"></i> Forward
                        </button>
                        <button class="flex items-center justify-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50 hover:border-gray-300 transition-all" onclick="Editor.moveLayer('down')">
                            <i data-lucide="send-to-back" class="w-3 h-3"></i> Backward
                        </button>
                    </div>
                </div>
        
                <div id="text-controls" style="display:none;" class="flex-col gap-5 border-t border-gray-100 pt-4">
                    
                    <div class="control-group flex flex-col gap-3">
                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Typography</span>
                        
                        <div class="relative">
                            <select id="prop-fontFamily" onchange="Editor.updateProp('fontFamily', this.value)" 
                                    class="w-full h-9 px-3 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none">
                                    <option value="Inter" style="font-family: 'Inter'">Inter</option>
                                    <option value="Roboto" style="font-family: 'Roboto'">Roboto</option>
                                    <option value="Poppins" style="font-family: 'Poppins'">Poppins</option>
                                    <option value="Montserrat" style="font-family: 'Montserrat'">Montserrat</option>
                                    <option value="Lato" style="font-family: 'Lato'">Lato</option>
                                    <option value="Open Sans" style="font-family: 'Open Sans'">Open Sans</option>
                                    <option value="DM Sans" style="font-family: 'DM Sans'">DM Sans</option>
                                    <option value="Space Grotesk" style="font-family: 'Space Grotesk'">Space Grotesk</option>
                                    <option value="Raleway" style="font-family: 'Raleway'">Raleway</option>
                                    <option value="Playfair Display" style="font-family: 'Playfair Display'">Playfair Display</option>
                                    <option value="Merriweather" style="font-family: 'Merriweather'">Merriweather</option>
                                    <option value="Oswald" style="font-family: 'Oswald'">Oswald</option>
                                    <option value="Bebas Neue" style="font-family: 'Bebas Neue'">Bebas Neue</option>
                                    <option value="Archivo Black" style="font-family: 'Archivo Black'">Archivo Black</option>
                                    <option value="Anton" style="font-family: 'Anton'">Anton</option>
                                    <option value="Pacifico" style="font-family: 'Pacifico'">Pacifico</option>
                                    <option value="Dancing Script" style="font-family: 'Dancing Script'">Dancing Script</option>
                                    <option value="Caveat" style="font-family: 'Caveat'">Caveat</option>
                                    <option value="Arial" style="font-family: Arial">Arial</option>
                                    <option value="Courier New" style="font-family: 'Courier New'">Courier New</option>
                                    <option value="Georgia" style="font-family: Georgia">Georgia</option>
                                    <option value="Times New Roman" style="font-family: 'Times New Roman'">Times New Roman</option>
                                    <option value="Verdana" style="font-family: Verdana">Verdana</option>
                                </optgroup>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                        </div>
        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative">
                                <select id="prop-fontWeight" onchange="Editor.updateProp('fontWeight', this.value)" 
                                        class="w-full h-9 px-2 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none">
                                    <option value="300">Light</option>
                                    <option value="400">Regular</option>
                                    <option value="600">Semi Bold</option>
                                    <option value="800">Extra Bold</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
        
                            <div class="flex items-center bg-gray-50 border border-gray-200 rounded-lg overflow-hidden h-9">
                                <button class="px-2 hover:bg-gray-200 text-gray-600 transition-colors" onclick="Editor.adjustFontSize(-2)">
                                    <i data-lucide="minus" class="w-3 h-3"></i>
                                </button>
                                <span id="display-fontSize" class="flex-1 text-center text-sm font-medium text-gray-700 select-none">40</span>
                                <button class="px-2 hover:bg-gray-200 text-gray-600 transition-colors" onclick="Editor.adjustFontSize(2)">
                                    <i data-lucide="plus" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
        
                        <div class="flex justify-between items-center gap-2">
                            <div class="flex gap-1 bg-gray-50 p-1 rounded-lg border border-gray-100 flex-1">
                                <button id="btn-bold" class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center [&.active]:bg-gray-800 [&.active]:text-white [&.active]:shadow-md" onclick="Editor.toggleStyle('bold')">
                                    <i data-lucide="bold" class="w-4 h-4"></i>
                                </button>
                                <button id="btn-italic" class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center [&.active]:bg-gray-800 [&.active]:text-white [&.active]:shadow-md" onclick="Editor.toggleStyle('italic')">
                                    <i data-lucide="italic" class="w-4 h-4"></i>
                                </button>
                                <button id="btn-underline" class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center [&.active]:bg-gray-800 [&.active]:text-white [&.active]:shadow-md" onclick="Editor.toggleStyle('underline')">
                                    <i data-lucide="underline" class="w-4 h-4"></i>
                                </button>
                                <button id="btn-linethrough" class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center [&.active]:bg-gray-800 [&.active]:text-white [&.active]:shadow-md" onclick="Editor.toggleStyle('linethrough')">
                                    <i data-lucide="strikethrough" class="w-4 h-4"></i>
                                </button>
                                <button class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" onclick="Editor.toggleCase()">
                                    <span class="text-xs font-medium">Aa</span>
                                </button>
                            </div>
                        </div>
        
                        <div class="flex items-center gap-3">
                            <div class="flex gap-1 bg-gray-50 p-1 rounded-lg border border-gray-100 flex-1">
                                <button class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" onclick="Editor.updateProp('textAlign', 'left')">
                                    <i data-lucide="align-left" class="w-4 h-4"></i>
                                </button>
                                <button class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" onclick="Editor.updateProp('textAlign', 'center')">
                                    <i data-lucide="align-center" class="w-4 h-4"></i>
                                </button>
                                <button class="flex-1 h-8 rounded hover:bg-white hover:shadow-sm text-gray-600 transition-all flex items-center justify-center" onclick="Editor.updateProp('textAlign', 'right')">
                                    <i data-lucide="align-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="relative w-8 h-8 rounded-lg border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors">
                                <div id="prop-fill-preview" class="absolute inset-1 rounded bg-black pointer-events-none" style="background-color: rgb(0, 0, 0);"></div>
                                <input type="color" id="prop-fill" class="absolute -top-2 -left-2 w-12 h-12 cursor-pointer opacity-0" oninput="Editor.updateProp('fill', this.value); document.getElementById('prop-fill-preview').style.backgroundColor = this.value">
                            </div>
                        </div>
                    </div>
        
                    <div class="control-group flex flex-col gap-3">
                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Spacing & Layout</span>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col flex flex-col gap-1">
                                <div class="flex justify-between items-center">
                                    <small class="text-xs text-gray-500">Char Spacing</small>
                                    <i data-lucide="move-horizontal" class="w-3 h-3 text-gray-400"></i>
                                </div>
                                <input class="w-full h-8 px-2 text-sm bg-gray-50 border border-gray-200 rounded-md focus:border-blue-500 outline-none" 
                                        type="number" id="prop-charSpacing" value="0" step="10" oninput="Editor.updateProp('charSpacing', parseInt(this.value))">
                            </div>
                            <div class="col flex flex-col gap-1">
                                <div class="flex justify-between items-center">
                                    <small class="text-xs text-gray-500">Line Height</small>
                                    <i data-lucide="move-vertical" class="w-3 h-3 text-gray-400"></i>
                                </div>
                                <input class="w-full h-8 px-2 text-sm bg-gray-50 border border-gray-200 rounded-md focus:border-blue-500 outline-none" 
                                        type="number" id="prop-lineHeight" value="1.2" step="0.1" oninput="Editor.updateProp('lineHeight', parseFloat(this.value))">
                            </div>
                        </div>
        
                        <div class="flex flex-col gap-2 p-3 bg-gray-50 rounded-xl border border-gray-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="check-bgColor" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer" onchange="Editor.toggleTextBg(this.checked)">
                                    <label for="check-bgColor" class="text-xs font-medium text-gray-700 cursor-pointer">Background Box</label>
                                </div>
                                <div class="relative w-6 h-6 rounded-full border border-gray-200 overflow-hidden shadow-sm">
                                    <input type="color" id="prop-textBackgroundColor" class="absolute -top-1 -left-1 w-8 h-8 cursor-pointer p-0 border-0" oninput="Editor.updateProp('backgroundColor', this.value)">
                                </div>
                            </div>
                            
                            <div id="bg-advanced-settings" class="mt-2 space-y-2 pl-6">
                                  <div class="flex items-center gap-3">
                                      <i data-lucide="maximize" class="w-3 h-3 text-gray-400"></i>
                                      <input class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-600" 
                                            type="range" id="prop-padding" min="0" max="20" step="1" value="0" oninput="Editor.updateProp('padding', parseInt(this.value))">
                                  </div>
                                  <div class="flex items-center gap-3">
                                      <i data-lucide="circle" class="w-3 h-3 text-gray-400"></i>
                                      <input class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-600" 
                                            type="range" id="prop-bgRadius" min="0" max="60" step="1" value="0" oninput="Editor.updateBgRadius(parseInt(this.value))">
                                  </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between p-2 bg-white border border-gray-200 rounded-lg">
                            <span class="text-xs font-medium text-gray-700">Stroke / Outline</span>
                            <div class="flex items-center gap-2">
                                  <input type="number" id="prop-strokeWidth" placeholder="0" class="w-10 h-7 text-center text-xs border border-gray-200 rounded bg-gray-50 outline-none" min="0" oninput="Editor.updateProp('strokeWidth', parseInt(this.value))">
                                  <div class="relative w-8 h-8 rounded-lg border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors">
                                  <div id="prop-stroke-preview" class="absolute inset-1 rounded bg-black pointer-events-none" style="background-color: rgb(0, 0, 0);"></div>
                                  <input type="color" id="prop-stroke" class="absolute -top-2 -left-2 w-12 h-12 cursor-pointer opacity-0" oninput="Editor.updateProp('stroke', this.value); document.getElementById('prop-stroke-preview').style.backgroundColor = this.value">
                              </div>
                            </div>
                        </div>
        
                        <div class="flex flex-col gap-2 p-3 bg-gray-50 rounded-xl border border-gray-100">
                              <div class="flex items-center justify-between">
                                  <div class="flex items-center gap-2">
                                      <input type="checkbox" id="check-shadow" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer" onchange="Editor.toggleShadow(this.checked)">
                                      <label for="check-shadow" class="text-xs font-medium text-gray-700 cursor-pointer">Drop Shadow</label>
                                  </div>
                                  <div class="relative w-8 h-8 rounded-lg border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors">
                                      <div id="prop-shadow-preview" class="absolute inset-1 rounded bg-black pointer-events-none" style="background-color: rgb(0, 0, 0);"></div>
                                      <input type="color" id="prop-shadowColor" class="absolute -top-2 -left-2 w-12 h-12 cursor-pointer opacity-0" oninput="Editor.updateProp('shadowColor', this.value); document.getElementById('prop-shadow-preview').style.backgroundColor = this.value">
                                  </div>
                              </div>
                              
                              <div id="shadow-inputs" class="space-y-2 mt-1">
                                  <div class="flex items-center gap-2">
                                      <small class="w-8 text-[10px] text-gray-500">Blur</small>
                                      <input type="range" id="prop-shadowBlur" min="0" max="50" value="0" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-500" oninput="Editor.updateShadow()">
                                  </div>
                                  <div class="flex items-center gap-2">
                                      <small class="w-8 text-[10px] text-gray-500">X</small>
                                      <input type="range" id="prop-shadowOfstX" min="-50" max="50" value="0" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-500" oninput="Editor.updateShadow()">
                                  </div>
                                  <div class="flex items-center gap-2">
                                      <small class="w-8 text-[10px] text-gray-500">Y</small>
                                      <input type="range" id="prop-shadowOfstY" min="-50" max="50" value="0" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-500" oninput="Editor.updateShadow()">
                                  </div>
                              </div>
                        </div>
                    </div>
                </div>
        
                <div id="image-controls" style="display:none;" class="flex-col gap-5 border-t border-gray-100 pt-4">
                    <div class="mb-2">
                        <div class="ai-gen-container p-1">
                            <h2 class="text-sm font-medium text-gray-800 mb-3">
                                AI Magic Edit
                            </h2>
                    
                            <div class="border border-gray-300 rounded-xl p-3 mb-4 focus-within:border-gray-400 transition-colors bg-white">
                                <textarea id="ai-edit-prompt" rows="3" placeholder="Describe changes (e.g., 'Add sunglasses')..." 
                                    class="w-full text-sm text-gray-700 placeholder-gray-400 focus:outline-none resize-none bg-transparent"></textarea>
                            </div>
                    
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                        <i data-lucide="palette" class="w-4 h-4 text-gray-600"></i>
                                    </div>
                                    <select id="ai-edit-style" class="w-full appearance-none border border-gray-300 rounded-xl py-2.5 pl-9 pr-4 text-sm font-medium text-gray-700 focus:outline-none hover:bg-gray-50 cursor-pointer transition-all bg-white">
                                        <option value="None">Natural</option>
                                        <option value="Cinematic">Cinematic</option>
                                        <option value="Anime">Anime</option>
                                        <option value="Cyberpunk">Cyberpunk</option>
                                    </select>
                                </div>
                    
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                        <i data-lucide="brain" class="w-4 h-4 text-gray-600"></i>
                                    </div>
                                    <select id="ai-edit-model" class="w-full appearance-none border border-gray-300 rounded-xl py-2.5 pl-9 pr-4 text-sm font-medium text-gray-700 focus:outline-none hover:bg-gray-50 cursor-pointer transition-all bg-white">
                                        <option value="gemini-2.5-flash-image">Gemini 2.5</option>
                                        <option value="gemini-3-pro-image-preview">Gemini 3 Pro</option>
                                    </select>
                                </div>
                            </div>
                    
                            <button id="btn-edit-generate" class="w-full bg-gray-900 hover:bg-black text-white py-2 rounded-full flex items-center justify-center gap-2 transition-transform active:scale-95" onclick="Editor.editImageWithAI()">
                                <span>Generate Edit</span>
                            </button>
                        </div>
                    </div>
                    <h2 class="text-sm font-medium text-gray-800 mb-3">
                        Image Effects
                    </h2>
                    <div class="flex flex-col gap-2 border border-gray-200 py-4 px-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-700 font-medium">Corner Radius</span>
                            <input type="checkbox" id="check-img-rounding" class="w-4 h-4 text-blue-600 rounded cursor-pointer" onchange="Editor.toggleImageRounding(this.checked)">
                        </div>
                        <div id="img-radius-slider" class="flex items-center gap-3 transition-opacity duration-200">
                            <i data-lucide="square" class="w-3 h-3 text-gray-400"></i>
                            <input class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" type="range" id="prop-imgRadius" min="0" max="100" step="1" value="0" oninput="Editor.updateImageRadius(parseInt(this.value))">
                            <i data-lucide="circle" class="w-3 h-3 text-gray-400"></i>
                        </div>
                    </div>
        
                    <div class="space-y-3 mt-2">
                        <button id="btn-sidebar-remove-bg" class="w-full flex items-center justify-center gap-2 py-2 bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 hover:text-blue-600 transition-all shadow-sm group" onclick="Editor.toggleBackgroundRemoval()">
                          <span class="icon-container"><i data-lucide="eraser" class="w-4 h-4 group-hover:scale-110 transition-transform"></i></span>
                            <span id="txt-sidebar-bg">Remove Background</span>
                        </button>
                        
                        
                    </div>
                </div>
        
                <div class="border-t border-gray-100 pt-4 mt-auto">
                    <button class="w-full flex items-center justify-center gap-2 py-2.5 text-gray-600 bg-gray-50 border border-gray-100 rounded-lg hover:bg-gray-100 hover:border-gray-200 transition-all text-sm font-medium" onclick="Editor.deleteSelected()">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Selected Layer
                    </button>
                </div>
        
            </div>
        </div>
            
        <div id="view-background" class="sidebar-view active">
            <div class="flex-1 overflow-y-auto custom-scrollbar px-5 pb-10 space-y-6">
        
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Colors</h4>
                    <div class="grid grid-cols-6 gap-3">

                        <button onclick="Editor.setBgColor('#ffffff')" class="w-10 h-10 rounded-full border border-gray-200 bg-white hover:scale-110 transition-transform focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-400 shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#000000')" class="w-10 h-10 rounded-full border border-gray-200 bg-black hover:scale-110 transition-transform focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-800"></button>
                        <button onclick="Editor.setBgColor('#ef4444')" class="w-10 h-10 rounded-full border border-transparent bg-red-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#f43f5e')" class="w-10 h-10 rounded-full border border-transparent bg-rose-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#f97316')" class="w-10 h-10 rounded-full border border-transparent bg-orange-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#f59e0b')" class="w-10 h-10 rounded-full border border-transparent bg-amber-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#eab308')" class="w-10 h-10 rounded-full border border-transparent bg-yellow-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#84cc16')" class="w-10 h-10 rounded-full border border-transparent bg-lime-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#22c55e')" class="w-10 h-10 rounded-full border border-transparent bg-green-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#10b981')" class="w-10 h-10 rounded-full border border-transparent bg-emerald-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#14b8a6')" class="w-10 h-10 rounded-full border border-transparent bg-teal-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#06b6d4')" class="w-10 h-10 rounded-full border border-transparent bg-cyan-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#0ea5e9')" class="w-10 h-10 rounded-full border border-transparent bg-sky-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#3b82f6')" class="w-10 h-10 rounded-full border border-transparent bg-blue-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#6366f1')" class="w-10 h-10 rounded-full border border-transparent bg-indigo-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#8b5cf6')" class="w-10 h-10 rounded-full border border-transparent bg-violet-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#a855f7')" class="w-10 h-10 rounded-full border border-transparent bg-purple-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#d946ef')" class="w-10 h-10 rounded-full border border-transparent bg-fuchsia-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#ec4899')" class="w-10 h-10 rounded-full border border-transparent bg-pink-500 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#991b1b')" class="w-10 h-10 rounded-full border border-transparent bg-red-800 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#92400e')" class="w-10 h-10 rounded-full border border-transparent bg-amber-800 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#166534')" class="w-10 h-10 rounded-full border border-transparent bg-green-800 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#115e59')" class="w-10 h-10 rounded-full border border-transparent bg-teal-800 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#1e40af')" class="w-10 h-10 rounded-full border border-transparent bg-blue-800 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#5b21b6')" class="w-10 h-10 rounded-full border border-transparent bg-violet-800 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#86198f')" class="w-10 h-10 rounded-full border border-transparent bg-fuchsia-800 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#fee2e2')" class="w-10 h-10 rounded-full border border-transparent bg-red-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#ffedd5')" class="w-10 h-10 rounded-full border border-transparent bg-orange-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#fef9c3')" class="w-10 h-10 rounded-full border border-transparent bg-yellow-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#dcfce7')" class="w-10 h-10 rounded-full border border-transparent bg-green-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#ccfbf1')" class="w-10 h-10 rounded-full border border-transparent bg-teal-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#dbeafe')" class="w-10 h-10 rounded-full border border-transparent bg-blue-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#f3e8ff')" class="w-10 h-10 rounded-full border border-transparent bg-purple-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#fce7f3')" class="w-10 h-10 rounded-full border border-transparent bg-pink-100 hover:scale-110 transition-transform"></button>
                        <button onclick="Editor.setBgColor('#ffffff')" class="w-10 h-10 rounded-full border border-gray-200 bg-white hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#f3f4f6')" class="w-10 h-10 rounded-full border border-gray-200 bg-gray-100 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#9ca3af')" class="w-10 h-10 rounded-full border border-transparent bg-gray-400 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#4b5563')" class="w-10 h-10 rounded-full border border-transparent bg-gray-600 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#1f2937')" class="w-10 h-10 rounded-full border border-transparent bg-gray-800 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="Editor.setBgColor('#000000')" class="w-10 h-10 rounded-full border border-gray-700 bg-black hover:scale-110 transition-transform shadow-sm"></button>
                                
                        <label class="w-10 h-10 rounded-full border border-gray-200 bg-white flex items-center justify-center cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition-all text-gray-500 shadow-sm">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <input type="color" class="opacity-0 absolute w-0 h-0" oninput="Editor.setBgColor(this.value)">
                        </label>
                    </div>
                </div>
        
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Gradients</h4>
                    <div class="grid grid-cols-4 gap-3">
                        <button onclick="Editor.setGradient('#f6d365', '#fda085')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);"></button>
                        <button onclick="Editor.setGradient('#ff9a9e', '#fecfef')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);"></button>
                        
                        <button onclick="Editor.setGradient('#84fab0', '#8fd3f4')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);"></button>
                        <button onclick="Editor.setGradient('#a1c4fd', '#c2e9fb')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);"></button>
                        
                        <button onclick="Editor.setGradient('#a18cd1', '#fbc2eb')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);"></button>
                        <button onclick="Editor.setGradient('#667eea', '#764ba2')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></button>
                        
                        <button onclick="Editor.setGradient('#30cfd0', '#330867')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);"></button>
                        <button onclick="Editor.setGradient('#434343', '#000000')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #434343 0%, #000000 100%);"></button>  
                        <button onclick="Editor.setGradient('#11998e', '#38ef7d')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);"></button>

                        <button onclick="Editor.setGradient('#051937', '#008793')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #051937 0%, #008793 100%);"></button>

                        <button onclick="Editor.setGradient('#ee9ca7', '#ffdde1')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #ee9ca7 0%, #ffdde1 100%);"></button>

                        <button onclick="Editor.setGradient('#8E2DE2', '#4A00E0')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%);"></button>

                        <button onclick="Editor.setGradient('#eecda3', '#ef629f')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #eecda3 0%, #ef629f 100%);"></button>

                        <button onclick="Editor.setGradient('#bdc3c7', '#2c3e50')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);"></button>

                        <button onclick="Editor.setGradient('#00b09b', '#96c93d')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);"></button>

                        <button onclick="Editor.setGradient('#f12711', '#f5af19')" class="aspect-square rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-1" style="background: linear-gradient(135deg, #f12711 0%, #f5af19 100%);"></button>
                      </div>
                </div>
        
                <!-- Textures Section -->
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Textures</h4>
                    
                    <!-- Texture Categories Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        
                        <!-- Wood Textures Category -->
                        <div class="texture-category cursor-pointer" onclick="UI.toggleTextureCategory('wood')">
                            <div class="bg-white rounded-xl border border-gray-200 hover:border-gray-300 hover:shadow-md transition-all overflow-hidden">
                                <div class="p-2">
                                    <div class="grid grid-cols-3 gap-1 mb-2">
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1583418007992-a8e33a92e7ad?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Wood">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1611600700192-d87eaeed4f81?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Wood">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1561458338-60c444223320?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Wood">
                                        </div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">Wood</span>
                                </div>
                            </div>
                        </div>

                        <!-- Marble Textures Category -->
                        <div class="texture-category cursor-pointer" onclick="UI.toggleTextureCategory('marble')">
                            <div class="bg-white rounded-xl border border-gray-200 hover:border-gray-300 hover:shadow-md transition-all overflow-hidden">
                                <div class="p-2">
                                    <div class="grid grid-cols-3 gap-1 mb-2">
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1550053808-52a75a05955d?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Marble">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1669643219984-2ff3eea887a0?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Marble">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1697497597551-54efaa0ebaa7?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Marble">
                                        </div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">Marble</span>
                                </div>
                            </div>
                        </div>

                        <!-- Concrete Textures Category -->
                        <div class="texture-category cursor-pointer" onclick="UI.toggleTextureCategory('concrete')">
                            <div class="bg-white rounded-xl border border-gray-200 hover:border-gray-300 hover:shadow-md transition-all overflow-hidden">
                                <div class="p-2">
                                    <div class="grid grid-cols-3 gap-1 mb-2">
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1521459467264-802e2ef3141f?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Concrete">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1721515765477-4b622d2805b1?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Concrete">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1732657617698-4a7f7c11762e?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Concrete">
                                        </div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">Concrete</span>
                                </div>
                            </div>
                        </div>

                        <!-- Flatlays Textures Category -->
                        <div class="texture-category cursor-pointer" onclick="UI.toggleTextureCategory('flatlays')">
                            <div class="bg-white rounded-xl border border-gray-200 hover:border-gray-300 hover:shadow-md transition-all overflow-hidden">
                                <div class="p-2">
                                    <div class="grid grid-cols-3 gap-1 mb-2">
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1610344248984-140b230eff55?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Flatlay">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1610344249553-981eab366437?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Flatlay">
                                        </div>
                                        <div class="aspect-square rounded-md overflow-hidden">
                                            <img src="https://images.unsplash.com/photo-1591925323320-f2246a3cfd36?crop=entropy&cs=srgb&fm=jpg&w=100" class="w-full h-full object-cover" alt="Flatlay">
                                        </div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">Flatlays</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="texture-panel-wood" class="texture-panel hidden mt-4 p-3 bg-white rounded-xl border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-800">Wood Textures</span>
                            <button onclick="UI.closeTexturePanel()" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-4 h-4 text-gray-500"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1583418007992-a8e33a92e7ad?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1583418007992-a8e33a92e7ad?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Pandav Tank">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1611600700192-d87eaeed4f81?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1611600700192-d87eaeed4f81?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by jean wimmerlin">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1561458338-60c444223320?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1561458338-60c444223320?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Ashkan Forouzani">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1544840280-80e54213dfdc?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1544840280-80e54213dfdc?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Annie Spratt">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1533035350251-aa8b8e208d95?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1533035350251-aa8b8e208d95?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Lazarescu Alexandra">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1620304387730-a9e639c44e8a?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1620304387730-a9e639c44e8a?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Dan Norris">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1702366370613-7df78b10a480?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1702366370613-7df78b10a480?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Dan Norris">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1701613351258-fcafde3dc0bd?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1701613351258-fcafde3dc0bd?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Bussey Media">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1658224794185-66e71fe83af9?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1658224794185-66e71fe83af9?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Wood by Martin Martz">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                        </div>
                    </div>

                    <!-- Marble Textures Expanded -->
                    <div id="texture-panel-marble" class="texture-panel hidden mt-4 p-3 bg-white rounded-xl border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-800">Marble Textures</span>
                            <button onclick="UI.closeTexturePanel()" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-4 h-4 text-gray-500"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1550053808-52a75a05955d?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1550053808-52a75a05955d?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Annie Spratt">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1669643219984-2ff3eea887a0?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1669643219984-2ff3eea887a0?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Denley Photography">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1697497597551-54efaa0ebaa7?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1697497597551-54efaa0ebaa7?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Juliette PÃ¡ez Tobar">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1566041510394-cf7c8fe21800?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1566041510394-cf7c8fe21800?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Augustine Wong">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1642419105752-88cc5a001a85?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1642419105752-88cc5a001a85?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Elizaveta Ivanova">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1566305977571-5666677c6e98?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1566305977571-5666677c6e98?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Scott Webb">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1656147173067-2022b4ab3cc6?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1656147173067-2022b4ab3cc6?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Zeeshan Alam">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1640280882429-204f63d777e7?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1640280882429-204f63d777e7?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Brandon Stecz">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1668533677422-1e759410847f?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1668533677422-1e759410847f?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Marble by Veronika Galkina">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                        </div>
                    </div>

                    <!-- Concrete Textures Expanded -->
                    <div id="texture-panel-concrete" class="texture-panel hidden mt-4 p-3 bg-white rounded-xl border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-800">Concrete Textures</span>
                            <button onclick="UI.closeTexturePanel()" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-4 h-4 text-gray-500"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1521459467264-802e2ef3141f?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1521459467264-802e2ef3141f?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by Yan Ots">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1721515765477-4b622d2805b1?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1721515765477-4b622d2805b1?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by Syirwan Ainu">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1732657617698-4a7f7c11762e?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1732657617698-4a7f7c11762e?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by Jan KopÅiva">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1618579830810-e89b6d35ff56?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1618579830810-e89b6d35ff56?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by Martin van Maaren">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1641229195272-becea8d4fd8d?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1641229195272-becea8d4fd8d?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by Amanda Forrest">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1617967397910-f52bebe67e72?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1617967397910-f52bebe67e72?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by Jarrod Erbe">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1659604355058-99c799dd1c70?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1659604355058-99c799dd1c70?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by Maria Favorskaya">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1613061068910-3c3a85ece2d2?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1613061068910-3c3a85ece2d2?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by ÐÐ»ÐµÐ³ ÐÐ¾ÑÐ¾Ð·">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1644690627229-15d952217736?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1644690627229-15d952217736?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Concrete by JKalina">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                        </div>
                    </div>

                    <!-- Flatlays Textures Expanded -->
                    <div id="texture-panel-flatlays" class="texture-panel hidden mt-4 p-3 bg-white rounded-xl border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-800">Flatlay Textures</span>
                            <button onclick="UI.closeTexturePanel()" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
                                <i data-lucide="x" class="w-4 h-4 text-gray-500"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1610344248984-140b230eff55?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1610344248984-140b230eff55?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Flatlay by YearOne">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1610344249553-981eab366437?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1610344249553-981eab366437?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Flatlay by YearOne">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1591925323320-f2246a3cfd36?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1591925323320-f2246a3cfd36?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Flatlay by Joyce Hankins">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1657935937312-1ad849214aea?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1657935937312-1ad849214aea?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Flatlay by Lesli Whitecotton">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1739659153856-ae22a5d2390a?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1739659153856-ae22a5d2390a?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Flatlay by G. DOCHEV">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                            <button onclick="Editor.setTexture('https://images.unsplash.com/photo-1755546368173-f639fd0a5da0?crop=entropy&cs=srgb&fm=jpg&q=10')" 
                                    class="relative aspect-square rounded-lg overflow-hidden group">
                                <img src="https://images.unsplash.com/photo-1755546368173-f639fd0a5da0?crop=entropy&cs=srgb&fm=jpg&w=200" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" alt="Flatlay by The New York Public Library">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
          <div id="view-layers" class="sidebar-view">
            <div class="p-4">
                <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3">Canvas Layers</h3>
                <div id="layers-list" class="space-y-2"></div>
                <div id="layers-empty" class="hidden flex flex-col items-center justify-center py-12 text-center">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                        <i data-lucide="layers" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <p class="text-sm font-medium text-gray-600 mb-1">No layers yet</p>
                    <p class="text-xs text-gray-400 max-w-[200px]">Add images, text, or shapes to see them appear here</p>
                </div>
            </div>
          </div>
    
        <div id="view-media" class="sidebar-view p-3 h-full overflow-y-auto space-y-5">

          <div class="ai-gen-container p-3 border border-gray-200 rounded-2xl shadow-sm">
              <h2 class="text-sm font-semibold text-gray-800 mb-2">
                  AI Image Generator
              </h2>

              <div class="border border-gray-300 rounded-xl p-2 mb-3 focus-within:border-gray-400 transition-colors">
                  <textarea id="ai-prompt" rows="2"
                      placeholder="Describe what you'd like to create (5+ words)..."
                      class="w-full text-xs text-gray-700 placeholder-gray-400 focus:outline-none resize-none bg-transparent"></textarea>
              </div>

              <div class="grid grid-cols-2 gap-2 mb-3">
                  <div class="relative">
                      <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                          <i data-lucide="image" class="w-4 h-4 text-gray-500"></i>
                      </div>
                      <select id="ai-style"
                          class="w-full appearance-none border border-gray-300 rounded-xl py-2 pl-9 pr-3 text-xs text-gray-700 focus:outline-none">
                          <option value="None">Style</option>
                          <option value="Cinematic">Cinematic</option>
                          <option value="Anime">Anime</option>
                          <option value="Pixel Art">Pixel Art</option>
                          <option value="Cyberpunk">Cyberpunk</option>
                          <option value="Watercolor">Watercolor</option>
                      </select>
                  </div>

                  <div class="relative">
                      <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                          <i data-lucide="brain" class="w-4 h-4 text-gray-500"></i>
                      </div>
                      <select id="ai-model"
                          class="w-full appearance-none border border-gray-300 rounded-xl py-2 pl-9 pr-3 text-xs text-gray-700 focus:outline-none">
                          <option value="gemini-3-pro-image-preview">Gemini 3 Pro</option>
                          <option value="gemini-2.5-flash-image">Gemini 2.5</option>
                      </select>
                  </div>
              </div>

              <button id="btn-generate"
                  class="w-full bg-gray-900 hover:bg-black text-white text-sm font-medium py-2.5 rounded-full flex items-center justify-center gap-2 active:scale-95 transition"
                  onclick="Editor.generateAIImage()">
                  Generate Image
              </button>
          </div>

          <input type="file" id="mediaInput" accept="image/*,video/mp4" multiple class="hidden">

          <div onclick="document.getElementById('mediaInput').click()"
              class="flex items-center gap-3 px-4 py-3 border border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-gray-100 cursor-pointer transition">
              <i data-lucide="cloud-upload" class="w-5 h-5 text-gray-500"></i>
              <div class="text-sm text-gray-600">
                  Upload images or videos
              </div>
          </div>

          <div>
            <div class="flex justify-between items-center mb-3">
              <div class="text-gray-800 font-medium text-sm">Media Library</div>
            </div>

            <!-- changed to 4 columns -->
            <div class="grid grid-cols-4 gap-2 mb-4">
              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?w=500', 'stock1')">
              </div>


              <!-- New portrait thumbnails (added in same format) -->
              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1462396881884-de2c07cb95ed?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwxfHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1462396881884-de2c07cb95ed?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwxfHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock4')"
                  title="By: Roberto Nickson">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1593280405106-e438ebe93f5b?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwyfHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1593280405106-e438ebe93f5b?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwyfHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock5')"
                  title="By: m">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1610213728302-9528164e663e?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwzfHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1610213728302-9528164e663e?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwzfHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock6')"
                  title="By: Tyler Clemmensen">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1506883968894-6e7738ccfc05?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw0fHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1506883968894-6e7738ccfc05?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw0fHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock7')"
                  title="By: MeriÃ§ DaÄlÄ±">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1530861579116-b19f2dbf0ca3?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw1fHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1530861579116-b19f2dbf0ca3?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw1fHxjYXJzfGVufDB8Mnx8fDE3Njg2NDgxMjh8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock8')"
                  title="By: Deva Darshan">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1580383857470-d5eff2e6b845?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwxfHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1580383857470-d5eff2e6b845?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwxfHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock9')"
                  title="By: Andreea V">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1596854273338-cbf078ec7071?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwyfHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1596854273338-cbf078ec7071?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwyfHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock10')"
                  title="By: Kabo">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwzfHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHwzfHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock11')"
                  title="By: Kabo">
              </div>

            
              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1641209624342-e20d49275892?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1641209624342-e20d49275892?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=500', 'stock14')"
                  title="By: alvito danendra">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1682562614304-980ac3094b9a?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1682562614304-980ac3094b9a?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=500', 'stock15')"
                  title="By: Tianhao Wang">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1621965767797-98830010949d?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1621965767797-98830010949d?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=500', 'stock16')"
                  title="By: Mikhail Tyrsyna">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1621965734835-b8f30d8a3ba9?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1621965734835-b8f30d8a3ba9?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=500', 'stock17')"
                  title="By: Mikhail Tyrsyna">
              </div>


              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1685783230296-f2bca1ca6cfc?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1685783230296-f2bca1ca6cfc?crop=entropy&cs=srgb&fm=jpg&ixlib=rb-4.1.0&q=85&w=500', 'stock18')"
                  title="By: Divaris Shirichena">
              </div>


              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1570824104629-1817c91f7d1d?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw0fHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1570824104629-1817c91f7d1d?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw0fHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock12')"
                  title="By: The Lucky Neko">
              </div>

              <div class="media-thumb aspect-square bg-cover bg-center rounded-lg cursor-pointer hover:opacity-80 transition border border-gray-100 shadow-sm"
                  style="background-image:url('https://images.unsplash.com/photo-1574158622682-e40e69881006?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw1fHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=100');"
                  onclick="Editor.addImage('https://images.unsplash.com/photo-1574158622682-e40e69881006?crop=entropy&cs=srgb&fm=jpg&ixid=M3w4NTU3NjR8MHwxfHNlYXJjaHw1fHxjYXRzfGVufDB8Mnx8fDE3Njg2NDgxNzN8MA&ixlib=rb-4.1.0&q=85&w=500', 'stock13')"
                  title="By: CÃ©dric VT">
              </div>
            </div>

            <!-- <div class="relative">
              <input type="text" placeholder="Search Stock Photos..."
                    class="w-full bg-gray-50 border border-gray-200 rounded-lg py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-gray-900">
              <div class="absolute left-3 top-2.5 text-gray-400">
                <i data-lucide="search" class="w-4 h-4"></i>
              </div>
            </div> -->
          </div>

        </div>

    
        <div id="view-text" class="sidebar-view">
          <div class="p-4 space-y-6">
            <section>
              <h3 class="text-sm font-medium text-gray-800 mb-4">Add Text to Canvas</h3>
              <button onclick="Editor.addText()" 
                class="w-full flex items-center justify-center gap-2 py-3 bg-gray-900 hover:bg-black text-white text-sm font-medium rounded-xl transition-all active:scale-95">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Add Text
              </button>
            </section>
            
            <section>
              <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3">Text Presets</h3>
              <div class="space-y-2">
                <button onclick="Editor.addText('Add a heading', 48, 700)" 
                  class="w-full text-left p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-all">
                  <span class="text-xl font-bold text-gray-800">Add a heading</span>
                </button>
                <button onclick="Editor.addText('Add a subheading', 28, 600)" 
                  class="w-full text-left p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-all">
                  <span class="text-base font-semibold text-gray-700">Add a subheading</span>
                </button>
                <button onclick="Editor.addText('Add body text', 16, 400)" 
                  class="w-full text-left p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-all">
                  <span class="text-sm font-normal text-gray-600">Add body text</span>
                </button>
              </div>
            </section>
          </div>
        </div>

        <div id="view-resize" class="sidebar-view">
  <div class="bg-section-title text-xs font-medium text-gray-900 uppercase tracking-wider mb-2 px-3">Instagram</div>
  <div class="resize-list space-y-1 mb-6">
    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('ig_tall')" data-format="ig_tall">
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="14" height="18" x="5" y="3" rx="2" stroke-width="2"/></svg>
        <span class="text-sm font-medium">Instagram Tall (3:4)</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1080 x 1440</span>
    </div>

    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('ig_portrait')" data-format="ig_portrait">
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="12" height="16" x="6" y="4" rx="2" stroke-width="2"/></svg>
        <span class="text-sm font-medium">Instagram Portrait</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1080 x 1350</span>
    </div>

    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('ig_square')" data-format="ig_square">
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="16" height="16" x="4" y="4" rx="2" stroke-width="2"/></svg>
        <span class="text-sm font-medium">Instagram Square</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1080 x 1080</span>
    </div>

    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('ig_story')" data-format="ig_story">
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="10" height="18" x="7" y="3" rx="2" stroke-width="2"/></svg>
        <span class="text-sm font-medium">Instagram Story</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1080 x 1920</span>
    </div>
  </div>

  <div class="bg-section-title text-xs font-medium text-gray-900 uppercase tracking-wider mb-2 px-3">Video Platforms</div>
  <div class="resize-list space-y-1 mb-6">
    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('tiktok')" data-format="tiktok">
      <div class="flex items-center gap-3">
         <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 461 512.235"><g fill-rule="nonzero"><path fill="#2DCCD3" d="M370.934 98.964c19.378 19.981 43.543 32.158 67.898 37.7v-15.005c-22.884-1.621-46.823-8.822-67.898-22.695zM230.952 0v335.533c0 43.959-31.593 72.234-70.009 72.234-12.743 0-24.844-2.978-35.363-8.483 13.346 17.041 34.421 26.843 57.531 26.843 38.417 0 70.01-28.275 70.01-72.272V18.322h60.886C312.348 12.479 310.99 6.371 309.934 0h-78.982zM181 195.062v-16.627c-7.691-1.281-15.382-1.696-21.753-1.696C72.573 176.739 0 246.296 0 332.555c0 56.626 27.559 105.033 69.444 133.685-29.18-28.953-47.276-69.481-47.276-115.362 0-86.109 72.347-155.628 158.832-155.816z"/><path fill="#F1204A" d="M318.87 329.991c0 107.144-81.96 163.921-159.209 163.921-33.44 0-64.505-10.103-90.217-27.672 28.879 28.652 68.616 45.995 112.385 45.995 77.248 0 159.208-56.777 159.208-163.921V173.723c-7.69-5.203-15.08-11.272-22.167-18.36v174.628zm-193.289 69.294c-9.426-11.914-15.043-27.334-15.043-45.43 0-50.782 39.698-77.624 92.629-72.045v-85.052c-7.69-1.282-15.381-1.697-21.79-1.697H181v68.389c-52.931-5.542-92.63 21.263-92.63 72.083 0 29.707 15.193 52.252 37.211 63.752zm313.251-262.621v63.525c-35.174 0-68.464-6.711-97.795-26.466 34.157 34.157 75.59 44.826 119.963 44.826v-78.567a137.713 137.713 0 01-22.168-3.318zm-67.898-37.701c-18.737-19.265-33.026-45.806-38.832-80.641h-18.095c10.329 37.663 31.592 63.94 56.927 80.641z"/><path d="M159.661 493.912c77.248 0 159.209-56.777 159.209-163.921V155.364c7.088 7.087 14.477 13.157 22.168 18.359 29.33 19.755 62.62 26.466 97.794 26.466v-63.525c-24.354-5.542-48.52-17.72-67.898-37.7-25.335-16.702-46.597-42.979-56.928-80.641H253.12v335.533c0 43.996-31.593 72.271-70.009 72.271-23.111 0-44.185-9.801-57.531-26.842-22.017-11.499-37.21-34.044-37.21-63.751 0-50.821 39.698-77.626 92.63-72.084v-68.388c-86.485.189-158.832 69.708-158.832 155.815 0 45.882 18.096 86.409 47.277 115.363 25.711 17.569 56.776 27.672 90.216 27.672z"/></g></svg>
        <span class="text-sm font-medium">TikTok Post</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1080 x 1920</span>
    </div>

    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('youtube')" data-format="youtube">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5"  viewBox="0 0 333333 333333" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd"><path d="M329930 100020s-3254-22976-13269-33065c-12691-13269-26901-13354-33397-14124-46609-3396-116614-3396-116614-3396h-122s-69973 0-116608 3396c-6522 793-20712 848-33397 14124C6501 77044 3316 100020 3316 100020S-1 126982-1 154001v25265c0 26962 3315 53979 3315 53979s3254 22976 13207 33082c12685 13269 29356 12838 36798 14254 26685 2547 113354 3315 113354 3315s70065-124 116675-3457c6522-770 20706-848 33397-14124 10021-10089 13269-33090 13269-33090s3319-26962 3319-53979v-25263c-67-26962-3384-53979-3384-53979l-18 18-2-2zM132123 209917v-93681l90046 46997-90046 46684z" fill="red"/></svg>
        <span class="text-sm font-medium">YouTube Video</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1920 x 1080</span>
    </div>
  </div>

  <div class="bg-section-title text-xs font-medium text-gray-900 uppercase tracking-wider mb-2 px-3">Other Platforms</div>
  <div class="resize-list space-y-1 mb-6">
    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('facebook')" data-format="facebook">
      <div class="flex items-center gap-3">
         <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 509 509"><g fill-rule="nonzero"><path fill="#0866FF" d="M509 254.5C509 113.94 395.06 0 254.5 0S0 113.94 0 254.5C0 373.86 82.17 474 193.02 501.51V332.27h-52.48V254.5h52.48v-33.51c0-86.63 39.2-126.78 124.24-126.78 16.13 0 43.95 3.17 55.33 6.33v70.5c-6.01-.63-16.44-.95-29.4-.95-41.73 0-57.86 15.81-57.86 56.91v27.5h83.13l-14.28 77.77h-68.85v174.87C411.35 491.92 509 384.62 509 254.5z"/><path fill="#fff" d="M354.18 332.27l14.28-77.77h-83.13V227c0-41.1 16.13-56.91 57.86-56.91 12.96 0 23.39.32 29.4.95v-70.5c-11.38-3.16-39.2-6.33-55.33-6.33-85.04 0-124.24 40.16-124.24 126.78v33.51h-52.48v77.77h52.48v169.24c19.69 4.88 40.28 7.49 61.48 7.49 10.44 0 20.72-.64 30.83-1.86V332.27h68.85z"/></g></svg>
        <span class="text-sm font-medium">Facebook Post</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1200 x 630</span>
    </div>

    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('linkedin')" data-format="linkedin">
      <div class="flex items-center gap-3">
        <svg class="w-5 h-5" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 122.31"><defs><style>.cls-1{fill:#0a66c2;}.cls-1,.cls-2{fill-rule:evenodd;}.cls-2{fill:#fff;}</style></defs><title>linkedin-app</title><path class="cls-1" d="M27.75,0H95.13a27.83,27.83,0,0,1,27.75,27.75V94.57a27.83,27.83,0,0,1-27.75,27.74H27.75A27.83,27.83,0,0,1,0,94.57V27.75A27.83,27.83,0,0,1,27.75,0Z"/><path class="cls-2" d="M49.19,47.41H64.72v8h.22c2.17-3.88,7.45-8,15.34-8,16.39,0,19.42,10.2,19.42,23.47V98.94H83.51V74c0-5.71-.12-13.06-8.42-13.06s-9.72,6.21-9.72,12.65v25.4H49.19V47.41ZM40,31.79a8.42,8.42,0,1,1-8.42-8.42A8.43,8.43,0,0,1,40,31.79ZM23.18,47.41H40V98.94H23.18V47.41Z"/></svg>
        <span class="text-sm font-medium">LinkedIn Post</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1200 x 627</span>
    </div>

    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('x')" data-format="x">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 509.64"><rect width="512" height="509.64" rx="115.61" ry="115.61"/><path fill="#fff" fill-rule="nonzero" d="M323.74 148.35h36.12l-78.91 90.2 92.83 122.73h-72.69l-56.93-74.43-65.15 74.43h-36.14l84.4-96.47-89.05-116.46h74.53l51.46 68.04 59.53-68.04zm-12.68 191.31h20.02l-129.2-170.82H180.4l130.66 170.82z"/></svg>
        <span class="text-sm font-medium">X (Twitter) Post</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1200 x 675</span>
    </div>

    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" 
         onclick="Editor.resizeCanvas('threads')" data-format="threads">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 512"><path d="M105 0h302c57.75 0 105 47.25 105 105v302c0 57.75-47.25 105-105 105H105C47.25 512 0 464.75 0 407V105C0 47.25 47.25 0 105 0z"/><path fill="#fff" fill-rule="nonzero" d="M337.36 243.58c-1.46-.7-2.95-1.38-4.46-2.02-2.62-48.36-29.04-76.05-73.41-76.33-25.6-.17-48.52 10.27-62.8 31.94l24.4 16.74c10.15-15.4 26.08-18.68 37.81-18.68h.4c14.61.09 25.64 4.34 32.77 12.62 5.19 6.04 8.67 14.37 10.39 24.89-12.96-2.2-26.96-2.88-41.94-2.02-42.18 2.43-69.3 27.03-67.48 61.21.92 17.35 9.56 32.26 24.32 42.01 12.48 8.24 28.56 12.27 45.26 11.35 22.07-1.2 39.37-9.62 51.45-25.01 9.17-11.69 14.97-26.84 17.53-45.92 10.51 6.34 18.3 14.69 22.61 24.73 7.31 17.06 7.74 45.1-15.14 67.96-20.04 20.03-44.14 28.69-80.55 28.96-40.4-.3-70.95-13.26-90.81-38.51-18.6-23.64-28.21-57.79-28.57-101.5.36-43.71 9.97-77.86 28.57-101.5 19.86-25.25 50.41-38.21 90.81-38.51 40.68.3 71.76 13.32 92.39 38.69 10.11 12.44 17.73 28.09 22.76 46.33l28.59-7.63c-6.09-22.45-15.67-41.8-28.72-57.85-26.44-32.53-65.1-49.19-114.92-49.54h-.2c-49.72.35-87.96 17.08-113.64 49.73-22.86 29.05-34.65 69.48-35.04 120.16v.24c.39 50.68 12.18 91.11 35.04 120.16 25.68 32.65 63.92 49.39 113.64 49.73h.2c44.2-.31 75.36-11.88 101.03-37.53 33.58-33.55 32.57-75.6 21.5-101.42-7.94-18.51-23.08-33.55-43.79-43.48zm-76.32 71.76c-18.48 1.04-37.69-7.26-38.64-25.03-.7-13.18 9.38-27.89 39.78-29.64 3.48-.2 6.9-.3 10.25-.3 11.04 0 21.37 1.07 30.76 3.13-3.5 43.74-24.04 50.84-42.15 51.84z"/></svg>
        <span class="text-sm font-medium">Threads</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1080 x 1080</span>
    </div>
    <div class="resize-item group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-100" onclick="Editor.resizeCanvas('snapchat')" data-format="snapchat">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 512"><rect fill="#FFFC00" width="512" height="512" rx="105" ry="105"/><g fill-rule="nonzero"><path fill="#fff" d="M424.16 341.5c-1.47-4.87-8.51-8.3-8.51-8.3v.01c-.65-.37-1.25-.67-1.76-.92-11.72-5.67-22.1-12.47-30.86-20.22-7.03-6.22-13.05-13.07-17.89-20.37-5.9-8.89-8.67-16.32-9.87-20.34-.66-2.62-.55-3.66 0-5.03.47-1.14 1.81-2.25 2.47-2.75 3.96-2.8 10.33-6.93 14.24-9.46 3.39-2.19 6.31-4.09 8.01-5.27 5.51-3.85 9.27-7.77 11.49-11.99 2.88-5.47 3.22-11.48.98-17.41-3.02-7.98-10.47-12.75-19.94-12.75-2.11 0-4.27.24-6.42.71-5.42 1.17-10.57 3.1-14.88 4.78a.472.472 0 01-.64-.46c.46-10.67.97-25-.21-38.64-1.07-12.33-3.6-22.72-7.75-31.77-4.17-9.09-9.58-15.82-13.82-20.67-4.05-4.64-11.13-11.45-21.83-17.57-15.07-8.62-32.22-12.99-50.97-12.99-18.71 0-35.84 4.37-50.92 12.98-11.33 6.47-18.57 13.79-21.88 17.58-4.24 4.85-9.64 11.58-13.81 20.67-4.15 9.05-6.69 19.44-7.75 31.77-1.19 13.66-.71 26.87-.22 38.63.02.35-.33.59-.65.47-4.3-1.68-9.46-3.61-14.87-4.78-2.15-.47-4.31-.71-6.42-.71-9.47 0-16.92 4.77-19.94 12.75-2.24 5.93-1.9 11.94.98 17.41 2.23 4.22 5.99 8.14 11.49 11.99 1.7 1.18 4.62 3.08 8.01 5.27 3.83 2.48 10.02 6.49 14 9.28.49.36 2.17 1.62 2.7 2.93.57 1.4.67 2.46-.05 5.24-1.24 4.06-4.01 11.39-9.8 20.13-4.85 7.3-10.87 14.15-17.9 20.37-8.76 7.75-19.14 14.55-30.86 20.22-.55.27-1.21.61-1.93 1.02v-.01s-7 3.58-8.32 8.2c-1.95 6.83 3.24 13.22 8.56 16.65 8.68 5.59 19.25 8.6 25.38 10.24 1.7.45 3.25.87 4.66 1.31.88.29 3.09 1.12 4.03 2.33 1.19 1.53 1.33 3.43 1.76 5.56.68 3.59 2.17 8.06 6.62 11.12 4.88 3.38 11.09 3.62 18.95 3.92 8.22.32 18.46.71 30.16 4.57 5.43 1.8 10.35 4.82 16.04 8.31 11.89 7.31 26.69 16.4 51.98 16.4 25.3 0 40.2-9.14 52.17-16.49 5.66-3.47 10.55-6.47 15.85-8.22 11.71-3.87 21.94-4.26 30.16-4.57 7.86-.3 14.07-.54 18.96-3.92 4.75-3.28 6.13-8.17 6.75-11.87.33-1.83.56-3.46 1.61-4.81.89-1.15 2.93-1.95 3.89-2.29 1.45-.45 3.05-.88 4.82-1.35 6.13-1.64 13.81-3.58 23.16-8.86 11.19-6.32 11.95-14.17 10.79-18.03z"/><path d="M408.78 351.17c-15.32 8.46-25.5 7.56-33.42 12.65-6.73 4.33-2.75 13.67-7.64 17.04-6 4.15-23.76-.29-46.68 7.28-18.91 6.25-30.98 24.23-65.03 24.23-34.12 0-45.83-17.89-65.02-24.23-22.93-7.57-40.68-3.13-46.69-7.28-4.88-3.37-.91-12.71-7.63-17.04-7.92-5.09-18.11-4.19-33.42-12.65-9.75-5.38-4.22-8.72-.97-10.29 55.49-26.86 64.33-68.34 64.73-71.46.48-3.72 1.01-6.65-3.1-10.45-3.96-3.66-21.55-14.54-26.42-17.95-8.08-5.63-11.63-11.27-9.01-18.19 1.8-4.78 6.29-6.59 11.01-6.59 1.47 0 2.96.18 4.4.49 8.86 1.93 17.47 6.36 22.45 7.57.68.16 1.29.24 1.83.24 2.64 0 3.58-1.34 3.4-4.37-.57-9.7-1.94-28.6-.42-46.26 2.1-24.29 9.94-36.33 19.25-46.98 4.47-5.12 25.46-27.3 65.61-27.3 40.26 0 61.15 22.18 65.62 27.3 9.31 10.65 17.15 22.69 19.24 46.98 1.53 17.66.21 36.57-.41 46.26-.21 3.19.75 4.37 3.4 4.37.54 0 1.15-.08 1.83-.24 4.98-1.21 13.58-5.64 22.45-7.57 1.44-.31 2.93-.49 4.4-.49 4.72 0 9.2 1.81 11.01 6.59 2.62 6.92-.93 12.56-9.01 18.19-4.88 3.41-22.46 14.29-26.43 17.95-4.1 3.8-3.57 6.73-3.1 10.45.4 3.12 9.25 44.6 64.74 71.46 3.25 1.57 8.78 4.91-.97 10.29zM265.06 79.91h-18.08c-17.08 1.22-32.88 5.93-47.09 14.05-12.03 6.87-20 14.55-24.58 19.78-10.99 12.57-21.52 28.35-24.12 58.45-.74 8.55-.92 17.3-.79 25.49-.75-.19-1.5-.36-2.26-.53-2.88-.63-5.79-.94-8.65-.94-13.79 0-25.2 7.48-29.75 19.53-3.29 8.69-2.75 17.93 1.51 26.01 3.02 5.74 7.85 10.88 14.77 15.7 1.84 1.29 4.69 3.14 8.3 5.48 1.95 1.26 4.8 3.11 7.6 4.95.42.3 1.93 1.4 2.43 2.45.58 1.2.6 2.49-.26 4.87-1.48 3.27-3.6 7.26-6.6 11.66-8.93 13.05-21.69 24.1-37.98 32.93-8.64 4.6-17.61 7.63-21.4 17.93-.85 2.31-1.28 4.71-1.28 7.14.01 5.77 2.45 11.69 7.55 16.93l.01-.01c2.39 2.57 5.39 4.85 9.18 6.93 8.89 4.91 16.45 7.32 22.4 8.97 1.04.31 3.46 1.1 4.52 2.02 2.65 2.32 2.27 5.81 5.8 10.91 2.13 3.18 4.6 5.34 6.62 6.74 7.4 5.11 15.72 5.43 24.52 5.77 7.96.3 16.97.65 27.28 4.05 4.26 1.41 8.69 4.13 13.83 7.29 11.05 6.79 25.77 15.83 49.06 17.63h16.81c23.32-1.81 38.14-10.89 49.26-17.72 5.1-3.13 9.51-5.83 13.66-7.2 10.29-3.41 19.31-3.75 27.27-4.05 8.8-.34 17.11-.66 24.51-5.77 2.33-1.61 5.24-4.22 7.55-8.22 2.53-4.31 2.47-7.35 4.85-9.43.97-.85 3.11-1.58 4.25-1.94 6-1.65 13.66-4.05 22.7-9.05 4.01-2.21 7.15-4.63 9.61-7.39.03-.03.06-.07.09-.1 6.81-7.33 8.52-15.92 5.73-23.5-2.49-6.77-7.23-10.4-12.63-13.4a40.52 40.52 0 00-2.72-1.44c-1.61-.83-3.25-1.64-4.9-2.49-16.83-8.92-29.97-20.18-39.1-33.53-3.08-4.51-5.22-8.58-6.7-11.89-.78-2.23-.75-3.48-.19-4.64.42-.88 1.55-1.8 2.15-2.24 2.89-1.91 5.89-3.86 7.91-5.16 3.6-2.34 6.45-4.19 8.3-5.48 6.91-4.82 11.74-9.96 14.77-15.7 4.26-8.08 4.8-17.32 1.51-26.01-4.56-12.05-15.96-19.53-29.75-19.53-2.86 0-5.77.31-8.66.94-.76.17-1.51.34-2.25.53.12-8.19-.05-16.94-.79-25.49-2.6-30.1-13.13-45.88-24.13-58.45-4.58-5.24-12.55-12.93-24.52-19.77-14.2-8.13-30.02-12.84-47.13-14.06z"/></g></svg>
        <span class="text-sm font-medium">Snapchat Story/Spotlight</span>
      </div>
      <span class="text-xs text-gray-400 font-mono">1080 x 1920</span>
    </div>
  </div>
</div>
    
        <div id="view-elements" class="sidebar-view ">
    
          <div class="p-4 space-y-8">
              <section>
                  <div class="flex items-center justify-between mb-3 px-1">
                      <h3 class="text-[10px] uppercase tracking-widest text-slate-400 font-medium">Shapes</h3>
                      <span class="text-[10px] font-medium text-slate-400 bg-slate-200/50 px-2 py-0.5 rounded-full">20</span>
                  </div>
                  
                  <div class="element-grid grid grid-cols-4 gap-2">
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 hover:bg-blue-50/30 transition-all" onclick="Editor.addShape('rect')" title="Rectangle">
                          <div class="w-5 h-5 bg-blue-500 rounded-sm group-hover:scale-110 transition-transform"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 hover:bg-blue-50/30 transition-all" onclick="Editor.addShape('circle')" title="Circle">
                          <div class="w-5 h-5 bg-blue-500 rounded-full group-hover:scale-110 transition-transform"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 hover:bg-blue-50/30 transition-all" onclick="Editor.addShape('triangle')" title="Triangle">
                          <div class="w-0 h-0 border-l-[10px] border-r-[10px] border-b-[18px] border-l-transparent border-r-transparent border-b-blue-500 group-hover:scale-110 transition-transform"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 hover:bg-blue-50/30 transition-all" onclick="Editor.addShape('pill')" title="Pill">
                          <div class="w-7 h-3.5 bg-blue-500 rounded-full group-hover:scale-110 transition-transform"></div>
                      </button>
      
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('pentagon')" title="Pentagon"><i data-lucide="pentagon" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('hexagon')" title="Hexagon"><i data-lucide="hexagon" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('octagon')" title="Octagon"><i data-lucide="octagon" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('star5')" title="Star"><i data-lucide="star" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
      
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('star_burst')" title="Burst"><i data-lucide="sun" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('arrow_right')" title="Arrow Right"><i data-lucide="arrow-right" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('arrow_left')" title="Arrow Left"><i data-lucide="arrow-left" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('chevron')" title="Chevron"><i data-lucide="chevron-right" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
      
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('cross')" title="Cross"><i data-lucide="plus" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('cloud')" title="Cloud"><i data-lucide="cloud" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('heart')" title="Heart"><i data-lucide="heart" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('speech_bubble')" title="Chat"><i data-lucide="message-square" class="w-5 h-5 text-blue-500 group-hover:scale-110 transition-transform"></i></button>
      
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('donut')" title="Donut">
                          <div class="w-5 h-5 border-[3px] border-blue-500 rounded-full group-hover:scale-110 transition-transform"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('parallelogram')" title="Parallelogram">
                          <div class="w-5 h-4 bg-blue-500 transform skew-x-[-20deg] group-hover:scale-110 transition-transform"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('trapezoid')" title="Trapezoid"><svg class="w-6 h-6 text-blue-500 group-hover:scale-110 transition-transform" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M31.7944 8H16.2056C14.8934 8 13.7335 8.85275 13.3421 10.1052L5.21713 36.1052C4.61345 38.037 6.05665 40 8.08057 40H39.9194C41.9433 40 43.3866 38.037 42.7829 36.1052L34.6579 10.1052C34.2665 8.85275 33.1066 8 31.7944 8Z" stroke="currentColor" stroke-width="4"/></svg></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl bg-white border border-slate-200 shadow-sm hover:border-blue-400 transition-all" onclick="Editor.addShape('diamond')" title="Diamond">
                          <div class="w-4 h-4 bg-blue-500 transform rotate-45 group-hover:scale-110 transition-transform"></div>
                      </button>
                  </div>
              </section>
      
              <section>
                  <div class="flex items-center justify-between mb-3 px-1">
                      <h3 class="text-[10px] uppercase tracking-widest text-slate-400 font-medium">Frames</h3>
                      <span class="text-[10px] font-medium text-slate-400 bg-slate-200/50 px-2 py-0.5 rounded-full">16</span>
                  </div>
                  
                  <div class="grid grid-cols-4 gap-2">
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 hover:bg-white transition-all" onclick="Editor.addFrame('circle')">
                          <div class="w-5 h-5 rounded-full border-2 border-slate-300 group-hover:border-blue-300"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 hover:bg-white transition-all" onclick="Editor.addFrame('rect')">
                          <div class="w-5 h-5 border-2 border-slate-300 group-hover:border-blue-300"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 hover:bg-white transition-all" onclick="Editor.addFrame('rounded')">
                          <div class="w-5 h-5 rounded-md border-2 border-slate-300 group-hover:border-blue-300"></div>
                      </button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 hover:bg-white transition-all" onclick="Editor.addFrame('diamond')">
                          <div class="w-4 h-4 border-2 border-slate-300 transform rotate-45 group-hover:border-blue-300"></div>
                      </button>
      
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('star')"><i data-lucide="star" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('heart')"><i data-lucide="heart" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('hexagon')"><i data-lucide="hexagon" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('octagon')"><i data-lucide="octagon" class="w-5 h-5"></i></button>
      
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('shield')"><i data-lucide="shield" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('ticket')"><i data-lucide="ticket" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('flower')"><i data-lucide="flower-2" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('cloud')"><i data-lucide="cloud" class="w-5 h-5"></i></button>
      
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('cross')"><i data-lucide="x" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('message')"><i data-lucide="message-circle" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 transition-all text-slate-400 hover:text-blue-400" onclick="Editor.addFrame('polaroid')"><i data-lucide="frame" class="w-5 h-5"></i></button>
                      <button class="group flex items-center justify-center aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-blue-400 hover:bg-white transition-all" onclick="Editor.addFrame('pill')">
                          <div class="w-7 h-3.5 bg-slate-100 rounded-full border-2 border-slate-300 group-hover:border-blue-300"></div>
                      </button>
                  </div>
              </section>
      
              <section>
                  <div class="flex items-center justify-between mb-3 px-1">
                      <h3 class="text-[10px] uppercase tracking-widest text-slate-400 font-medium">Icons</h3>
                      <span class="text-[10px] font-medium text-slate-400 bg-slate-200/50 px-2 py-0.5 rounded-full">20</span>
                  </div>
              
                  <div class="grid grid-cols-5 gap-1 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('star')" title="Star"><i data-lucide="star" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('heart')" title="Heart"><i data-lucide="heart" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('home')" title="Home"><i data-lucide="home" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('user')" title="User"><i data-lucide="user" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('settings')" title="Settings"><i data-lucide="settings" class="w-4 h-4 group-hover:scale-110"></i></button>
                      
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('search')" title="Search"><i data-lucide="search" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('bell')" title="Bell"><i data-lucide="bell" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('check')" title="Check"><i data-lucide="check" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('close')" title="Close"><i data-lucide="x" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('camera')" title="Camera"><i data-lucide="camera" class="w-4 h-4 group-hover:scale-110"></i></button>
                      
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('image')" title="Image"><i data-lucide="image" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('trash')" title="Trash"><i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('edit')" title="Edit"><i data-lucide="pencil" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('mail')" title="Mail"><i data-lucide="mail" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('phone')" title="Phone"><i data-lucide="phone" class="w-4 h-4 group-hover:scale-110"></i></button>
                      
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('lock')" title="Lock"><i data-lucide="lock-keyhole" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('unlock')" title="Unlock"><i data-lucide="lock-keyhole-open" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('map')" title="Map"><i data-lucide="map" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('bulb')" title="Idea"><i data-lucide="lightbulb" class="w-4 h-4 group-hover:scale-110"></i></button>
                      <button class="flex items-center justify-center aspect-square hover:bg-blue-50 hover:text-blue-600 rounded-lg text-slate-600 transition-all group" onclick="Editor.addIcon('cart')" title="Cart"><i data-lucide="shopping-cart" class="w-4 h-4 group-hover:scale-110"></i></button>
                  </div>
              </section>
              
              <div class="h-12"></div>
          </div>
      </div>
        

        <div id="view-templates" class="sidebar-view ">
    
          <div class="sticky top-0 z-20 py-4 bg-gradient-to-r from-[#f0f1f5] to-white"> 
              <div class="px-4 pb-2">
                <div class="relative group" style="display: block; width: 100%;">
                  <div class="absolute inset-y-0 left-0 flex items-center pointer-events-none" 
                       style="padding-left: 1rem; z-index: 20;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 group-focus-within:text-gray-600 transition-colors">
                          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                      </svg>
                  </div>
              
                  <input 
                      type="text" 
                      id="tpl-search" 
                      placeholder="Search all templates..." 
                      style="padding-left: 3rem !important;" 
                      class="w-full pr-4 py-2 bg-transparent border border-gray-200 rounded-full text-gray-700 placeholder-gray-400 focus:outline-none focus:border-gray-400 focus:ring-2 focus:ring-gray-100 transition-all"
                      onkeyup="Editor.filterTemplates()"
                  >
              </div>
              </div>
      
              <div class="flex items-center justify-center gap-1 py-1 mx-auto overflow-x-auto no-scrollbar pb-1">
                  
                  <div class="relative flex-shrink-0">
                      <select id="filter-type" class="appearance-none bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-1.5 pl-3 pr-7 rounded-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors text-xs" onchange="Editor.filterTemplates()">
                          <option value="All">Type</option>
                          <option value="Instagram">Instagram</option>
                          <option value="YouTube">YouTube</option>
                          <option value="TikTok">TikTok</option>
                      </select>
                      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                      </div>
                  </div>
      
                  <div class="relative flex-shrink-0">
                      <select id="filter-category" class="appearance-none bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-1.5 pl-3 pr-7 rounded-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors text-xs" onchange="Editor.filterTemplates()">
                          <option value="All">Category</option>
                          <option value="Business">Business</option>
                          <option value="Charity">Charity</option>
                          <option value="Fashion">Fashion</option>
                          <option value="Quote">Quote</option>
                      </select>
                      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                      </div>
                  </div>
      
                  <div class="relative flex-shrink-0">
                      <select id="filter-style" class="appearance-none bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-1.5 pl-3 pr-7 rounded-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors text-xs" onchange="Editor.filterTemplates()">
                          <option value="All">Style</option>
                          <option value="Minimal">Minimal</option>
                          <option value="Modern">Modern</option>
                          <option value="Bold">Bold</option>
                      </select>
                      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                      </div>
                  </div>
              </div>
          </div>
      
          <div id="templates-grid" class="flex-1 grid grid-cols-2 gap-4 px-4 pb-20 overflow-y-auto">
              <div class="col-span-2 flex flex-col items-center justify-center py-20 text-gray-400">
                  <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-gray-300 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span class="text-sm font-medium">Loading templates...</span>
              </div>
          </div>
      
      </div>
    
          <div id="view-styles" class="sidebar-view">
            <div class="style-grid">
              <div class="style-card" style="background-color: #2D1B69; color: white; font-family: 'Playfair Display'; font-style:italic;" onclick="Editor.applyPresetStyle('popup')">
                 Pop-Up
              </div>
              
              <div class="style-card" style="background-color: #FFC0CB; color: #0000FF; font-family: 'Inter'; font-weight: 800; text-shadow: 2px 2px 0px white;" onclick="Editor.applyPresetStyle('hey')">
                 Hey!
              </div>
          
              <div class="style-card" style="background-color: #8be4f8; color: black; font-family: 'Playfair Display';" onclick="Editor.applyPresetStyle('story')">
                 Story
              </div>
          
              <div class="style-card" style="background-color: white; color: black; font-family: 'Inter'; font-weight:700; border:1px solid #eee;" onclick="Editor.applyPresetStyle('offering')">
                 Offering
              </div>
          
              <div class="style-card" style="background-color: #FFF8F0; color: black; font-family: 'Rock Salt', cursive; font-weight:700;" onclick="Editor.applyPresetStyle('from')">
                 FROM
              </div>
          
              <div class="style-card" style="background-color: #dbfecf; color: black; font-family: 'Inter'; font-weight:900;" onclick="Editor.applyPresetStyle('release')">
                 Release
              </div>
          
              <div class="style-card" style="background-color: #F8E71C; color: black; font-family: 'Impact', sans-serif; text-transform:uppercase; font-weight:900; text-shadow: 2px 2px 0px rgba(0,0,0,0.2);" onclick="Editor.applyPresetStyle('bigsale')">
                 BIG SALE
              </div>
          
              <div class="style-card" style="background-color: #2F4858; color: #F0EAD6; font-family: 'Courier New'; font-weight:900; text-shadow: 3px 3px 0px #000;" onclick="Editor.applyPresetStyle('edgy')">
                 EDGY
              </div>
            </div>
          </div>
          
        </div>

        <!-- Draw & Sketch Sidebar Panel -->
        <div id="view-draw" class="sidebar-view">
            <div class="flex-1 overflow-y-auto custom-scrollbar px-5 pb-10 space-y-6">
                
                <!-- Drawing Mode Toggle -->
                <div class="p-4 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl border border-cyan-100">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-semibold text-gray-800">Drawing Mode</span>
                        <button id="btn-toggle-draw" onclick="PenTool.toggle()" 
                            class="px-4 py-2 bg-cyan-600 text-white text-xs font-medium rounded-full hover:bg-cyan-700 transition-all">
                            Start Drawing
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">Click and drag on canvas to draw freehand</p>
                </div>

                <!-- Brush Color -->
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Brush Color</h4>
                    <div class="grid grid-cols-6 gap-3">
                        <button onclick="PenTool.setColor('#000000')" class="w-10 h-10 rounded-full border border-gray-200 bg-black hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#ffffff')" class="w-10 h-10 rounded-full border border-gray-200 bg-white hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#ef4444')" class="w-10 h-10 rounded-full border border-transparent bg-red-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#f97316')" class="w-10 h-10 rounded-full border border-transparent bg-orange-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#eab308')" class="w-10 h-10 rounded-full border border-transparent bg-yellow-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#22c55e')" class="w-10 h-10 rounded-full border border-transparent bg-green-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#06b6d4')" class="w-10 h-10 rounded-full border border-transparent bg-cyan-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#3b82f6')" class="w-10 h-10 rounded-full border border-transparent bg-blue-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#8b5cf6')" class="w-10 h-10 rounded-full border border-transparent bg-violet-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#ec4899')" class="w-10 h-10 rounded-full border border-transparent bg-pink-500 hover:scale-110 transition-transform"></button>
                        <button onclick="PenTool.setColor('#6b7280')" class="w-10 h-10 rounded-full border border-transparent bg-gray-500 hover:scale-110 transition-transform"></button>
                        <label class="w-10 h-10 rounded-full border border-gray-200 bg-white flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-all">
                            <i data-lucide="plus" class="w-5 h-5 text-gray-500"></i>
                            <input type="color" id="draw-custom-color" class="opacity-0 absolute w-0 h-0" oninput="PenTool.setColor(this.value)">
                        </label>
                    </div>
                </div>

                <!-- Brush Width -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-medium text-gray-900">Brush Size</h4>
                        <span id="draw-width-display" class="text-xs text-gray-500">5px</span>
                    </div>
                    <input type="range" id="draw-brush-width" min="1" max="50" value="5" 
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-cyan-600"
                        oninput="PenTool.setWidth(parseInt(this.value)); document.getElementById('draw-width-display').innerText = this.value + 'px'">
                </div>

                <!-- Brush Type -->
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Brush Type</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="PenTool.setBrushType('pencil')" id="brush-pencil"
                            class="flex flex-col items-center gap-2 p-3 bg-cyan-50 border border-cyan-500 rounded-xl transition-all brush-type-btn">
                            <i data-lucide="pencil" class="w-5 h-5 text-cyan-600"></i>
                            <span class="text-xs font-medium text-cyan-600">Pencil</span>
                        </button>
                        <button onclick="PenTool.setBrushType('circle')" id="brush-circle"
                            class="flex flex-col items-center gap-2 p-3 bg-gray-50 border border-gray-200 rounded-xl hover:bg-white hover:border-gray-300 transition-all brush-type-btn">
                            <i data-lucide="circle" class="w-5 h-5 text-gray-600"></i>
                            <span class="text-xs font-medium text-gray-600">Marker</span>
                        </button>
                        <button onclick="PenTool.setBrushType('spray')" id="brush-spray"
                            class="flex flex-col items-center gap-2 p-3 bg-gray-50 border border-gray-200 rounded-xl hover:bg-white hover:border-gray-300 transition-all brush-type-btn">
                            <i data-lucide="sparkles" class="w-5 h-5 text-gray-600"></i>
                            <span class="text-xs font-medium text-gray-600">Spray</span>
                        </button>
                    </div>
                </div>

                <!-- Opacity -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-medium text-gray-900">Opacity</h4>
                        <span id="draw-opacity-display" class="text-xs text-gray-500">100%</span>
                    </div>
                    <input type="range" id="draw-opacity" min="0.1" max="1" step="0.1" value="1" 
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-cyan-600"
                        oninput="PenTool.setOpacity(parseFloat(this.value)); document.getElementById('draw-opacity-display').innerText = Math.round(this.value * 100) + '%'">
                </div>

                <!-- Actions -->
                <div class="pt-4 border-t border-gray-100 space-y-2">
                    <button onclick="PenTool.clearDrawings()" 
                        class="w-full flex items-center justify-center gap-2 py-2.5 text-gray-600 bg-gray-50 border border-gray-100 rounded-lg hover:bg-gray-100 hover:border-gray-200 transition-all text-sm font-medium">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear All Drawings
                    </button>
                </div>
            </div>
        </div>

      </div>
      <div class="flex-1 bg-[#f0f1f5] relative flex items-center justify-center overflow-auto p-8">
        <!-- Quick Toolbar for Background Mode -->
        <div id="bg-quick-toolbar" class="hidden absolute top-1 left-1/2 -translate-x-1/2 z-[100] flex items-center bg-white border border-gray-200 rounded-full px-2 py-1.5 gap-1">

          <div class="flex items-center gap-1">
            <button onclick="Editor.setBgColor('#ffffff')" class="w-6 h-6 rounded-full border border-gray-200 bg-white hover:scale-110 transition-transform shadow-sm" title="White"></button>
            <button onclick="Editor.setBgColor('#000000')" class="w-6 h-6 rounded-full border border-gray-200 bg-black hover:scale-110 transition-transform" title="Black"></button>
            <button onclick="Editor.setBgColor('#ef4444')" class="w-6 h-6 rounded-full border border-transparent bg-red-500 hover:scale-110 transition-transform shadow-sm" title="Red"></button>
            <button onclick="Editor.setBgColor('#3b82f6')" class="w-6 h-6 rounded-full border border-transparent bg-blue-500 hover:scale-110 transition-transform shadow-sm" title="Blue"></button>
            <button onclick="Editor.setBgColor('#22c55e')" class="w-6 h-6 rounded-full border border-transparent bg-green-500 hover:scale-110 transition-transform shadow-sm" title="Green"></button>
            <label class="w-6 h-6 rounded-full border border-gray-200 bg-gradient-to-br from-red-400 via-purple-400 to-blue-400 cursor-pointer hover:scale-110 transition-transform shadow-sm flex items-center justify-center" title="Custom Color">
              <input type="color" class="opacity-0 absolute w-0 h-0" oninput="Editor.setBgColor(this.value)">
            </label>
          </div>
          <div class="w-[1px] h-4 bg-gray-200 mx-1"></div>
          <button class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-100 rounded-full text-sm font-medium text-gray-700 transition-colors" onclick="UI.showView('background')">
            <span>More</span>
          </button>
        </div>

        <!-- Quick Toolbar for Text Elements - Fixed at top like Canva -->
        <div id="text-quick-toolbar" class="hidden absolute top-1 left-1/2 -translate-x-1/2 z-[100] flex items-center bg-white border border-gray-200 rounded-full px-3 py-1.5 gap-1">
          <!-- Font Family Selector -->
          <div class="relative">
            <select id="qt-font-family" onchange="Editor.updateProp('fontFamily', this.value)" 
                    class="appearance-none bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700 text-sm font-medium rounded-lg py-1.5 pl-3 pr-7 focus:outline-none cursor-pointer min-w-[120px]">
                <option value="Inter" style="font-family: 'Inter'">Inter</option>
                <option value="Roboto" style="font-family: 'Roboto'">Roboto</option>
                <option value="Poppins" style="font-family: 'Poppins'">Poppins</option>
                <option value="Montserrat" style="font-family: 'Montserrat'">Montserrat</option>
                <option value="Lato" style="font-family: 'Lato'">Lato</option>
                <option value="Open Sans" style="font-family: 'Open Sans'">Open Sans</option>
                <option value="DM Sans" style="font-family: 'DM Sans'">DM Sans</option>
                <option value="Space Grotesk" style="font-family: 'Space Grotesk'">Space Grotesk</option>
                <option value="Raleway" style="font-family: 'Raleway'">Raleway</option>
                <option value="Playfair Display" style="font-family: 'Playfair Display'">Playfair Display</option>
                <option value="Merriweather" style="font-family: 'Merriweather'">Merriweather</option>
                <option value="Oswald" style="font-family: 'Oswald'">Oswald</option>
                <option value="Bebas Neue" style="font-family: 'Bebas Neue'">Bebas Neue</option>
                <option value="Archivo Black" style="font-family: 'Archivo Black'">Archivo Black</option>
                <option value="Anton" style="font-family: 'Anton'">Anton</option>
                <option value="Pacifico" style="font-family: 'Pacifico'">Pacifico</option>
                <option value="Dancing Script" style="font-family: 'Dancing Script'">Dancing Script</option>
                <option value="Caveat" style="font-family: 'Caveat'">Caveat</option>
                <option value="Arial" style="font-family: Arial">Arial</option>
                <option value="Courier New" style="font-family: 'Courier New'">Courier New</option>
                <option value="Georgia" style="font-family: Georgia">Georgia</option>
                <option value="Times New Roman" style="font-family: 'Times New Roman'">Times New Roman</option>
                <option value="Verdana" style="font-family: Verdana">Verdana</option>
              </optgroup>
            </select>
            <i data-lucide="chevron-down" class="w-3.5 h-3.5 absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
          </div>
          
          <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
          
          <!-- Font Size Controls -->
          <div class="flex items-center gap-0.5 bg-gray-50 border border-gray-200 rounded-lg">
            <button class="px-2 py-1.5 hover:bg-gray-200 text-gray-600 rounded-l-lg transition-colors" onclick="Editor.adjustFontSize(-2)">
              <i data-lucide="minus" class="w-3.5 h-3.5"></i>
            </button>
            <span id="qt-font-size" class="text-sm font-medium text-gray-700 min-w-[32px] text-center select-none">40</span>
            <button class="px-2 py-1.5 hover:bg-gray-200 text-gray-600 rounded-r-lg transition-colors" onclick="Editor.adjustFontSize(2)">
              <i data-lucide="plus" class="w-3.5 h-3.5"></i>
            </button>
          </div>
          
          <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
          
          <!-- Text Color -->
          <div class="relative w-8 h-8 rounded-lg border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors">
            <div id="qt-color-preview" class="absolute inset-1 rounded bg-black pointer-events-none"></div>
            <input type="color" id="qt-text-color" class="absolute -top-2 -left-2 w-12 h-12 cursor-pointer opacity-0" oninput="Editor.updateProp('fill', this.value); document.getElementById('qt-color-preview').style.backgroundColor = this.value">
          </div>
          
          <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
          
          <!-- Text Formatting Buttons -->
          <div class="flex items-center gap-0.5">
            <button id="qt-bold" class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors font-bold text-sm" onclick="Editor.toggleStyle('bold')" title="Bold">
              B
            </button>
            <button id="qt-italic" class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors italic text-sm" onclick="Editor.toggleStyle('italic')" title="Italic">
              I
            </button>
            <button id="qt-underline" class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors underline text-sm" onclick="Editor.toggleStyle('underline')" title="Underline">
              U
            </button>
            <button id="qt-strikethrough" class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors line-through text-sm" onclick="Editor.toggleStyle('linethrough')" title="Strikethrough">
              S
            </button>
            <button class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors text-xs font-medium" onclick="Editor.toggleCase()" title="Toggle Case">
              aA
            </button>
          </div>
          
          <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
          
          <!-- Text Alignment -->
          <div class="flex items-center gap-0.5">
            <button class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors" onclick="Editor.updateProp('textAlign', 'left')" title="Align Left">
              <i data-lucide="align-left" class="w-4 h-4"></i>
            </button>
            <button class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors" onclick="Editor.updateProp('textAlign', 'center')" title="Align Center">
              <i data-lucide="align-center" class="w-4 h-4"></i>
            </button>
            <button class="flex items-center justify-center w-8 h-8 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors" onclick="Editor.updateProp('textAlign', 'right')" title="Align Right">
              <i data-lucide="align-right" class="w-4 h-4"></i>
            </button>
          </div>
          
          <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
          
          <!-- Effects & Position -->
          <button class="flex items-center gap-1.5 px-3 py-1.5 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="UI.showView('styles')" title="Text Effects">
            Effects
          </button>
          
          <button class="flex items-center gap-1.5 px-3 py-1.5 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="UI.showView('properties')" title="Position">
            Position
          </button>
        </div>

        <div id="image-quick-toolbar" class="hidden absolute top-1 left-1/2 -translate-x-1/2 z-[100] flex items-center bg-white border border-gray-200 rounded-full px-3 py-1.5 gap-1">
          <button class="flex items-center gap-1.5 px-3 py-1.5 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="Editor.toggleBackgroundRemoval()" title="Remove Background">
            <i data-lucide="eraser" class="w-4 h-4"></i>
            <span id="qt-remove-bg-text">Remove BG</span>
          </button>
          
          <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
          
          <button class="flex items-center gap-1.5 px-3 py-1.5 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="Editor.fitToCanvas()" title="Fit to Canvas">
            <i data-lucide="maximize" class="w-4 h-4"></i>
            Fit
          </button>
          
          <button class="flex items-center gap-1.5 px-3 py-1.5 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="Editor.fillCanvas()" title="Fill Canvas">
            <i data-lucide="expand" class="w-4 h-4"></i>
            Fill
          </button>
          
          <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
          
          <button class="flex items-center gap-1.5 px-3 py-1.5 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="UI.showView('properties')" title="Position">
            Position
          </button>
        </div>

        <!-- Pen Tool Quick Toolbar -->
        <div id="draw-quick-toolbar" class="hidden absolute top-1 left-1/2 -translate-x-1/2 z-[100] flex items-center bg-white border border-gray-200 rounded-full px-3 py-1.5 gap-1">
            <!-- Color Picker -->
            <div class="relative w-7 h-7 rounded-full border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors">
                <div id="qt-draw-color-preview" class="absolute inset-1 rounded-full bg-black pointer-events-none"></div>
                <input type="color" id="qt-draw-color" class="absolute -top-2 -left-2 w-12 h-12 cursor-pointer opacity-0" 
                    oninput="PenTool.setColor(this.value); document.getElementById('qt-draw-color-preview').style.backgroundColor = this.value">
            </div>
            
            <div class="w-px h-5 bg-gray-200 mx-1"></div>
            
            <!-- Size Controls -->
            <button onclick="PenTool.adjustWidth(-2)" class="p-1.5 rounded-lg hover:bg-gray-100 text-gray-600 transition-colors" title="Decrease Size">
                <i data-lucide="minus" class="w-4 h-4"></i>
            </button>
            <span id="qt-draw-size" class="min-w-[28px] text-center text-sm font-medium text-gray-700">5</span>
            <button onclick="PenTool.adjustWidth(2)" class="p-1.5 rounded-lg hover:bg-gray-100 text-gray-600 transition-colors" title="Increase Size">
                <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
            
            <div class="w-px h-5 bg-gray-200 mx-1"></div>
            
            <!-- Brush Type Toggle -->
            <button onclick="PenTool.cycleBrushType()" class="p-1.5 rounded-lg hover:bg-gray-100 text-gray-600 transition-colors" title="Change Brush">
                <i data-lucide="paintbrush" class="w-4 h-4"></i>
            </button>
            
            <div class="w-px h-5 bg-gray-200 mx-1"></div>
            
            <!-- Done Button -->
            <button onclick="PenTool.exit()" class="px-3 py-1 bg-cyan-600 text-white text-xs font-medium rounded-full hover:bg-cyan-700 transition-colors">
                Done
            </button>
        </div>

        <div class="canvas-container-wrapper absolute top-14">
          <canvas id="c"></canvas>
          
          <div id="context-menu" class="hidden absolute flex flex-col items-center z-[1000] select-none" style="transform: translateX(-50%);">
  
            <div class="relative flex items-center bg-white border border-gray-200 shadow-xl rounded-xl p-1 gap-1">
              <button class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="Editor.duplicate()">
                <i data-lucide="copy" class="w-4 h-4"></i> Copy
              </button>
              
              <div class="w-[1px] h-4 bg-gray-200 mx-1"></div>
          
              <button class="flex items-center gap-2 px-3 py-1.5 hover:bg-red-50 hover:text-red-600 rounded-lg text-sm font-medium text-gray-700 transition-colors" onclick="Editor.deleteSelected()">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
              </button>
          
              <div class="w-[1px] h-4 bg-gray-200 mx-1"></div>
          
              <button id="ctx-more-trigger" class="flex items-center px-2 py-1.5 hover:bg-gray-100 rounded-lg text-gray-700 transition-colors" onclick="Editor.toggleContextMenu()">
                <i data-lucide="more-horizontal" class="w-5 h-5"></i>
              </button>
            
              <div id="ctx-dropdown-menu" class="hidden absolute top-full left-1/2 -translate-x-1/2 mt-2 flex-col gap-2 bg-white text-gray-700 border border-gray-200 shadow-2xl rounded-xl p-5 min-w-[220px] animate-in fade-in zoom-in duration-150">
              
              <button id="btn-replace-img" class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.openReplaceMenu()" style="display:none;">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i> Replace Image
              </button>
              <button id="btn-remove-bg" class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.toggleBackgroundRemoval()" style="display:none;">
                <span class="icon-container"><i data-lucide="eraser" class="w-5 h-5"></i></span> 
                <span id="txt-ctx-bg">Remove Bg</span>
              </button>
              <button id="btn-fit-canvas" class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.fitToCanvas()" style="display:none;">
                <i data-lucide="maximize" class="w-5 h-5"></i> Fit to Canvas
              </button>
              <button id="btn-fill-canvas" class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.fillCanvas()" style="display:none;">
                <i data-lucide="expand" class="w-5 h-5"></i> Fill Canvas
              </button>
              
              <div id="media-divider" class="h-[1px] bg-gray-100 my-1" style="display:none;"></div>
          
              <button class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.moveLayer('toFront')">
                <i data-lucide="layers-2" class="w-5 h-5"></i> Bring to Front
              </button>
              <button class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.moveLayer('toBack')">
                <i data-lucide="layers" class="w-5 h-5"></i> Send to Back
              </button>
          
              <div class="h-[1px] bg-gray-100 my-1"></div>
          
              <button class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.duplicate()">
                <i data-lucide="copy-plus" class="w-5 h-5"></i> Duplicate
              </button>
              
              <button class="ctx-drop-item gap-4 flex justify-flex-start items-center" onclick="Editor.toggleLock()">
                <span id="lock-icon-container"><i data-lucide="lock" class="w-5 h-5"></i></span>
                <span id="lock-text">Lock Object</span>
              </button>
          
              <div class="h-[1px] bg-gray-100 my-1"></div>
          
              <button class="ctx-drop-item gap-4 flex justify-flex-start items-center text-red-600 hover:bg-red-50" onclick="Editor.deleteSelected()">
                <i data-lucide="trash-2" class="w-5 h-5"></i> Delete
              </button>
            </div>
            </div>
          </div>
          
          <input type="file" id="replaceImgInput" accept="image/*" style="display:none" onchange="Editor.handleImageReplace(this)">
      
        </div>
        <div class="fixed bottom-6 right-6 bg-[#f0f1f5] p-1 rounded-xl flex items-center gap-3">
          <button 
            onclick="UI.toggleLayers()" 
            id="btn-layers-toggle" 
            title="Layers"
            class="p-2 rounded-md transition-colors duration-200 hover:bg-gray-100 text-gray-600 [&.active]:bg-blue-100 [&.active]:text-blue-600"
          >
            <i data-lucide="layers" class="w-4 h-4"></i>
          </button>
          <div class="flex items-center bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg shadow-sm px-2 py-1.5 gap-2">
            <button onclick="Editor.adjustZoom(-0.1)" class="p-0.5 hover:text-primary">
          <i data-lucide="zoom-out" class="w-4 h-4"></i>
            </button>
            <span id="zoom-level" class="text-xs font-medium min-w-[30px] text-center">100%</span>
            <button onclick="Editor.adjustZoom(0.1)" class="p-0.5 hover:text-primary">
          <i data-lucide="zoom-in" class="w-4 h-4"></i>
            </button>
          </div>
          <!-- Canvas Dimensions -->
          <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg px-2 py-1.5 shadow-sm">
            <span id="Dimn-view" class="text-xs font-medium text-gray-500 dark:text-gray-400">1080 x 1350px</span>
          </div>
        </div>
    
      </div>
      
      
    </div>
    
    <div id="assets-container"></div>
    
    <div id="save-modal" class="hidden fixed inset-0 z-[1001] bg-black/60 flex items-center justify-center fade-in-scale">
        <div class="bg-white rounded-2xl shadow-sm p-6 w-full max-w-lg mx-4 relative">
            <button onclick="document.getElementById('save-modal').style.display='none'" class="absolute top-6 right-6 p-2 rounded-full hover:bg-gray-100 transition">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <h3 class="text-2xl font-bold mb-6 tracking-tight">Save as Template</h3>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Template Name</label>
                    <input type="text" id="save-name" placeholder="e.g. Summer Sale 2025" 
                        class="w-full p-3 font-light border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-black/5 focus:border-gray-400 transition-all">
                </div>
    
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                        <div class="relative">
                            <select id="save-type" class="w-full p-3 font-light border border-gray-200 rounded-xl appearance-none focus:outline-none focus:ring-2 focus:ring-black/5 bg-transparent">
                                <option value="Instagram">Instagram</option>
                                <option value="YouTube">YouTube</option>
                                <option value="TikTok">TikTok</option>
                                <option value="Facebook">Facebook</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>
    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <div class="relative">
                            <select id="save-category" class="w-full p-3 font-light border border-gray-200 rounded-xl appearance-none focus:outline-none focus:ring-2 focus:ring-black/5 bg-transparent">
                                <option value="Business">Business</option>
                                <option value="Charity">Charity</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Quote">Quote</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Style</label>
                    <div class="relative">
                        <select id="save-style" class="w-full p-3 font-light border border-gray-200 rounded-xl appearance-none focus:outline-none focus:ring-2 focus:ring-black/5 bg-gray-50/50">
                            <option value="Minimal">Minimal</option>
                            <option value="Modern">Modern</option>
                            <option value="Bold">Bold</option>
                            <option value="Retro">Retro</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="document.getElementById('save-modal').style.display='none'" 
                    class="px-6 py-2.5 rounded-full text-sm font-medium text-gray-500 hover:bg-gray-100 transition">
                    Cancel
                </button>
                <button onclick="Editor.saveTemplate()" 
                    class="btn-primary bg-black text-white px-8 py-2.5 rounded-full text-sm font-medium hover:bg-zinc-800 transition shadow-lg shadow-black/10 flex items-center gap-2">
                    Save Template
                </button>
            </div>
        </div>
    </div>

    <div id="replace-popover">
      <h4>Select Image</h4>
      <div class="replace-grid">
          <div class="replace-thumb" style="background-image:url('https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?w=150');" onclick="Editor.replaceFromUrl('https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?w=500')"></div>
          <div class="replace-thumb" style="background-image:url('https://images.unsplash.com/photo-1492691527719-9d1e07e534b4?w=150');" onclick="Editor.replaceFromUrl('https://images.unsplash.com/photo-1492691527719-9d1e07e534b4?w=500')"></div>
          <div class="replace-thumb" style="background-image:url('https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=150');" onclick="Editor.replaceFromUrl('https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=500')"></div>
          <div class="replace-thumb" style="background-image:url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=150');" onclick="Editor.replaceFromUrl('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=500')"></div>
          <div class="replace-thumb" style="background-image:url('https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?w=150');" onclick="Editor.replaceFromUrl('https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?w=500')"></div>
          <div class="replace-thumb" style="background-image:url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=150');" onclick="Editor.replaceFromUrl('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=500')"></div>
      </div>
      
      <div class="btn-upload-replace" onclick="document.getElementById('replaceImgInput').click()">
          Upload from Computer
      </div>
      <div style="text-align:right; margin-top:10px;">
          <button class="btn btn-sm" onclick="document.getElementById('replace-popover').style.display='none'">Cancel</button>
      </div>
  </div>
  <input type="hidden" id="hidden-caption" value="">
  <script>
    lucide.createIcons();
</script>
    
<script>

  fabric.IText.prototype.updateHiddenTextareaPosition = function() {
    if (!this.hiddenTextarea) return;

    this.hiddenTextarea.style.left = '0px';
    this.hiddenTextarea.style.top = '0px';
  };

  fabric.IText.prototype.initHiddenTextarea = (function(originalFn) {
    return function() {
      originalFn.call(this);
      if (this.hiddenTextarea) {
         this.hiddenTextarea.style.position = 'fixed'; 
         this.hiddenTextarea.style.top = '0';
         this.hiddenTextarea.style.opacity = '0';
         this.hiddenTextarea.scrollIntoView = function() {};
      }
    };
  })(fabric.IText.prototype.initHiddenTextarea);
    
  let PREVIEW_W = 1080; 
  let PREVIEW_H = 1350; 
  let EXPORT_SCALE = 1; 
    
    function updateQuality(val) {
      EXPORT_SCALE = parseInt(val);
    }
    

    const canvas = new fabric.Canvas('c', {
      width: PREVIEW_W,
      height: PREVIEW_H,
      preserveObjectStacking: true ,
      selection: true,
      selectionColor: 'rgba(234, 67, 53, 0.11)', 
      selectionBorderColor: '#EA4335', 
      selectionLineWidth: 1.5,
      enableRetinaScaling: true, 
      imageSmoothingEnabled: true 
    });
    
    
    fabric.Object.prototype._renderBackground = function(ctx) {
      if (!this.backgroundColor) return;
    
      var w = this.width;
      var h = this.height;
      var pad = this.padding || 0;
    
      var totalW = w + (pad * 2);
      var totalH = h + (pad * 2);
    
      var x = -totalW / 2;
      var y = -totalH / 2;
      var rx = this.rx || 0;
      var ry = this.ry || 0;
      rx = Math.min(rx, totalW / 2);
      ry = Math.min(ry, totalH / 2);
    
      ctx.save();
      
      // NUCLEAR OPTION: Explicitly kill all shadow properties
      ctx.shadowColor = "rgba(0,0,0,0)";
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    
      ctx.fillStyle = this.backgroundColor;
      ctx.beginPath();
      ctx.moveTo(x + rx, y);
      ctx.lineTo(x + totalW - rx, y);
      ctx.quadraticCurveTo(x + totalW, y, x + totalW, y + ry);
      ctx.lineTo(x + totalW, y + totalH - ry);
      ctx.quadraticCurveTo(x + totalW, y + totalH, x + totalW - rx, y + totalH);
      ctx.lineTo(x + rx, y + totalH);
      ctx.quadraticCurveTo(x, y + totalH, x, y + totalH - ry);
      ctx.lineTo(x, y + ry);
      ctx.quadraticCurveTo(x, y, x + rx, y);
      ctx.closePath();
      
      ctx.fill();
      
      ctx.restore();
    };
    
    const History = {
      stack: [],
      index: -1,
      limit: 20,
      locked: false, 
    
      init() {
        // Initial state
        this.save();
        
        // Hook into canvas events
        canvas.on('object:modified', () => this.save());
        canvas.on('object:added', (e) => {
            if(!this.locked && !e.target.excludeFromHistory) this.save();
        });
        canvas.on('object:removed', () => {
            if(!this.locked) this.save();
        });
      },
    
      save() {
        if (this.locked) return;
        
        // Remove future states if we were in the middle of the stack
        if (this.index < this.stack.length - 1) {
          this.stack = this.stack.slice(0, this.index + 1);
        }
        
        const json = JSON.stringify(canvas.toJSON(['asset_type', 'server_id', 'selectable', 'evented']));
        this.stack.push(json);
        
        if (this.stack.length > this.limit) {
          this.stack.shift();
        } else {
          this.index++;
        }
        // console.log("State Saved. Index:", this.index);
      },
    
      undo() {
        if (this.index <= 0) return; // Nothing to undo
        
        this.index--;
        this.restore();
      },
    
      redo() {
        if (this.index >= this.stack.length - 1) return; // Nothing to redo
        
        this.index++;
        this.restore();
      },
    
      restore() {
        this.locked = true; // Stop event listeners from saving this as a new state
        const json = this.stack[this.index];
        
        canvas.loadFromJSON(json, () => {
          canvas.renderAll();
          this.locked = false;
          UI.refreshLayers();
    
        });
      }
    };

    const ICON_LIBRARY = {
    star: "M 128 0 L 168 80 L 256 93 L 192 155 L 207 244 L 128 202 L 49 244 L 64 155 L 0 93 L 88 80 Z",
    heart: "M 233 36 C 205 9 166 6 135 30 L 128 36 L 121 30 C 90 6 51 9 23 36 C -13 71 -3 135 34 172 L 128 266 L 222 172 C 259 135 269 71 233 36 Z",
    home: "M 128 16 L 16 112 L 48 112 L 48 240 L 112 240 L 112 176 L 144 176 L 144 240 L 208 240 L 208 112 L 240 112 Z",
    user: "M 128 0 C 92 0 64 28 64 64 C 64 100 92 128 128 128 C 164 128 192 100 192 64 C 192 28 164 0 128 0 Z M 128 144 C 85 144 0 165 0 208 L 0 256 L 256 256 L 256 208 C 256 165 171 144 128 144 Z",
    settings: "M 250 108 L 222 104 C 218 92 212 80 204 70 L 222 47 C 226 42 225 35 220 30 L 195 5 C 190 0 183 -1 178 3 L 155 21 C 143 16 131 12 118 10 L 114 0 L 78 0 L 74 10 C 61 12 49 16 37 21 L 14 3 C 9 -1 2 0 -3 5 L -28 30 C -33 35 -34 42 -30 47 L -12 70 C -20 80 -26 92 -30 104 L -58 108 L -58 144 L -30 148 C -26 160 -20 172 -12 182 L -30 205 C -34 210 -33 217 -28 222 L -3 247 C 2 252 9 253 14 249 L 37 231 C 49 236 61 240 74 242 L 78 252 L 114 252 L 118 242 C 131 240 143 236 155 231 L 178 249 C 183 253 190 252 195 247 L 220 222 C 225 217 226 210 222 205 L 204 182 C 212 172 218 160 222 148 L 250 144 Z M 96 168 C 73 168 56 150 56 128 C 56 105 73 88 96 88 C 119 88 136 105 136 128 C 136 150 119 168 96 168 Z",
    search: "M 200 180 L 250 230 L 230 250 L 180 200 C 160 215 135 224 108 224 C 48 224 0 176 0 116 C 0 56 48 8 108 8 C 168 8 216 56 216 116 C 216 143 207 168 200 180 Z M 108 40 C 66 40 32 74 32 116 C 32 158 66 192 108 192 C 150 192 184 158 184 116 C 184 74 150 40 108 40 Z",
    bell: "M 128 32 C 145 32 160 47 160 64 L 96 64 C 96 47 111 32 128 32 Z M 224 160 L 224 192 L 32 192 L 32 160 C 32 128 64 96 64 96 C 64 96 64 80 64 64 C 64 28 92 0 128 0 C 164 0 192 28 192 64 C 192 80 192 96 192 96 C 192 96 224 128 224 160 Z",
    check: "M 224 48 L 96 176 L 32 112 L 0 144 L 96 240 L 256 80 Z",
    close: "M 208 32 L 176 0 L 104 72 L 32 0 L 0 32 L 72 104 L 0 176 L 32 208 L 104 136 L 176 208 L 208 176 L 136 104 Z",
    camera: "M 80 48 L 96 16 L 160 16 L 176 48 L 224 48 C 241 48 256 63 256 80 L 256 208 C 256 225 241 240 224 240 L 32 240 C 15 240 0 225 0 208 L 0 80 C 0 63 15 48 32 48 L 80 48 Z M 128 96 C 92 96 64 124 64 160 C 64 196 92 224 128 224 C 164 224 192 196 192 160 C 192 124 164 96 128 96 Z",
    image: "M 224 32 L 32 32 C 14 32 0 46 0 64 L 0 192 C 0 210 14 224 32 224 L 224 224 C 242 224 256 210 256 192 L 256 64 C 256 46 242 32 224 32 Z M 64 80 C 73 80 80 87 80 96 C 80 105 73 112 64 112 C 55 112 48 105 48 96 C 48 87 55 80 64 80 Z M 224 192 L 32 192 L 32 160 L 80 112 L 112 144 L 160 96 L 224 160 L 224 192 Z",
    trash: "M 24 64 L 232 64 L 232 88 L 208 88 L 208 248 C 208 256 200 264 192 264 L 64 264 C 56 264 48 256 48 248 L 48 88 L 24 88 Z M 96 24 L 160 24 L 160 48 L 96 48 Z",
    edit: "M 192 32 L 224 64 L 64 224 L 32 224 L 32 192 Z M 216 8 L 248 40 L 232 56 L 200 24 Z",
    mail: "M 224 48 L 32 48 C 14 48 0 62 0 80 L 0 176 C 0 194 14 208 32 208 L 224 208 C 242 208 256 194 256 176 L 256 80 C 256 62 242 48 224 48 Z M 224 80 L 128 144 L 32 80 L 224 80 Z",
    phone: "M 224 160 L 176 160 L 168 184 C 152 176 136 168 128 160 C 120 152 112 136 104 120 L 128 112 L 128 64 L 80 64 C 71 64 64 71 64 80 C 64 142 114 192 176 192 C 185 192 192 185 192 176 L 192 128 Z",
    lock: "M 192 96 L 192 64 C 192 28 164 0 128 0 C 92 0 64 28 64 64 L 64 96 L 32 96 L 32 224 L 224 224 L 224 96 Z M 96 64 C 96 46 110 32 128 32 C 146 32 160 46 160 64 L 160 96 L 96 96 Z",
    unlock: "M 192 96 L 192 64 C 192 28 164 0 128 0 C 92 0 64 28 64 64 L 96 64 C 96 46 110 32 128 32 C 146 32 160 46 160 64 L 160 96 L 32 96 L 32 224 L 224 224 L 224 96 Z",
    map: "M 0 48 L 85 0 L 170 48 L 256 0 L 256 208 L 170 256 L 85 208 L 0 256 Z M 85 32 L 85 192 L 170 240 L 170 80 Z",
    bulb: "M 128 0 C 75 0 32 43 32 96 C 32 128 48 156 72 172 L 72 208 C 72 217 79 224 88 224 L 168 224 C 177 224 184 217 184 208 L 184 172 C 208 156 224 128 224 96 C 224 43 181 0 128 0 Z",
    cart: "M 224 192 L 64 192 L 32 32 L 0 32 L 0 0 L 48 0 L 80 160 L 224 160 C 233 160 240 153 240 144 L 256 64 C 258 55 251 48 242 48 L 88 48 L 96 80 L 224 80 L 224 192 Z M 64 208 C 55 208 48 215 48 224 C 48 233 55 240 64 240 C 73 240 80 233 80 224 C 80 215 73 208 64 208 Z M 192 208 C 183 208 176 215 176 224 C 176 233 183 240 192 240 C 201 240 208 233 208 224 C 208 215 201 208 192 208 Z"
};

const SHAPE_LIBRARY = {
    pentagon: "M 100 0 L 195 69 L 159 181 L 41 181 L 5 69 Z",
    hexagon: "M 50 0 L 150 0 L 200 87 L 150 173 L 50 173 L 0 87 Z",
    octagon: "M 60 0 L 140 0 L 200 60 L 200 140 L 140 200 L 60 200 L 0 140 L 0 60 Z",
    star5: "M 100 0 L 125 60 L 190 65 L 140 105 L 155 170 L 100 135 L 45 170 L 60 105 L 10 65 L 75 60 Z",
    star_burst: "M 100 0 L 120 35 L 160 20 L 160 60 L 200 80 L 160 100 L 160 140 L 120 125 L 100 160 L 80 125 L 40 140 L 40 100 L 0 80 L 40 60 L 40 20 L 80 35 Z",
    arrow_right: "M 0 60 L 120 60 L 120 20 L 200 100 L 120 180 L 120 140 L 0 140 Z",
    arrow_left: "M 200 60 L 80 60 L 80 20 L 0 100 L 80 180 L 80 140 L 200 140 Z",
    chevron: "M 40 0 L 160 100 L 40 200 L 0 160 L 80 100 L 0 40 Z",
    cross: "M 60 0 L 140 0 L 140 60 L 200 60 L 200 140 L 140 140 L 140 200 L 60 200 L 60 140 L 0 140 L 0 60 L 60 60 Z",
    cloud: "M 50 120 C 10 120 0 80 20 60 C 20 20 60 0 90 20 C 120 0 160 20 160 60 C 190 60 200 100 170 120 Z",
    heart: "M 100 30 C 60 -30 0 10 0 60 C 0 110 100 170 100 170 C 100 170 200 110 200 60 C 200 10 140 -30 100 30 Z",
    speech_bubble: "M 20 20 L 180 20 L 180 140 L 60 140 L 20 180 L 20 20 Z",
    trapezoid: "M 40 0 L 160 0 L 200 150 L 0 150 Z"
};

const FRAME_LIBRARY = {
    star: SHAPE_LIBRARY.star5,
    heart: SHAPE_LIBRARY.heart,
    hexagon: SHAPE_LIBRARY.hexagon,
    octagon: SHAPE_LIBRARY.octagon,
    cloud: SHAPE_LIBRARY.cloud,
    cross: SHAPE_LIBRARY.cross,
    message: SHAPE_LIBRARY.speech_bubble,
    blob1: "M 150 20 C 220 20 250 80 230 140 C 210 200 150 230 90 210 C 30 190 10 120 30 60 C 50 0 110 20 150 20 Z",
    blob2: "M 100 20 C 160 -10 220 60 200 120 C 180 180 120 220 80 180 C 40 140 -20 80 20 40 C 40 10 80 30 100 20 Z",
    shield: "M 100 0 L 200 40 L 200 120 C 200 180 100 220 100 220 C 100 220 0 180 0 120 L 0 40 Z",
    window_arch: "M 0 100 C 0 0 200 0 200 100 L 200 200 L 0 200 Z",
    ticket: "M 0 0 L 200 0 L 200 60 C 180 60 180 100 200 100 L 200 160 L 0 160 L 0 100 C 20 100 20 60 0 60 Z",
    flower: "M 100 40 C 120 0 160 0 180 40 C 220 40 220 80 180 100 C 220 140 180 180 140 160 C 120 200 80 200 60 160 C 20 180 -20 140 20 100 C -20 80 -20 40 20 40 C 40 0 80 0 100 40 Z",
    triangle: "M 100 0 L 200 200 L 0 200 Z"
};
    
    const Editor = {
      targetForReplace: null,
      _clipboard: null,
      currentZoom: 1,
      hoveredObject: null,
      
    init() {
      const self = this; 
      canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
      function renderBarHandle(ctx, left, top, styleOverride, fabricObject) {
        const w = 20, h = 10;
        ctx.save();
        ctx.translate(left, top);
        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
        ctx.beginPath();
        if (ctx.roundRect) {
            ctx.roundRect(-w / 2, -h / 2, w, h, 3);
        } else {
            ctx.rect(-w / 2, -h / 2, w, h);
        }
        ctx.fillStyle = '#ffdad7';
        ctx.fill();
        ctx.strokeStyle = '#EA4335';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
      }

      function renderCircleHandle(ctx, left, top, styleOverride, fabricObject) {
          ctx.save();
          ctx.translate(left, top);
          ctx.beginPath();
          ctx.arc(0, 0, 8, 0, Math.PI * 2);
          ctx.fillStyle = '#ffdad7';
          ctx.fill();
          ctx.strokeStyle = '#EA4335';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.restore();
      }

      function applyProControls(proto) {
          // Side handles (Horizontal)
          proto.controls.ml = new fabric.Control({ 
              x: -0.5, y: 0, 
              cursorStyle: 'ew-resize', // Changed from pointer
              actionHandler: fabric.controlsUtils.scalingX, 
              render: renderBarHandle 
          });
          proto.controls.mr = new fabric.Control({ 
              x: 0.5, y: 0, 
              cursorStyle: 'ew-resize', // Changed from pointer
              actionHandler: fabric.controlsUtils.scalingX, 
              render: renderBarHandle 
          });
          
          // Side handles (Vertical)
          proto.controls.mt = new fabric.Control({ 
              x: 0, y: -0.5, 
              cursorStyle: 'ns-resize', // Changed from pointer
              actionHandler: fabric.controlsUtils.scalingY, 
              render: renderBarHandle 
          });
          proto.controls.mb = new fabric.Control({ 
              x: 0, y: 0.5, 
              cursorStyle: 'ns-resize', // Changed from pointer
              actionHandler: fabric.controlsUtils.scalingY, 
              render: renderBarHandle 
          });

          // Corner handles with specific diagonal cursors
          const cursorMap = {
              tl: 'nwse-resize', // Top Left
              tr: 'nesw-resize', // Top Right
              bl: 'nesw-resize', // Bottom Left
              br: 'nwse-resize'  // Bottom Right
          };

          ['tl', 'tr', 'bl', 'br'].forEach(corner => {
              proto.controls[corner] = new fabric.Control({
                  x: (corner.includes('l') ? -0.5 : 0.5),
                  y: (corner.includes('t') ? -0.5 : 0.5),
                  cursorStyle: cursorMap[corner], // Dynamic cursor based on corner
                  actionHandler: fabric.controlsUtils.scalingEqually,
                  render: renderCircleHandle
              });
          });

          // Rotation Handle
          proto.controls.mtr = new fabric.Control({
              x: 0, y: -0.5, offsetY: -40,
              cursorStyle: 'crosshair', // Kept as crosshair, or you could use 'grab'
              actionHandler: fabric.controlsUtils.rotationWithSnapping,
              render: renderCircleHandle
          });
      }
    
        applyProControls(fabric.Object.prototype);
        applyProControls(fabric.Textbox.prototype); 
    
        fabric.Object.prototype.set({
            transparentCorners: false,
            borderColor: '#EA4335',
            cornerColor: '#ffffff',
            borderOpacityWhenMoving: 1,
            cornerSize: 12,
            padding: 10,
            lockUniScaling: false,
            hoverCursor: 'move', 
            cornerStrokeColor: '#d6d6d6', 
            borderColor: '#EA4335',                   
            cornerStyle: 'circle',        
            borderDashArray: [0, 0],     
        });
    

        this.hoveredObject = null;
    
        canvas.on('mouse:over', (e) => {
            if (e.target && e.target !== canvas.getActiveObject()) {
                this.hoveredObject = e.target;
                canvas.requestRenderAll();
            }
        });
    
        canvas.on('mouse:out', () => {
            this.hoveredObject = null;
            canvas.requestRenderAll();
        });
    
        canvas.on('after:render', () => { // Removed 'opt' as it's often not needed here
          if (!this.hoveredObject) return;

          // Use the canvas's own context
          const ctx = canvas.getContext(); 
          const obj = this.hoveredObject;

          ctx.save();
          
          // Ensure we are using the viewport coordinates for drawing overlays
          const coords = obj.getCoords();

          ctx.beginPath();
          ctx.strokeStyle = '#EA4335';
          ctx.lineWidth = 2;
          ctx.moveTo(coords[0].x, coords[0].y);
          ctx.lineTo(coords[1].x, coords[1].y);
          ctx.lineTo(coords[2].x, coords[2].y);
          ctx.lineTo(coords[3].x, coords[3].y);
          ctx.closePath();
          ctx.stroke();
          
          ctx.restore();
      });
        const handleSelection = () => {

          const active = canvas.getActiveObject();
          if (!active) return;

          if (active.type === 'textbox' && (active.scaleX !== 1 || active.scaleY !== 1)) {
            let newFontSize = active.fontSize * active.scaleY;
            active.set('fontSize', Math.max(5, Math.round(newFontSize)));

            active.set('width', active.width * active.scaleX);

            active.set({
                scaleX: 1,
                scaleY: 1
            });

            active.setCoords();
          }
          self.onSelection();
          self.updateContextMenu();
          
          // QuickToolbar integration - show element toolbar
          if (typeof QuickToolbar !== 'undefined') {
            QuickToolbar.onSelection(active);
          }
      };
   
      // 3. Attach Listeners using 'self'
      canvas.on({
          'selection:created': handleSelection,
          'selection:updated': handleSelection,
          'selection:cleared': () => {
              self.onDeselection();
              self.updateContextMenu();
              
              // QuickToolbar integration - show background toolbar
              if (typeof QuickToolbar !== 'undefined') {
                QuickToolbar.onDeselection();
              }
          },
          'object:modified': handleSelection,
          'object:moving': () => self.updateContextMenu(),
          'object:scaling': () => self.updateContextMenu(),
          'object:rotating': () => self.updateContextMenu()
      });
    
        canvas.on('mouse:dblclick', (e) => {
          if (e.target && e.target.isFrame) {
              this.enterFrameEditMode(e.target);
          }
      });
    
      canvas.on('selection:cleared', () => {
          this.exitFrameEditMode();
      });
      canvas.on('selection:created', (e) => {
          if (this.isEditingFrame && e.target !== this.activeFrameObj) {
              this.exitFrameEditMode();
          }
      });
    
        this.resizeCanvas("ig_portrait");
        
        document.getElementById('mediaInput').addEventListener('change', (e) => this.handleUpload(e));
        
        const menu = document.getElementById('context-menu');
        const dropdown = document.getElementById('ctx-dropdown-menu');
    
        [menu, dropdown].forEach(el => {
            if (el) el.addEventListener('mousedown', (e) => e.stopPropagation());
        });
    
        History.init();
        this.initKeyboard();
        this.loadExternalTemplate();
    },
    
      setupHoverEffects() {
        canvas.on('mouse:over', (e) => {
            if (e.target && e.target !== canvas.getActiveObject()) {
                this.hoveredObject = e.target;
                canvas.requestRenderAll(); 
            }
        });
    
        canvas.on('mouse:out', (e) => {
            if (this.hoveredObject) {
                this.hoveredObject = null;
                canvas.requestRenderAll();
            }
        });
    
        canvas.on('after:render', function() {
            const cvs = this; // 'this' is the fabric canvas
            const activeObj = cvs.getActiveObject();
    
            if (!Editor.hoveredObject || Editor.hoveredObject === activeObj) return;
    
            const ctx = cvs.getContext();
            if (!ctx) return;
    
            ctx.save();
            const vpt = cvs.viewportTransform || [1, 0, 0, 1, 0, 0];
            ctx.transform(vpt[0], vpt[1], vpt[2], vpt[3], vpt[4], vpt[5]);
    
            const coords = Editor.hoveredObject.getCoords();
    
            ctx.beginPath();
            ctx.moveTo(coords[0].x, coords[0].y);
            ctx.lineTo(coords[1].x, coords[1].y);
            ctx.lineTo(coords[2].x, coords[2].y);
            ctx.lineTo(coords[3].x, coords[3].y);
            ctx.closePath();

            ctx.lineWidth = 2;           // Adjust thickness
            ctx.strokeStyle = '#EA4335';   // Change to your preferred color (e.g., Canva Teal)
    
            ctx.stroke();
            ctx.restore();
        });
      },
    
      adjustZoom(delta) {
        const newZoom = this.currentZoom + delta;
        if(newZoom < 0.1 || newZoom > 3) return;

        this.currentZoom = newZoom;
        document.getElementById('zoom-level').innerText = Math.round(this.currentZoom * 100) + '%';
        const wrapper = document.querySelector('.canvas-container-wrapper');
        wrapper.style.transform = `scale(${this.currentZoom})`;
        const contextMenu = document.getElementById('context-menu');
        if (contextMenu) {
            // Preserve the translateX(-50%) for centering while applying zoom scale correction
            contextMenu.style.transform = `translateX(-50%) scale(${1 / this.currentZoom})`;
            // Use top center for proper centering behavior
            contextMenu.style.transformOrigin = 'top center'; 
        }
      },
        
      setBgColor(color) {
        canvas.setBackgroundColor(color, canvas.renderAll.bind(canvas));
        canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
    },
    
      setGradient(c1, c2) {
        const grad = new fabric.Gradient({
          type: 'linear', coords: { x1: 0, y1: 0, x2: canvas.width, y2: canvas.height },
          colorStops: [{ offset: 0, color: c1 }, { offset: 1, color: c2 }]
        });
        canvas.setBackgroundColor(grad, canvas.renderAll.bind(canvas));
        canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
    },
      
      setTexture(cssUrl) {
          const url = cssUrl.replace(/url\(['"]?(.*?)['"]?\)/i, '$1');
          // Show loading shimmer
          const wrapper = document.querySelector('.canvas-container-wrapper');
          UI.toggleShimmer(wrapper, true);
          
          fabric.Image.fromURL(url, (img) => {
            const scale = Math.max(canvas.width/img.width, canvas.height/img.height);
            img.set({ originX:'center', originY:'center', left:canvas.width/2, top:canvas.height/2, scaleX:scale, scaleY:scale });
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            canvas.setBackgroundColor(null, null);
            // Hide loading shimmer when complete
            UI.toggleShimmer(wrapper, false);
          }, { crossOrigin: 'anonymous' });
      },    
    
      updateContextMenu() {
        const el = document.getElementById('context-menu');
        const dropdown = document.getElementById('ctx-dropdown-menu');
        const active = canvas.getActiveObject();
    
        if (!active) {
            el.classList.add('hidden');
            dropdown.classList.remove('show');
            return;
        }
    
        const btnReplace = document.getElementById('btn-replace-img');
        const btnFit = document.getElementById('btn-fit-canvas');
        const btnFill = document.getElementById('btn-fill-canvas');
        const mediaDivider = document.getElementById('media-divider');
        const isMedia = active.type === 'image' || active.asset_type === 'image' || active.asset_type === 'video';
        const displayVal = isMedia ? 'flex' : 'none';
        btnReplace.style.display = displayVal;
        btnFit.style.display = displayVal;
        btnFill.style.display = displayVal;
        mediaDivider.style.display = displayVal;
        el.classList.remove('hidden');
        const bound = active.getBoundingRect();
        const zoom = this.currentZoom || 1;
        
        // Center the menu horizontally over the object's center using left + transform
        const objectCenterX = bound.left + (bound.width / 2);
        
        // The rotation handle is typically ~40px above the selection at zoom 1.0
        // We need a consistent visual offset that accounts for the menu being inverse-scaled
        // Base offset that provides enough space for rotation handle + padding
        const rotationHandleOffset = 50; // Base offset in canvas pixels
        const menuHeight = 50; // Approximate menu height after inverse scaling
        
        // Scale the offset inversely - at higher zoom, less offset is needed in canvas coords
        // because the menu appears larger (inverse scaled), at lower zoom, more offset is needed
        const scaledOffset = (rotationHandleOffset + menuHeight) / zoom;
        
        const menuY = Math.max(10 / zoom, bound.top - scaledOffset);
        
        // Apply zoom-aware transform for proper centering and scaling
        el.style.transform = `translateX(-50%) scale(${1 / zoom})`;
        el.style.transformOrigin = 'top center';
        el.style.left = objectCenterX + 'px';
        el.style.top = menuY + 'px';

        const isLocked = active.lockMovementX;
        const lockText = document.getElementById('lock-text');
        const lockIconContainer = document.getElementById('lock-icon-container');
        
        lockText.innerText = isLocked ? "Unlock Object" : "Lock Object";

        lockIconContainer.innerHTML = isLocked 
            ? '<i data-lucide="lock-open" class="w-5 h-5"></i>' 
            : '<i data-lucide="lock" class="w-5 h-5"></i>';

        const btnRemoveBg = document.getElementById('btn-remove-bg');
        const txtCtxBg = document.getElementById('txt-ctx-bg');
        const iconCtxBg = document.querySelector('#btn-remove-bg i');

        // Show button if it is an image
        if (isMedia && active.type !== 'video' && active.asset_type !== 'video') {
          btnRemoveBg.style.display = 'flex';
          const iconContainer = btnRemoveBg.querySelector('.icon-container');
          const txtCtxBg = document.getElementById('txt-ctx-bg');
      
          if (active.isBgRemoved) {
              txtCtxBg.innerText = "Revert Original";
              iconContainer.innerHTML = '<i data-lucide="rotate-ccw" class="w-5 h-5"></i>';
          } else {
              txtCtxBg.innerText = "Remove Bg";
              iconContainer.innerHTML = '<i data-lucide="eraser" class="w-5 h-5"></i>';
          }
          
      } else {
          btnRemoveBg.style.display = 'none';
      }
      lucide.createIcons();
    },
    
      toggleContextMenu() {
        const dropdown = document.getElementById('ctx-dropdown-menu');
        dropdown.classList.toggle('show');
      },

      toggleOuterContextMenu(){
        const ctxOutMenu = document.getElementById('context-menu');
        if (ctxOutMenu) ctxOutMenu.classList.add('hidden');
      },

      initKeyboard() {
        document.addEventListener('keydown', (e) => {
            // 1. Safety Check: Don't trigger if user is typing in an input field (HTML)
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // 2. Safety Check: Don't trigger if user is editing text on Canvas
            const active = canvas.getActiveObject();
            if (active && active.isEditing) return;

            const key = e.key;
            const cmd = e.ctrlKey || e.metaKey; // Support Ctrl (Win) and Cmd (Mac)

            // DELETE / BACKSPACE
            if (key === 'Delete' || key === 'Backspace') {
                e.preventDefault();
                this.deleteSelected();
            }

            // UNDO (Ctrl+Z)
            if (cmd && !e.shiftKey && key.toLowerCase() === 'z') {
                e.preventDefault();
                History.undo();
            }

            // REDO (Ctrl+Y or Ctrl+Shift+Z)
            if ((cmd && !e.shiftKey && key.toLowerCase() === 'y') || 
                (cmd && e.shiftKey && key.toLowerCase() === 'z')) {
                e.preventDefault();
                History.redo();
            }

            // COPY (Ctrl+C)
            if (cmd && key.toLowerCase() === 'c') {
                e.preventDefault();
                this.copy();
            }

            // PASTE (Ctrl+V)
            if (cmd && key.toLowerCase() === 'v') {
                e.preventDefault();
                this.paste();
            }
        });
    },

      copy() {
          const active = canvas.getActiveObject();
          if (!active) return;

          // Clone the object to store in clipboard
          active.clone((cloned) => {
              this._clipboard = cloned;
          });
      },

      paste() {
          if (!this._clipboard) return;
          this._clipboard.clone((clonedObj) => {
              canvas.discardActiveObject();

              clonedObj.set({
                  left: clonedObj.left + 20, // Offset slightly
                  top: clonedObj.top + 20,
                  evented: true
              });

              if (clonedObj.type === 'activeSelection') {
                  clonedObj.canvas = canvas;
                  clonedObj.forEachObject((obj) => {
                      canvas.add(obj);
                  });
                  clonedObj.setCoords();
              } else {
                  canvas.add(clonedObj);
              }
              this._clipboard.top += 20;
              this._clipboard.left += 20;

              canvas.setActiveObject(clonedObj);
              canvas.requestRenderAll();
              History.save(); // Add to undo stack
              UI.refreshLayers(); // Update layer list
          });
      },
      
      fitToCanvas() {
        const active = canvas.getActiveObject();
        if (!active) return;
        
        const scaleX = canvas.width / active.width;
        const scaleY = canvas.height / active.height;
        const scale = Math.min(scaleX, scaleY); // Fit matches the smallest dimension
        
        active.set({
            scaleX: scale,
            scaleY: scale,
            left: canvas.width / 2,
            top: canvas.height / 2,
            originX: 'center',
            originY: 'center'
        });
        
        active.setCoords();
        canvas.requestRenderAll();
        this.toggleContextMenu(); // Close menu
        History.save();
      },

      fillCanvas() {
        const active = canvas.getActiveObject();
        if (!active) return;

        const scaleX = canvas.width / active.width;
        const scaleY = canvas.height / active.height;
        const scale = Math.max(scaleX, scaleY); // Fill matches the largest dimension (zoom in)

        active.set({
            scaleX: scale,
            scaleY: scale,
            left: canvas.width / 2,
            top: canvas.height / 2,
            originX: 'center',
            originY: 'center'
        });

        active.setCoords();
        canvas.requestRenderAll();
        this.toggleOuterContextMenu();
        this.toggleContextMenu(); 
        History.save();
      },

      openReplaceMenu() {
          const active = canvas.getActiveObject();
          if(!active) return;
          this.targetForReplace = active;

          const popover = document.getElementById('replace-popover');
          const ctxMenu = document.getElementById('context-menu');
          const rect = ctxMenu.getBoundingClientRect();
          
          popover.style.display = 'block';
          popover.style.left = (rect.left + 20) + 'px';
          popover.style.top = (rect.top + 20) + 'px';
          this.toggleContextMenu();
      },

      replaceFromUrl(url) {
        document.body.style.cursor = 'wait';

        fetch(url)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], "stock_image.jpg", { type: "image/jpeg" });
                const fakeInput = { files: [file], value: '' };
                this.handleImageReplace(fakeInput);
                document.getElementById('replace-popover').style.display = 'none';
                document.body.style.cursor = 'default';
            })
            .catch(err => {
                console.error(err);
                alert("Could not load image (CORS issue?). Try uploading a file.");
                document.body.style.cursor = 'default';
            });
      },

      toggleImageRounding(isChecked) {
        const active = canvas.getActiveObject();
        if (!active || active.type !== 'image') return;

        const controls = document.getElementById('img-radius-slider');

        if (isChecked) {
            controls.style.opacity = "1";
            controls.style.pointerEvents = "auto";
            
            // Apply initial radius if none exists
            const currentVal = parseInt(document.getElementById('prop-imgRadius').value) || 20;
            this.updateImageRadius(currentVal);
        } else {
            controls.style.opacity = "0.5";
            controls.style.pointerEvents = "none";
            
            // Remove Clip Path
            active.set('clipPath', null);
            active.set('dirty', true);
            canvas.requestRenderAll();
        }
        History.save();
      },

      updateImageRadius(val) {
        const active = canvas.getActiveObject();
        if (!active || active.type !== 'image') return;
        active.customCornerRadius = val;
        const clipRect = new fabric.Rect({
            width: active.width,
            height: active.height,
            rx: val,
            ry: val,
            originX: 'center',
            originY: 'center'
        });

        active.set('clipPath', clipRect);
        active.set('dirty', true);
        canvas.requestRenderAll();
      },
    
      duplicate() {
        const active = canvas.getActiveObject();
        if (!active) return;
    
        active.clone((cloned) => {
          canvas.discardActiveObject();
          cloned.set({
            left: cloned.left + 20,
            top: cloned.top + 20,
            evented: true
          });
          
          if (cloned.type === 'activeSelection') {
            cloned.canvas = canvas;
            cloned.forEachObject((obj) => {
              canvas.add(obj);
            });
            cloned.setCoords();
          } else {
            canvas.add(cloned);
          }
          
          canvas.setActiveObject(cloned);
          this.toggleContextMenu();
          canvas.requestRenderAll();
          UI.refreshLayers();
        });
      },
    
      toggleLock() {
        const active = canvas.getActiveObject();
        if (!active) return;
    
        const isLocked = !active.lockMovementX;
        
        active.set({
            lockMovementX: isLocked,
            lockMovementY: isLocked,
            lockRotation: isLocked,
            lockScalingX: isLocked,
            lockScalingY: isLocked
        });
        active.borderColor = isLocked ? '#00000' : '#EA4335';
        
        this.toggleContextMenu(); 
        canvas.requestRenderAll();
        this.updateContextMenu(); 
      },
      
      moveLayer(dir) {
        const active = canvas.getActiveObject();
    
        if (!active) {
           console.warn("Move Layer failed: No object selected");
           return;
        }
    
        console.log("Moving layer:", dir);
    
        if (dir === 'up') {
            active.bringForward();
        } else if (dir === 'down') {
            active.sendBackwards();
        } else if (dir === 'toFront') {
            active.bringToFront();
        } else if (dir === 'toBack') {
            active.sendToBack();
        }
    
        canvas.fire('object:modified'); 
        canvas.requestRenderAll();
    
        if (UI && UI.refreshLayers) UI.refreshLayers();
    
        const dropdown = document.getElementById('ctx-dropdown-menu');
        if (dropdown) dropdown.classList.remove('show');
    },
    
    resizeCanvas(format) {
      if(format === "1:1") format = "ig_square";
      if(format === "9:16") format = "ig_story";
      if(format === "16:9") format = "youtube";

      // CHANGED: Use ACTUAL high-quality dimensions
      let w, h;

      switch(format) {
        case "ig_tall":    w = 1080; h = 1440; break; // 3:4 New standard
        case "ig_portrait": w = 1080; h = 1350; break; // 4:5
        case "ig_square":  
        case "threads":    w = 1080; h = 1080; break;
        case "snapchat":
        case "snapchat_spotlight":
        case "ig_story":
        case "tiktok": w = 1080; h = 1920; break
        case "youtube":    w = 1920; h = 1080; break; // High-def standard
        case "facebook":   w = 1200; h = 630;  break;
        case "linkedin":   w = 1200; h = 627;  break;
        case "x":          w = 1200; h = 675;  break;
        default:           w = 1080; h = 1080; break;
      }

      PREVIEW_W = w;
      PREVIEW_H = h;

      // 1. Update the UI Selection
      document.querySelectorAll('.resize-item').forEach(el => el.classList.remove('selected'));
      const activeEl = document.querySelector(`.resize-item[data-format="${format}"]`);
      if(activeEl) activeEl.classList.add('selected');

      // 2. Update the Dimension Text Display
      const dimView = document.getElementById('Dimn-view');
      if(dimView) {
        dimView.innerText = `${w} x ${h}px`;
      }

      // 3. Update Fabric Canvas Dimensions to Full Quality
      canvas.setDimensions({ width: w, height: h });
      
      // 4. Update Wrapper size to match actual canvas size
      const wrapper = document.querySelector('.canvas-container-wrapper');
      wrapper.style.width = w + "px";
      wrapper.style.height = h + "px";

      // 5. Adjust Background Image scale-to-fill
      if(canvas.backgroundImage) {
         const img = canvas.backgroundImage;
         const scale = Math.max(w/img.width, h/img.height);
         img.set({ 
           originX:'center', 
           originY:'center', 
           left:w/2, 
           top:h/2, 
           scaleX:scale, 
           scaleY:scale 
         });
      }

      // 6. AUTO-FIT: Calculate Zoom to fit the screen
      // Get the container size (the gray area around the canvas)
      const container = document.querySelector('.flex-1.relative'); 
      const pad = 60; // Padding around the canvas
      
      if (container) {
          const availableW = container.clientWidth - pad;
          const availableH = container.clientHeight - pad;
          
          // Calculate scale needed to fit
          const scaleW = availableW / w;
          const scaleH = availableH / h;
          
          // Use the smaller scale so it fits entirely
          let startScale = Math.min(scaleW, scaleH);
          
          // Cap it at 1 (don't zoom in if screen is huge)
          if(startScale > 1) startScale = 1; 

          this.currentZoom = startScale;
          
          // Apply the CSS Transform
          wrapper.style.transform = `scale(${this.currentZoom})`;
          document.getElementById('zoom-level').innerText = Math.round(this.currentZoom * 100) + '%';
          
          // Fix context menu scale relative to new zoom
          const contextMenu = document.getElementById('context-menu');
          if (contextMenu) {
              contextMenu.style.transform = `scale(${1 / this.currentZoom})`;
          }
      }

      canvas.requestRenderAll();
    },

      async handleUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        e.target.value = '';
      
        const isVideo = file.type.startsWith('video');
      
        const fd = new FormData();
        fd.append('file', file);
      
        const res = await fetch('/canva/upload', {
          method: 'POST',
          body: fd
        });
      
        if (!res.ok) {
          alert('Upload failed');
          return;
        }
      
        const data = await res.json();
    
        const serverId = data.file_id;
    
        const fileUrl = URL.createObjectURL(file);
      
        if (isVideo) {
          await Editor.addVideo(fileUrl, serverId);
        } else {
          Editor.addImage(fileUrl, serverId);
        }
      
        UI.refreshLayers();
      },
      
      addImage(url, id) {
        const wrapper = document.querySelector('.canvas-container-wrapper');
        UI.toggleShimmer(wrapper, true);

        fabric.Image.fromURL(url, (img) => {
            img.scaleToWidth(PREVIEW_W * 0.5);
            img.set({ 
                left: PREVIEW_W/2, top: PREVIEW_H/2, 
                originX: 'center', originY: 'center',
                asset_type: 'image', server_id: id 
            });
            canvas.add(img);
            canvas.setActiveObject(img);
            UI.refreshLayers();
            UI.toggleShimmer(wrapper, false); // End Shimmer
        },{ crossOrigin: 'anonymous' });
      },
    
      addVideo(url, id) {
        return new Promise((resolve) => {
          const vid = document.createElement('video');
          vid.src = url;
          vid.crossOrigin = "anonymous";
          vid.muted = true;
          vid.loop = true;
          vid.playsInline = true;
          
          document.getElementById('assets-container').appendChild(vid);
    
          vid.onloadedmetadata = () => {
            vid.width = vid.videoWidth;
            vid.height = vid.videoHeight;
            vid.play();
    
            const fVid = new fabric.Image(vid, {
              left: PREVIEW_W/2, top: PREVIEW_H/2,
              originX: 'center', originY: 'center',
              objectCaching: false,
              asset_type: 'video', server_id: id
            });
            
            if (fVid.width > PREVIEW_W) fVid.scaleToWidth(PREVIEW_W * 0.7);
            
            canvas.add(fVid);
            canvas.setActiveObject(fVid);
            UI.refreshLayers();
            resolve();
          };
          
          vid.onerror = (e) => {
              console.error("Video load error", e);
              resolve(); 
          };
        });
      },
    
      addText(text = 'Double click to edit', fontSize = 40, fontWeight = '800') {
        let bgColor = canvas.backgroundColor;
        let textColor = '#000000'; 
        if (typeof bgColor === 'string') {
            textColor = getContrastColor(bgColor);
        } else if (bgColor && bgColor.colorStops) {
            textColor = getContrastColor(bgColor.colorStops[0].color);
        }
      
        const t = new fabric.Textbox(text, {
          left: PREVIEW_W/2,
          top: PREVIEW_H/2,
          originX: 'center',
          originY: 'center',
          width: 250,
          fontSize: fontSize,
          fontFamily: 'Inter',
          fontWeight: String(fontWeight),
          textAlign: 'center',
          fill: textColor, 
          charSpacing: 0,
          lineHeight: 1.2,
          objectCaching: false 
        });
      
        canvas.add(t);
        canvas.setActiveObject(t);
        UI.refreshLayers();
        UI.syncPanel(t);
      },
    
      updateProp(prop, value) {
        const active = canvas.getActiveObject();
        if (!active) return;
    
        if (prop === 'padding') {
            active.set('padding', value);
            active.setCoords(); 
        } else {
            active.set(prop, value);
        }
        active.set('dirty', true);
        
        canvas.requestRenderAll();
      },
    
      adjustFontSize(delta) {
        const active = canvas.getActiveObject();
        if (active && active.type === 'textbox') {
          const newSize = (active.fontSize || 40) + delta;
          active.set('fontSize', Math.max(5, newSize));
          document.getElementById('display-fontSize').innerText = active.fontSize;
          // Also update quick toolbar font size display
          const qtFontSize = document.getElementById('qt-font-size');
          if (qtFontSize) qtFontSize.innerText = active.fontSize;
          canvas.requestRenderAll();
        }
      },
    
      toggleStyle(style) {
        const active = canvas.getActiveObject();
        if (!active || active.type !== 'textbox') return;
    
        if (style === 'bold') {
          const isBold = active.fontWeight === 'bold' || parseInt(active.fontWeight) >= 600;
          active.set('fontWeight', isBold ? '400' : '800');
        }
        
        if (style === 'italic') {
          active.set('fontStyle', active.fontStyle === 'italic' ? 'normal' : 'italic');
        }
        if (style === 'underline') {
          active.set('underline', !active.underline);
        }
        if (style === 'linethrough') {
          active.set('linethrough', !active.linethrough);
        }
        
        canvas.requestRenderAll();
        UI.syncPanel(active);
        
        // Also sync quick toolbar button states
        if (typeof QuickToolbar !== 'undefined') {
          QuickToolbar.syncTextToolbar(active);
        }
      },
    
      toggleCase() {
        const active = canvas.getActiveObject();
        if (!active || active.type !== 'textbox') return;
        if (active.text === active.text.toUpperCase()) {
          active.text = active.text.toLowerCase();
        } else {
          active.text = active.text.toUpperCase();
        }
        canvas.requestRenderAll();
      },
          
      toggleShadow(isChecked) {
        const inputs = document.getElementById('shadow-inputs');
        if(isChecked) {
           inputs.style.opacity = "1";
           inputs.style.pointerEvents = "auto";
           this.updateShadow(); // Apply values from sliders
        } else {
           inputs.style.opacity = "0.5";
           inputs.style.pointerEvents = "none";
           const active = canvas.getActiveObject();
           if(active) {
               active.set('shadow', null);
               canvas.requestRenderAll();
               History.save();
           }
        }
     },
    
      updateShadow() {
        const active = canvas.getActiveObject();
        if (!active) return;
    
        // Check if toggle is on
        const isChecked = document.getElementById('check-shadow').checked;
        if (!isChecked) return;
    
        const color = document.getElementById('prop-shadowColor').value;
        const blur = parseInt(document.getElementById('prop-shadowBlur').value, 10);
        const x = parseInt(document.getElementById('prop-shadowOfstX').value, 10);
        const y = parseInt(document.getElementById('prop-shadowOfstY').value, 10);
    
        active.set('shadow', new fabric.Shadow({
            color: color,
            blur: blur,
            offsetX: x,
            offsetY: y
        }));
        
        canvas.requestRenderAll();
      },
       
      align(pos) {
        const active = canvas.getActiveObject();
        if (!active) return;
    
        switch(pos) {
          case 'center': active.centerH(); break;
          case 'middle': active.centerV(); break;
          case 'left': active.set({ left: 0, originX: 'left' }); break;
          case 'right': active.set({ left: canvas.width, originX: 'right' }); break;
          case 'top': active.set({ top: 0, originY: 'top' }); break;
          case 'bottom': active.set({ top: canvas.height, originY: 'bottom' }); break;
        }
        active.setCoords();
        canvas.requestRenderAll();
      },
    
      moveLayer(dir) {
        const active = canvas.getActiveObject();
        if (!active) return;

        if (dir === 'up') {
            active.bringForward();
        } else if (dir === 'down') {
            active.sendBackwards();
        } else if (dir === 'toFront') {
            active.bringToFront();
        } else if (dir === 'toBack') {
            active.sendToBack();
        }

        canvas.fire('object:modified');
        canvas.requestRenderAll();

        UI.refreshLayers();
    
        const dropdown = document.getElementById('ctx-dropdown-menu');
        if (dropdown) dropdown.classList.remove('show');
      },
    
      deleteSelected() {
        const active = canvas.getActiveObject();
        if (active) {
          canvas.remove(active);
          canvas.discardActiveObject();
          UI.refreshLayers();
        }
      },
    
      onSelection() {
        const active = canvas.getActiveObject();
        if (active) {
            UI.showView('properties'); 
            UI.syncPanel(active);     
        }
    },
      
      onDeselection() {
        UI.showView('background'); // Auto-switch back to background
      },

      _enforceProportionalScaling(obj) {
    // 1. Force uniform scaling logic
    obj.set({
        uniformScaling: true,
        lockUniScaling: true, // Prevents skewing
        centeredScaling: true,
        strokeUniform: true //  Keeps borders same thickness when resizing
    });

    // 2. Hide side controls (Middle Top, Bottom, Left, Right)
    // We use setControlVisible which is more robust than setControlsVisibility for modified prototypes
    const hiddenControls = ['mt', 'mb', 'ml', 'mr'];
    hiddenControls.forEach(key => {
        obj.setControlVisible(key, false);
    });

    // 3. Ensure corners and rotation are visible
    const visibleControls = ['bl', 'br', 'tl', 'tr', 'mtr'];
    visibleControls.forEach(key => {
        obj.setControlVisible(key, true);
    });
    
    // 4. Force update
    obj.setCoords();
},

    
addShape(type) {
    let shape;
    const opts = {
        left: PREVIEW_W/2, 
        top: PREVIEW_H/2, 
        originX: 'center', 
        originY: 'center',
        fill: '#0099ff',
        asset_type: 'shape'
    };

    // --- 1. PRIMITIVES (Fabric Built-ins) ---
    if (type === 'circle') {
        shape = new fabric.Circle({ ...opts, radius: 50 });
    } 
    else if (type === 'rect') {
        shape = new fabric.Rect({ ...opts, width: 100, height: 100 });
    } 
    else if (type === 'triangle') {
        shape = new fabric.Triangle({ ...opts, width: 100, height: 100 });
    } 
    else if (type === 'pill') {
        shape = new fabric.Rect({ ...opts, width: 100, height: 50, rx: 25, ry: 25 });
    } 
    else if (type === 'donut') {
        shape = new fabric.Circle({ ...opts, radius: 50, stroke: '#0099ff', strokeWidth: 20, fill: 'transparent' });
    } 
    else if (type === 'parallelogram') {
         shape = new fabric.Rect({ ...opts, width: 100, height: 60, skewX: -20 });
    } 
    else if (type === 'diamond') {
         shape = new fabric.Rect({ ...opts, width: 70, height: 70, angle: 45 });
    } 


    else if (type === 'pentagon') {
        shape = new fabric.Path(SHAPE_LIBRARY.pentagon, opts);
        shape.scaleToWidth(100); 
    }
    else if (type === 'hexagon') {
        shape = new fabric.Path(SHAPE_LIBRARY.hexagon, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'octagon') {
        shape = new fabric.Path(SHAPE_LIBRARY.octagon, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'star5') {
        shape = new fabric.Path(SHAPE_LIBRARY.star5, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'star_burst') {
        shape = new fabric.Path(SHAPE_LIBRARY.star_burst, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'arrow_right') {
        shape = new fabric.Path(SHAPE_LIBRARY.arrow_right, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'arrow_left') {
        shape = new fabric.Path(SHAPE_LIBRARY.arrow_left, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'chevron') {
        shape = new fabric.Path(SHAPE_LIBRARY.chevron, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'cross') {
        shape = new fabric.Path(SHAPE_LIBRARY.cross, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'cloud') {
        shape = new fabric.Path(SHAPE_LIBRARY.cloud, opts);
        shape.scaleToWidth(120); // Clouds look better slightly wider
    }
    else if (type === 'heart') {
        shape = new fabric.Path(SHAPE_LIBRARY.heart, opts);
        shape.scaleToWidth(100);
    }
    else if (type === 'speech_bubble') {
        shape = new fabric.Path(SHAPE_LIBRARY.speech_bubble, opts);
        shape.scaleToWidth(120);
    }
    else if (type === 'trapezoid') {
        shape = new fabric.Path(SHAPE_LIBRARY.trapezoid, opts);
        shape.scaleToWidth(120);
    }

    if (shape) {
        this._enforceProportionalScaling(shape);

        canvas.add(shape);
        canvas.setActiveObject(shape);
        
        UI.refreshLayers();
        UI.showView('properties');
        
        canvas.requestRenderAll();
    }
},

addIcon(type) {
    const pathString = ICON_LIBRARY[type];
    if (!pathString) return;

    const path = new fabric.Path(pathString);
    path.set({
        scaleX: 0.5, scaleY: 0.5,
        left: PREVIEW_W/2, top: PREVIEW_H/2,
        originX: 'center', originY: 'center',
        fill: '#333333',
        iconType: type, 
        type: 'path',
        asset_type: 'icon'
    });
    
    // FIX: APPLY LOCK
    this._enforceProportionalScaling(path);

    canvas.add(path);
    canvas.setActiveObject(path);
    UI.refreshLayers();
},
      isEditingFrame: false,
      activeFrameObj: null,
    
      addFrame(type) {
    const placeholderUrl = 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=500';
    
    fabric.Image.fromURL(placeholderUrl, (img) => {
        img.scaleToWidth(300);
        
        const opts = {
            left: PREVIEW_W/2, 
            top: PREVIEW_H/2,
            originX: 'center', originY: 'center',
            asset_type: 'frame',
            isFrame: true,
            perPixelTargetFind: true,
            objectCaching: false 
        };
        img.set(opts);

        // CREATE CLIP PATH
        let clipPath;

        if (type === 'circle') {
            clipPath = new fabric.Circle({ radius: 150, originX: 'center', originY: 'center', absolutePositioned: true });
        } 
        else if (type === 'rect') {
            clipPath = new fabric.Rect({ width: 300, height: 300, originX: 'center', originY: 'center', absolutePositioned: true });
        }
        else if (type === 'rounded') {
            clipPath = new fabric.Rect({ width: 300, height: 300, rx: 20, ry: 20, originX: 'center', originY: 'center', absolutePositioned: true });
        }
        else if (type === 'diamond') {
             clipPath = new fabric.Rect({ width: 220, height: 220, angle: 45, originX: 'center', originY: 'center', absolutePositioned: true });
        }
        else if (type === 'polaroid') {
             clipPath = new fabric.Rect({ width: 250, height: 250, originX: 'center', originY: 'center', absolutePositioned: true });
        }
        else if (type === 'pill') {
             clipPath = new fabric.Rect({ width: 300, height: 150, rx: 75, ry: 75, originX: 'center', originY: 'center', absolutePositioned: true });
        }
        else if (FRAME_LIBRARY[type]) {
            clipPath = new fabric.Path(FRAME_LIBRARY[type], {
                originX: 'center', originY: 'center', absolutePositioned: true
            });
            const dims = clipPath.getBoundingRect();
            const scale = 300 / Math.max(dims.width, dims.height);
            clipPath.scale(scale);
        }

        if(clipPath) {
            clipPath.left = img.left;
            clipPath.top = img.top;
            img.clipPath = clipPath;
            
            this._bindFrameEvents(img);
            

            this._enforceProportionalScaling(img);

            canvas.add(img);
            canvas.setActiveObject(img);
            UI.refreshLayers();
        }

    }, { crossOrigin: 'anonymous' });
},
      _bindFrameEvents(obj) {
        obj.off('moving');
        obj.off('scaling');
        obj.off('rotating');

        const sync = () => {
            if(this.isEditingFrame) return;
            const clip = obj.clipPath;
            if(!clip) return;

            clip.left = obj.left;
            clip.top = obj.top;
            clip.scaleX = obj.scaleX;
            clip.scaleY = obj.scaleY;
            clip.angle = obj.angle;
            clip.setCoords(); 
        };

        obj.on('moving', sync);
        obj.on('scaling', sync);
        obj.on('rotating', sync);

        sync();
      },
    
      enterFrameEditMode(obj) {
        if (this.isEditingFrame) return;
        this.isEditingFrame = true;
        this.activeFrameObj = obj;
        obj.set('opacity', 0.7); 
        canvas.requestRenderAll();
      },   
      
      exitFrameEditMode() {
        if (!this.isEditingFrame || !this.activeFrameObj) return;
        const obj = this.activeFrameObj;
        obj.set('opacity', 1);
        this._updateFrameOffset(obj);
        this.isEditingFrame = false;
        this.activeFrameObj = null;
        canvas.requestRenderAll();
      },

      _updateFrameOffset(obj) {
        const clip = obj.clipPath;
        obj.frameOffsetX = clip.left - obj.left;
        obj.frameOffsetY = clip.top - obj.top;
        
        obj.off('moving');
        obj.on('moving', () => {
            clip.left = obj.left + (obj.frameOffsetX || 0);
            clip.top = obj.top + (obj.frameOffsetY || 0);
            clip.setCoords();
        });
        
        obj.on('scaling', () => {
            clip.scaleX = obj.scaleX;
            clip.scaleY = obj.scaleY;
            clip.left = obj.left + (obj.frameOffsetX || 0);
            clip.top = obj.top + (obj.frameOffsetY || 0);
            clip.setCoords();
        });
      },
    
    
      triggerImageReplace() {
          document.getElementById('replaceImgInput').click();
          this.toggleContextMenu();
      },
    
      async handleImageReplace(input) {
        const file = input.files[0];
        if (!file) return;
        input.value = '';
        const activeObj = this.targetForReplace || canvas.getActiveObject();
        this.targetForReplace = null;
    
        if (!activeObj) {
            alert("No object selected to replace.");
            return;
        }
    
        const fd = new FormData();
        fd.append('file', file);
    
        try {
            const res = await fetch('/canva/upload', { method: 'POST', body: fd });
            if (!res.ok) throw new Error('Upload failed');
            
            const data = await res.json();
            const serverId = data.file_id;
            const newUrl = URL.createObjectURL(file); // Instant preview
            if (activeObj.isFrame) {
                const oldClipPath = activeObj.clipPath;
                const frameLeft = oldClipPath.left;
                const frameTop = oldClipPath.top;
                const frameWidth = oldClipPath.width * oldClipPath.scaleX;
    
                activeObj.setSrc(newUrl, () => {
                    const scale = (frameWidth / activeObj.width); 
                    
                    activeObj.set({
                        scaleX: scale,
                        scaleY: scale,
                        left: frameLeft,
                        top: frameTop,
                        server_id: serverId 
                    });
                    
                    activeObj.clipPath = oldClipPath;
                    activeObj.frameOffsetX = 0;
                    activeObj.frameOffsetY = 0;
                    
                    this._bindFrameEvents(activeObj);
                    canvas.requestRenderAll();
                    History.save(); // Save Undo state
                }, { crossOrigin: 'anonymous' });
            } 
            else {
                const oldWidth = activeObj.width * activeObj.scaleX;
                const oldHeight = activeObj.height * activeObj.scaleY;
                const oldLeft = activeObj.left;
                const oldTop = activeObj.top;
                const oldAngle = activeObj.angle;
    
                activeObj.setSrc(newUrl, () => {
                    const scale = oldWidth / activeObj.width;
    
                    activeObj.set({
                        scaleX: scale,
                        scaleY: scale,
                        left: oldLeft,
                        top: oldTop,
                        angle: oldAngle,
                        server_id: serverId
                    });
                    if(activeObj.customCornerRadius) {
                        this.updateImageRadius(activeObj.customCornerRadius);
                    }
    
                    canvas.requestRenderAll();
                    History.save(); 
                }, { crossOrigin: 'anonymous' });
            }
        } catch (err) {
            alert("Error uploading image: " + err.message);
            console.error(err);
        }
        finally{
          document.getElementById('replace-popover').style.display = 'none';
        }
    },
      
      async toggleBackgroundRemoval() {
        const active = canvas.getActiveObject();
        if (!active || (active.type !== 'image' && active.asset_type !== 'image')) return;
    
        // 1. Close context menu immediately
        const ctxMenu = document.getElementById('context-menu');
        if (ctxMenu) ctxMenu.classList.add('hidden');
    
        // 2. Start Shimmer Animation on the canvas wrapper
        const wrapper = document.querySelector('.canvas-container-wrapper');
        UI.toggleShimmer(wrapper, true);
    
        // A. REVERT MODE
        if (active.isBgRemoved && active.originalSrc) {
            active.setSrc(active.originalSrc, (img) => {
                active.isBgRemoved = false;
                active.set({
                    scaleX: active.scaleX,
                    scaleY: active.scaleY
                });
                
                canvas.requestRenderAll();
                History.save();
                UI.toggleShimmer(wrapper, false); // Stop Shimmer
                UI.syncPanel(active);
                this.updateContextMenu();
            }, { crossOrigin: 'anonymous' });
            return;
        }
    
        // B. REMOVE MODE
        if (!active.originalSrc) {
            active.originalSrc = active.getSrc();
        }
    
        document.body.style.cursor = 'wait';
    
        try {
            const src = active.originalSrc;
            const blob = await fetch(src).then(r => r.blob());
            
            const fd = new FormData();
            fd.append('file', blob, 'image.png');
    
            const res = await fetch('/remove-bg', {
                method: 'POST',
                body: fd
            });
    
            if (!res.ok) throw new Error("Failed to remove background");
    
            const data = await res.json();
            const newUrl = data.url;
    
            active.setSrc(newUrl, (img) => {
                active.set({
                    server_id: data.file_id,
                    isBgRemoved: true
                });
                
                canvas.requestRenderAll();
                History.save();
                UI.toggleShimmer(wrapper, false); // Stop Shimmer
                UI.syncPanel(active);
                this.updateContextMenu();
            }, { crossOrigin: 'anonymous' });
    
        } catch (err) {
            UI.toggleShimmer(wrapper, false); // Stop Shimmer on error
            console.error(err);
            alert("Error removing background: " + err.message);
        } finally {
            document.body.style.cursor = 'default';
        }
    },

      async generateAIImage() {
        const promptInput = document.getElementById('ai-prompt');
        const modelInput = document.getElementById('ai-model');
        const styleInput = document.getElementById('ai-style'); // Get style
        const btn = document.getElementById('btn-generate');
        const btnText = btn.querySelector('span:not(.icon-container)');
        
        const prompt = promptInput.value.trim();
        const model = modelInput.value;
        const style = styleInput.value;

        if (!prompt) return alert("Please enter a prompt description");

        // UI Loading State
        const originalText = btnText.innerText;
        btnText.innerText = "Generating...";
        btn.disabled = true;
        btn.style.opacity = "0.7";
        const wrapper = document.querySelector('.canvas-container-wrapper');
        UI.toggleShimmer(wrapper, true);

        try {
            // Call updated API endpoint
            const res = await fetch('/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt, model: model, style: style })
            });

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.detail || "Generation failed");
            }
            const data = await res.json();
            this.addImage(data.url, data.file_id);
            
        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
        } finally {
            // Reset UI
            btnText.innerText = originalText;
            btn.disabled = false;
            btn.style.opacity = "1";
            UI.toggleShimmer(wrapper, false);
        }
      },

      async editImageWithAI() {
        const active = canvas.getActiveObject();
        if (!active || (active.type !== 'image' && active.asset_type !== 'image')) return;

        const promptInput = document.getElementById('ai-edit-prompt');
        const styleInput = document.getElementById('ai-edit-style');
        const modelInput = document.getElementById('ai-edit-model');
        const btn = document.getElementById('btn-edit-generate');
        const btnText = btn.querySelector('span:not(.icon-container)');

        const prompt = promptInput.value.trim();
        if (!prompt) return alert("Tell the AI how to change the image.");

        // 1. Setup UI for loading
        this.targetForReplace = active; // Mark this object for replacement later
        const originalText = btnText.innerText;
        btnText.innerText = "Processing...";
        btn.disabled = true;
        btn.style.opacity = "0.7";
        const wrapper = document.querySelector('.canvas-container-wrapper');
        UI.toggleShimmer(wrapper, true);

        try {
            // 2. Get original image data
            // Use originalSrc if available (better quality), otherwise current src
            const srcStr = active.originalSrc || active.getSrc();
            const blob = await fetch(srcStr).then(r => r.blob());

            // 3. Prepare Form Data for the new endpoint
            const fd = new FormData();
            fd.append('file', blob, 'source_image.png');
            fd.append('prompt', prompt);
            fd.append('style', styleInput.value);
            fd.append('model', modelInput.value);

            // 4. Call the new Edit API
            const res = await fetch('/edit-image-ai', {
                method: 'POST',
                body: fd
            });

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.detail || "AI Edit failed");
            }
            const data = await res.json();

            // 5. Replace the image on canvas using your existing replace logic
            // Note: replaceFromUrl handles saving history and rendering
            this.replaceFromUrl(data.url);
            
            // Optional: Clear the edit prompt on success
            // promptInput.value = '';

        } catch (err) {
            console.error(err);
            alert("AI Error: " + err.message);
            this.targetForReplace = null; // Clear target if it failed
        } finally {
            // 6. Reset UI
            btnText.innerText = originalText;
            btn.disabled = false;
            btn.style.opacity = "1";
            UI.toggleShimmer(wrapper, false);
        }
      },

      async loadExternalTemplate() {
        // 1. Check if "?template_id=" exists in the current browser URL
        const urlParams = new URLSearchParams(window.location.search);
        const tplId = urlParams.get('template_id');

        if (tplId) {
            console.log("Found template ID:", tplId);
            
            // Show loading state (optional)
            const wrapper = document.querySelector('.canvas-container-wrapper');
            UI.toggleShimmer(wrapper, true);

            try {
                // 2. Fetch the actual JSON and Caption from the backend
                const response = await fetch(`/get-template-data/${tplId}`);
                const data = await response.json();

                if (data) {
                    // 3. Store the caption in your hidden variable
                    document.getElementById('hidden-caption').value = data.caption;
                    
                    // 4. Load the JSON into the Fabric Canvas
                    canvas.loadFromJSON(data.json, () => {
                        canvas.renderAll();
                        UI.refreshLayers();
                        UI.toggleShimmer(wrapper, false);
                        History.save(); // Initialize history with this design
                    });
                }
            } catch (err) {
                console.error("Failed to load template data", err);
                UI.toggleShimmer(wrapper, false);
            }
        }
      },

      applyPresetStyle(styleName) {
        let active = canvas.getActiveObject();
      
        if (!active || active.type !== 'textbox') {
            this.addText();
            active = canvas.getActiveObject();
            active.set('text', "Title"); 
        }
      
        const baseConfig = {
            textAlign: 'center',
            originX: 'center',
            originY: 'center',
            shadow: null,
            stroke: null,
            strokeWidth: 0,
            backgroundColor: '', 
            textBackgroundColor: '',
            fontStyle: 'normal',
            padding: 10
        };
      
        active.set(baseConfig);
      
        switch(styleName) {
            case 'popup':
                active.set({
                    fontFamily: 'Playfair Display',
                    fontStyle: 'italic',
                    fontWeight: '400',
                    fill: '#ffffff',
                    backgroundColor: '#2D1B69',
                    padding: 20
                });
                break;
            case 'hey':
                active.set({
                    fontFamily: 'Inter',
                    fontWeight: '800',
                    fill: '#0000FF',
                    backgroundColor: '#FFC0CB',
                    padding: 15,
                    shadow: new fabric.Shadow({ color: 'white', blur: 0, offsetX: 3, offsetY: 3 })
                });
                break;
            case 'story':
                active.set({
                    fontFamily: 'Playfair Display',
                    fontWeight: '400',
                    fill: '#000000',
                    backgroundColor: '#8be4f8',
                    padding: 20
                });
                break;
            case 'offering':
                active.set({
                    fontFamily: 'Inter',
                    fontWeight: '700',
                    fill: '#000000',
                    backgroundColor: '#ffffff',
                    stroke: '#eeeeee',
                    strokeWidth: 2,
                    padding: 15
                });
                break;
            case 'from':
                // Note: Ensure you load 'Rock Salt' or generic cursive in HTML header if needed
                active.set({
                    fontFamily: 'Courier New', 
                    fontWeight: 'bold',
                    fill: '#000000',
                    backgroundColor: '#FFF8F0',
                    padding: 15
                });
                break;
            case 'release':
                active.set({
                    fontFamily: 'Inter',
                    fontWeight: '900',
                    fill: '#000000',
                    backgroundColor: '#dbfecf',
                    padding: 10
                });
                break;
            case 'bigsale':
                active.set({
                    fontFamily: 'Arial', // Fallback for Impact
                    fontWeight: '900',
                    fill: '#000000',
                    backgroundColor: '#F8E71C',
                    text: 'BIG SALE',
                    padding: 15,
                    shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.2)', blur: 0, offsetX: 4, offsetY: 4 })
                });
                break;
            case 'edgy':
                active.set({
                    fontFamily: 'Courier New',
                    fontWeight: '900',
                    fill: '#F0EAD6',
                    backgroundColor: '#2F4858',
                    padding: 20,
                    shadow: new fabric.Shadow({ color: '#000000', blur: 0, offsetX: 5, offsetY: 5 })
                });
                break;
        }
      
        canvas.requestRenderAll();
        UI.syncPanel(active);
        History.save();
      },
      
      toggleTextBg(isChecked) {
        const active = canvas.getActiveObject();
        if(!active) return;
      
        if(isChecked) {
            const color = document.getElementById('prop-textBackgroundColor').value || '#000000';
            active.set('backgroundColor', color);
      
            if((active.padding || 0) === 0) {
                active.set('padding', 10);
                setVal('prop-padding', 10);
            }
        } else {
            active.set('backgroundColor', ''); 
        }
        canvas.requestRenderAll();
      },
      
      updateBgRadius(val) {
        const active = canvas.getActiveObject();
        if(!active) return;
      
        active.set({
            rx: val,
            ry: val
        });
        active.set('dirty', true);
        
        canvas.requestRenderAll();
      },
      
      openSaveModal() {
        document.getElementById('save-modal').style.display = 'flex';
     },
    
     async saveTemplate() {
      const name = document.getElementById('save-name').value;
      if(!name) return alert("Please enter a name");
  
      const btn = document.querySelector('#save-modal .btn-primary');
      btn.innerText = "Saving...";
      btn.disabled = true;
      const baseUrl = window.location.origin;
      const projectData = canvas.toJSON([
          'asset_type', 'server_id', 'selectable', 'evented', 
          'isFrame', 'frameOffsetX', 'frameOffsetY', 'clipPath', 
          'id', 'lockMovementX', 'lockMovementY',
          'isBgRemoved', 'originalSrc'
      ]);
  
      // 3. Loop through objects and fix paths dynamically
      projectData.objects.forEach(obj => {
        const isMedia = obj.type === 'image' || obj.asset_type === 'image' || obj.asset_type === 'video';
        
        if (isMedia && obj.server_id && obj.src && obj.src.startsWith('blob:')) {
            obj.src = `${baseUrl}/uploads/${obj.server_id}`;
        }
        
    });
  
      const json = JSON.stringify(projectData);
      canvas.discardActiveObject(); 
      canvas.renderAll();
      
      const dataURL = canvas.toDataURL({ format: 'png', multiplier: 0.5 }); 
      const blob = await (await fetch(dataURL)).blob();
  
      const fd = new FormData();
      fd.append('name', name);
      fd.append('type', document.getElementById('save-type').value);
      fd.append('category', document.getElementById('save-category').value);
      fd.append('style', document.getElementById('save-style').value);
      fd.append('width', PREVIEW_W);
      fd.append('height', PREVIEW_H);
      fd.append('json_data', json);
      fd.append('preview', blob, 'preview.png');
  
      try {
          const res = await fetch('/save-template', { method:'POST', body: fd });
          const data = await res.json();
          if(data.status === 'success') {
              document.getElementById('save-modal').style.display = 'none';
              alert("Template Saved!");
          }
      } catch(err) {
          alert("Error saving: " + err);
      } finally {
          btn.innerText = "Save Template";
          btn.disabled = false;
      }
  },
      
      cachedTemplates: [], 
      
      async fetchTemplates() {
          const type = document.getElementById('filter-type').value;
          const category = document.getElementById('filter-category').value;
          const style = document.getElementById('filter-style').value;
      
          let url = `/templates?`;
          if(type !== 'All') url += `type=${type}&`;
          if(category !== 'All') url += `category=${category}&`;
          if(style !== 'All') url += `style=${style}`;
      
          const res = await fetch(url);
          this.cachedTemplates = await res.json();
          this.renderTemplateGrid(this.cachedTemplates);
      },
      
      renderTemplateGrid(templates) {
    const grid = document.getElementById('templates-grid');
    const search = document.getElementById('tpl-search').value.toLowerCase();
    
    // Clear the grid
    grid.innerHTML = '';
    
    const filtered = templates.filter(t => 
        t.name.toLowerCase().includes(search) || 
        t.category.toLowerCase().includes(search)
    );

    // Empty State with Lucide-style UI
    if (filtered.length === 0) {
        grid.innerHTML = `
            <div class="col-span-2 flex flex-col items-center justify-center py-20 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mb-4 opacity-20"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <p class="text-sm font-medium">No templates match your search</p>
            </div>
        `;
        return;
    }

    filtered.forEach(t => {
        const thumbUrl = `/uploads/${t.preview_url}`; 
        
        // Create the card container
        const card = document.createElement('div');
        // Match the layout from the image: vertical stack
        card.className = 'group cursor-pointer flex flex-col gap-2';
        
        card.innerHTML = `
            <div class="relative aspect-[2/3] w-full overflow-hidden rounded-2xl border border-gray-100 bg-gray-50 transition-all duration-300 group-hover:shadow-md group-hover:border-gray-200">
                <img 
                    src="${thumbUrl}" 
                    alt="${t.name}" 
                    class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                    onerror="this.src='https://placehold.co/400x600?text=No+Preview'"
                >
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors duration-300"></div>
            </div>

            <div class="px-1">
                <h3 class="text-[15px] font-medium text-gray-800 truncate leading-tight">
                    ${t.name}
                </h3>
                <p class="text-xs text-gray-500 mt-1 font-medium">
                    ${t.category} â¢ ${t.width}Ã${t.height}
                </p>
            </div>
        `;

        // Preserve your original onclick logic
        card.onclick = () => this.loadTemplate(t);
        
        grid.appendChild(card);
    });
},
      
      filterTemplates() {
          this.fetchTemplates(); 
      },
      
      loadTemplate(t) {
        if(!confirm("Load this template? Current work will be replaced.")) return;
        
        const wrapper = document.querySelector('.canvas-container-wrapper');
        UI.toggleShimmer(wrapper, true); // Start Shimmer

        PREVIEW_W = t.width;
        PREVIEW_H = t.height;
        canvas.setDimensions({ width: PREVIEW_W, height: PREVIEW_H });
        
        wrapper.style.width = PREVIEW_W + "px";
        wrapper.style.height = PREVIEW_H + "px";
        
        canvas.loadFromJSON(t.json_data, () => {
            canvas.renderAll();
            History.init();
            UI.refreshLayers();
            setTimeout(() => UI.toggleShimmer(wrapper, false), 500);
        });
      },
    
      exportProject() {
        const objects = canvas.getObjects();
        const bg = canvas.backgroundColor;
      
        const hasVideo = objects.some(o => o.asset_type === 'video');
      
        if (!hasVideo) {
          const url = canvas.toDataURL({ format: 'png', multiplier: EXPORT_SCALE });
          const a = document.createElement('a');
          a.href = url;
          a.download = 'design.png';
          a.click();
          return;
        }
      
        const layers = objects.map(obj => {

          const sX = obj.scaleX * EXPORT_SCALE;
          const sY = obj.scaleY * EXPORT_SCALE;
          const center = obj.getCenterPoint();
          
          let type = 'unknown';
          let shapeType = null;

          if (obj.isFrame) {
              type = 'frame';

              if (obj.clipPath instanceof fabric.Circle) {
                  shapeType = 'circle';
              } else if (obj.clipPath instanceof fabric.Polygon) {
                  shapeType = 'diamond'; // Your diamond is a polygon
              } else {
                  shapeType = 'rect';
              }
          }
          // 2. Existing Type Checks (Video, Image, Shape)
          else if(obj.type === 'textbox') { type = 'text'; }
          else if(obj.asset_type === 'video') { type = 'video'; }
          else if(obj.asset_type === 'image' || obj.type === 'image') { type = 'image'; }
          else if(obj.asset_type === 'shape' || obj.type === 'rect' || obj.type === 'circle') {
              type = 'shape';
              // ... your existing shape detection ...
              if (obj.type === 'rect') shapeType = 'rect';
              if (obj.type === 'circle') shapeType = 'circle';
              if (obj.type === 'triangle') shapeType = 'triangle';
              if (obj.type === 'path') shapeType = obj.iconType || 'star';
          }
      
          const source = obj.server_id || obj.text || "";
      
          const layerData = {
            type: type,
            shape_type: shapeType, 
            source: source,
            x: center.x * EXPORT_SCALE,
            y: center.y * EXPORT_SCALE,
            width: obj.width * sX,
            height: obj.height * sY,
            angle: obj.angle || 0,
            opacity: typeof obj.opacity === 'number' ? obj.opacity : 1
          };
      
          // Add Color for Shapes
          if (type === 'shape') {
              layerData.color = obj.fill || '#000000';
          }
      
          if (type === 'text') {
            layerData.color = obj.fill;
            layerData.font_family = obj.fontFamily;
            layerData.font_size = obj.fontSize * sY;
            layerData.font_weight = obj.fontWeight; 
            layerData.font_style = obj.fontStyle;   
            layerData.underline = !!obj.underline;
            layerData.linethrough = !!obj.linethrough;
            
            layerData.line_height = obj.lineHeight;
            layerData.char_spacing = obj.charSpacing;
            
            if (obj.stroke && obj.strokeWidth > 0) {
                layerData.border_color = obj.stroke;
                layerData.border_width = obj.strokeWidth * sY; 
            }
            
            if (obj.textBackgroundColor) {
                layerData.background_color = obj.textBackgroundColor;
            }
      
            if (obj.shadow) {
              layerData.shadow_color = obj.shadow.color;
              layerData.shadow_blur = obj.shadow.blur;
              layerData.shadow_offset_x = obj.shadow.offsetX;
              layerData.shadow_offset_y = obj.shadow.offsetY;
            }
          }
          return layerData;
        });
      
      
        const btn = document.getElementById('exportBtn');
        btn.innerText = "Rendering...";
        btn.disabled = true;
      
        fetch('/render', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            background: bg === '#FFFFFF' || typeof bg !== 'string' ? 'black' : bg,
            layers: layers,
            width: PREVIEW_W * EXPORT_SCALE, 
            height: PREVIEW_H * EXPORT_SCALE 
          })
        })
        .then(async res => {
            if (!res.ok) throw await res.text();
            return res.blob();
        })
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'final_video.mp4';
            a.click();
        })
        .catch(err => alert("Render Error: " + err))
        .finally(() => {
            btn.innerText = "Download";
            btn.disabled = false;
        });
      }
      
      
    };
      
    
    const UI = {
      showView(viewName) {
    
          // Exit pen tool drawing mode if switching away from draw view
          if (typeof PenTool !== 'undefined' && PenTool.isActive && viewName !== 'draw') {
              PenTool.exit();
          }
    
          document.querySelectorAll('.sidebar-view').forEach(el => el.classList.remove('active'));
          document.getElementById('btn-layers-toggle').classList.remove('active');
          
          // Expand sidebar if collapsed
          const sidebar = document.getElementById('sidebar-panel');
          if(sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
          }
          
          // Update aside nav-item active states
          document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
          const asideBtn = document.querySelector(`.nav-item[onclick*="'${viewName}'"]`);
          if(asideBtn) asideBtn.classList.add('active');
    
          const target = document.getElementById('view-' + viewName);
          if(target) target.classList.add('active');
    
          const titleEl = document.getElementById('sidebar-title');
        
          if(viewName === 'media') titleEl.innerText = "Media Library";
          
          else if(viewName === 'background') titleEl.innerText = "Background";
          else if(viewName === 'elements') titleEl.innerText = "Elements";
          else if(viewName === 'text') titleEl.innerText = "Text";
          else if(viewName === 'resize') titleEl.innerText = "Resize Canvas";
          else if(viewName === 'properties') titleEl.innerText = "Edit Properties";
          else if(viewName === 'layers') {
              titleEl.innerText = "Layers";
              document.getElementById('btn-layers-toggle').classList.add('active');
              this.refreshLayers();
          }
          else if(viewName === 'templates') {
            titleEl.innerText = "Choose Template";
            Editor.fetchTemplates();
          }
          else if(viewName === 'styles') titleEl.innerText = "Text Styles";
          else if(viewName === 'draw') {
              titleEl.innerText = "Draw & Sketch";
              if (typeof lucide !== 'undefined') lucide.createIcons();
          }
      },
      
      toggleSidebar() {
        const sidebar = document.getElementById('sidebar-panel');
        sidebar.classList.toggle('collapsed');
        // Refresh Lucide icons after transition
        setTimeout(() => {
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }, 300);
      },
      
      toggleShimmer(targetElement, show = true) {
        if (!targetElement) return;
        
        if (show) {
            targetElement.classList.add('shimmer-active');
            const shimmer = document.createElement('div');
            shimmer.className = 'shimmer-overlay';
            targetElement.appendChild(shimmer);
        } else {
            targetElement.classList.remove('shimmer-active');
            const overlay = targetElement.querySelector('.shimmer-overlay');
            if (overlay) overlay.remove();
        }
      },

      toggleLayers() {
          const layersView = document.getElementById('view-layers');
          if (layersView.classList.contains('active')) {
              // If already open, go back to context (Background or Properties)
              const active = canvas.getActiveObject();
              if(active) this.showView('properties');
              else this.showView('background');
          } else {
              this.showView('layers');
          }
      },

      toggleTextureCategory(category) {
          // Close all texture panels first
          document.querySelectorAll('.texture-panel').forEach(panel => {
              panel.classList.add('hidden');
          });
          
          // Toggle the target panel
          const panel = document.getElementById('texture-panel-' + category);
          if (panel) {
              panel.classList.remove('hidden');
              // Refresh Lucide icons for the new panel
              if (typeof lucide !== 'undefined') lucide.createIcons();
          }
      },

      closeTexturePanel() {
          document.querySelectorAll('.texture-panel').forEach(panel => {
              panel.classList.add('hidden');
          });
      },
    
      syncPanel(obj) {
        const typeTitle = obj.type === 'textbox' ? 'Text Properties' : 
                          obj.asset_type === 'video' ? 'Video Properties' : 'Image Properties';
        document.getElementById('sidebar-title').innerText = typeTitle;
    
        setVal('prop-opacity', obj.opacity || 1);
        setVal('prop-angle', obj.angle || 0);
    
        const textSection = document.getElementById('text-controls');
        const imgSection = document.getElementById('image-controls');
        
        if (obj.type === 'textbox') {
          textSection.style.display = 'block';
          imgSection.style.display = 'none';
    
          const hasBg = obj.backgroundColor && obj.backgroundColor.length > 0;
          document.getElementById('check-bgColor').checked = hasBg;
          setVal('prop-textBackgroundColor', hasBg ? obj.backgroundColor : '#ffffff');
          setVal('prop-padding', obj.padding || 0);
          setVal('prop-bgRadius', obj.rx || 0);
    
            const hasShadow = !!obj.shadow;
            document.getElementById('check-shadow').checked = hasShadow;
            
            const shadowInputs = document.getElementById('shadow-inputs');
            
            if(hasShadow) {
              shadowInputs.style.opacity = "1";
              shadowInputs.style.pointerEvents = "auto";
              setVal('prop-shadowColor', obj.shadow.color || '#000000');
              setVal('prop-shadowBlur', obj.shadow.blur || 0);
              setVal('prop-shadowOfstX', obj.shadow.offsetX || 0);
              setVal('prop-shadowOfstY', obj.shadow.offsetY || 0);
            } else {
              shadowInputs.style.opacity = "0.5";
              shadowInputs.style.pointerEvents = "none";
              // Keep defaults in sliders so they don't look broken
            }
    
            // Basic Text Props
            setVal('prop-fontFamily', obj.fontFamily);
            setVal('prop-fontWeight', obj.fontWeight);
            setVal('prop-fill', obj.fill);
            document.getElementById('display-fontSize').innerText = obj.fontSize;
            
            setVal('prop-charSpacing', obj.charSpacing);
            setVal('prop-lineHeight', obj.lineHeight);
            setVal('prop-textBackgroundColor', obj.textBackgroundColor || '#ffffff');
            setVal('prop-stroke', obj.stroke || '#000000');
            setVal('prop-strokeWidth', obj.strokeWidth || 0);
    
            // Sync Shadow Controls
            if(obj.shadow) {
               setVal('prop-shadowColor', obj.shadow.color || '#000000');
               setVal('prop-shadowBlur', obj.shadow.blur || 0);
               setVal('prop-shadowOfstX', obj.shadow.offsetX || 0);
               setVal('prop-shadowOfstY', obj.shadow.offsetY || 0);
            } else {
               // Reset defaults if no shadow
               setVal('prop-shadowColor', '#000000');
               setVal('prop-shadowBlur', 0);
               setVal('prop-shadowOfstX', 0);
               setVal('prop-shadowOfstY', 0);
            }
    
            // Toolbar Buttons
            highlight('btn-bold', obj.fontWeight === 'bold' || obj.fontWeight === '800');
            highlight('btn-italic', obj.fontStyle === 'italic');
            highlight('btn-underline', obj.underline);
            highlight('btn-linethrough', obj.linethrough);
    
        }
        else if (obj.type === 'image' || obj.asset_type === 'image') {
          textSection.style.display = 'none';
          imgSection.style.display = 'block'; 
          const btnBgText = document.getElementById('txt-sidebar-bg');
          const btnSidebar = document.getElementById('btn-sidebar-remove-bg');
          const sidebarIconContainer = btnSidebar.querySelector('.icon-container');

          if (obj.isBgRemoved) {
              btnBgText.innerText = "Revert to Original";
              sidebarIconContainer.innerHTML = '<i data-lucide="rotate-ccw" class="w-4 h-4"></i>';
          } else {
              btnBgText.innerText = "Remove Background";
              sidebarIconContainer.innerHTML = '<i data-lucide="eraser" class="w-4 h-4"></i>';
          }
          lucide.createIcons();
  
          const hasClip = !!obj.clipPath;
          document.getElementById('check-img-rounding').checked = hasClip;
          
          const sliderDiv = document.getElementById('img-radius-slider');
          if(hasClip) {
              sliderDiv.style.opacity = "1";
              sliderDiv.style.pointerEvents = "auto";
              // Retrieve stored radius or guess from clipPath
              const val = obj.customCornerRadius || (obj.clipPath ? obj.clipPath.rx : 0);
              document.getElementById('prop-imgRadius').value = val;
          } else {
              sliderDiv.style.opacity = "0.5";
              sliderDiv.style.pointerEvents = "none";
              document.getElementById('prop-imgRadius').value = 0;
          }
  
      }
        else {
            textSection.style.display = 'none';
        }
      },
      
    
      refreshLayers() {
         const list = document.getElementById('layers-list');
         const emptyState = document.getElementById('layers-empty');
         list.innerHTML = '';
         const objects = canvas.getObjects().slice().reverse();
         
         // Show/hide empty state
         if (objects.length === 0) {
             list.classList.add('hidden');
             emptyState.classList.remove('hidden');
             lucide.createIcons();
             return;
         } else {
             list.classList.remove('hidden');
             emptyState.classList.add('hidden');
         }
         
         objects.forEach((obj, index) => {
             const el = document.createElement('div');
             el.className = 'layer-item group flex items-center gap-3 p-2 bg-white border border-gray-200 rounded-2xl cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition-all';
             if (obj === canvas.getActiveObject()) {
                 el.classList.add('selected');
                 el.classList.remove('border-gray-200');
                 el.classList.add('border-blue-500', 'bg-blue-50', 'ring-1', 'ring-blue-500/20');
             }
             
             let iconName = "square";
             let label = "Layer";
             let iconColor = "text-gray-500";
             
             if(obj.type === 'textbox') { 
                 iconName = "type"; 
                 label = obj.text.substring(0, 15) + (obj.text.length > 15 ? '...' : ''); 
                 iconColor = "text-purple-500";
             }
             else if(obj.asset_type === 'image') { 
                 iconName = "image"; 
                 label = "Image"; 
                 iconColor = "text-emerald-500";
             }
             else if(obj.asset_type === 'video') { 
                 iconName = "video"; 
                 label = "Video"; 
                 iconColor = "text-rose-500";
             }
             else if(obj.type === 'rect' || obj.type === 'circle' || obj.type === 'triangle' || obj.type === 'polygon') { 
                 iconName = "shapes"; 
                 label = obj.type.charAt(0).toUpperCase() + obj.type.slice(1); 
                 iconColor = "text-blue-500";
             }
             else if(obj.type === 'path' || obj.type === 'group') { 
                 iconName = "component"; 
                 label = "Element"; 
                 iconColor = "text-orange-500";
             }
             
             el.innerHTML = `
                 <div class="flex-shrink-0 w-8 h-8 rounded-md bg-gray-100 flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                     <i data-lucide="${iconName}" class="w-4 h-4 ${iconColor}"></i>
                 </div>
                 <span class="flex-1 text-sm font-medium text-gray-700 truncate">${label}</span>
                 <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity"></i>
             `;
             el.onclick = () => {
                 canvas.setActiveObject(objects[index]);
                 canvas.renderAll();
                 this.refreshLayers();
             };
             list.appendChild(el);
         });
         
         // Re-initialize Lucide icons for the newly added elements
         lucide.createIcons();
      }
    };
    
    // Helpers
    function setVal(id, val) {
        const el = document.getElementById(id);
        if(el) el.value = val;
    }
    function highlight(id, active) {
        const el = document.getElementById(id);
        if(active) el.classList.add('active'); else el.classList.remove('active');
    }
    function getContrastColor(hexColor) {
      if (!hexColor || typeof hexColor !== 'string') return '#000000'; // Default to black if no color
      const hex = hexColor.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;
      return brightness > 128 ? '#000000' : '#ffffff';
    }
    
    // QuickToolbar Controller - Manages context-aware floating toolbars
    const QuickToolbar = {
      bgToolbar: null,
      textToolbar: null,
      imageToolbar: null,
      
      init() {
        this.bgToolbar = document.getElementById('bg-quick-toolbar');
        this.textToolbar = document.getElementById('text-quick-toolbar');
        this.imageToolbar = document.getElementById('image-quick-toolbar');
        
        // Refresh Lucide icons in toolbars
        lucide.createIcons();
      },
      
      // Hide all toolbars
      hideAll() {
        if (this.bgToolbar) this.bgToolbar.classList.add('hidden');
        if (this.textToolbar) this.textToolbar.classList.add('hidden');
        if (this.imageToolbar) this.imageToolbar.classList.add('hidden');
      },
      
      // Show the background quick toolbar when no element is selected
      showBgToolbar() {
        this.hideAll();
        if (this.bgToolbar) {
          this.bgToolbar.classList.remove('hidden');
          lucide.createIcons();
        }
      },
      
      // Hide the background quick toolbar
      hideBgToolbar() {
        if (this.bgToolbar) {
          this.bgToolbar.classList.add('hidden');
        }
      },
      
      // Show the text toolbar with formatting options
      showTextToolbar(obj) {
        if (!this.textToolbar || !obj) return;
        
        this.hideAll();
        this.textToolbar.classList.remove('hidden');
        
        // Sync toolbar with object properties
        this.syncTextToolbar(obj);
        
        lucide.createIcons();
      },
      
      // Sync text toolbar controls with the selected text object
      syncTextToolbar(obj) {
        if (!obj || obj.type !== 'textbox') return;
        
        // Font Family
        const fontSelect = document.getElementById('qt-font-family');
        if (fontSelect) fontSelect.value = obj.fontFamily || 'Inter';
        
        // Font Size
        const sizeDisplay = document.getElementById('qt-font-size');
        if (sizeDisplay) sizeDisplay.innerText = obj.fontSize || 40;
        
        // Text Color
        const colorPreview = document.getElementById('qt-color-preview');
        const colorInput = document.getElementById('qt-text-color');
        if (colorPreview) colorPreview.style.backgroundColor = obj.fill || '#000000';
        if (colorInput) colorInput.value = obj.fill || '#000000';
        
        // Bold button active state
        const boldBtn = document.getElementById('qt-bold');
        if (boldBtn) {
          const isBold = obj.fontWeight === 'bold' || parseInt(obj.fontWeight) >= 600;
          boldBtn.classList.toggle('bg-gray-200', isBold);
          boldBtn.classList.toggle('text-gray-900', isBold);
        }
        
        // Italic button active state
        const italicBtn = document.getElementById('qt-italic');
        if (italicBtn) {
          italicBtn.classList.toggle('bg-gray-200', obj.fontStyle === 'italic');
          italicBtn.classList.toggle('text-gray-900', obj.fontStyle === 'italic');
        }
        
        // Underline button active state
        const underlineBtn = document.getElementById('qt-underline');
        if (underlineBtn) {
          underlineBtn.classList.toggle('bg-gray-200', !!obj.underline);
          underlineBtn.classList.toggle('text-gray-900', !!obj.underline);
        }
        
        // Strikethrough button active state
        const strikeBtn = document.getElementById('qt-strikethrough');
        if (strikeBtn) {
          strikeBtn.classList.toggle('bg-gray-200', !!obj.linethrough);
          strikeBtn.classList.toggle('text-gray-900', !!obj.linethrough);
        }
      },
      
      // Show the image toolbar with image editing options
      showImageToolbar(obj) {
        if (!this.imageToolbar || !obj) return;
        
        this.hideAll();
        this.imageToolbar.classList.remove('hidden');
        
        // Sync toolbar with object properties
        this.syncImageToolbar(obj);
        
        lucide.createIcons();
      },
      
      // Sync image toolbar controls with the selected image object
      syncImageToolbar(obj) {
        if (!obj) return;
        
        // Update Remove BG button text based on state
        const bgText = document.getElementById('qt-remove-bg-text');
        if (bgText) {
          bgText.innerText = obj.isBgRemoved ? 'Restore BG' : 'Remove BG';
        }
      },
      
      // Handle selection - show appropriate toolbar based on element type
      onSelection(obj) {
        if (!obj) return;
        
        if (obj.type === 'textbox') {
          this.showTextToolbar(obj);
        } else if (obj.type === 'image' || obj.asset_type === 'image') {
          this.showImageToolbar(obj);
        } else {
          // For other elements, show the bg toolbar (or could create a generic element toolbar)
          this.showBgToolbar();
        }
      },
      
      // Handle deselection - hide all element toolbars, show bg toolbar
      onDeselection() {
        this.showBgToolbar();
      },
      
      // Update toolbar when object is modified (e.g., font size changed from sidebar)
      onObjectModified(obj) {
        if (!obj) return;
        
        if (obj.type === 'textbox') {
          this.syncTextToolbar(obj);
        } else if (obj.type === 'image' || obj.asset_type === 'image') {
          this.syncImageToolbar(obj);
        }
      },
      
      // Placeholder for Magic BG feature
      showMagicBg() {
        // Open background panel with AI features
        UI.showView('background');
        this.hideBgToolbar();
      }
    };

    // PenTool Controller - Manages freehand drawing functionality
    const PenTool = {
      isActive: false,
      currentColor: '#000000',
      currentWidth: 5,
      currentOpacity: 1,
      currentBrushType: 'pencil',
      brushTypes: ['pencil', 'circle', 'spray'],
      quickToolbar: null,
      
      init() {
        this.quickToolbar = document.getElementById('draw-quick-toolbar');
        
        // Set up path:created event to save to history and refresh layers
        canvas.on('path:created', (e) => {
          if (this.isActive) {
            e.path.set({
              asset_type: 'drawing',
              selectable: true,
              evented: true
            });
            History.save();
            UI.refreshLayers();
          }
        });
      },
      
      // Toggle drawing mode on/off
      toggle() {
        if (this.isActive) {
          this.exit();
        } else {
          this.enter();
        }
      },
      
      // Enter drawing mode
      enter() {
        this.isActive = true;
        canvas.isDrawingMode = true;
        
        // Set up the brush
        this.applyBrushSettings();
        
        // Update UI
        const btn = document.getElementById('btn-toggle-draw');
        if (btn) {
          btn.innerText = 'Stop Drawing';
          btn.classList.remove('bg-cyan-600', 'hover:bg-cyan-700');
          btn.classList.add('bg-red-500', 'hover:bg-red-600');
        }
        
        // Show quick toolbar
        this.showQuickToolbar();
        
        // Hide other toolbars
        if (typeof QuickToolbar !== 'undefined') {
          QuickToolbar.hideAll();
        }
        
        // Clear any selection
        canvas.discardActiveObject();
        canvas.renderAll();
      },
      
      // Exit drawing mode
      exit() {
        this.isActive = false;
        canvas.isDrawingMode = false;
        
        // Update UI
        const btn = document.getElementById('btn-toggle-draw');
        if (btn) {
          btn.innerText = 'Start Drawing';
          btn.classList.remove('bg-red-500', 'hover:bg-red-600');
          btn.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
        }
        
        // Hide quick toolbar
        this.hideQuickToolbar();
        
        // Show bg toolbar
        if (typeof QuickToolbar !== 'undefined') {
          QuickToolbar.showBgToolbar();
        }
        
        canvas.renderAll();
      },
      
      // Apply current brush settings to canvas
      applyBrushSettings() {
        let brush;
        
        switch (this.currentBrushType) {
          case 'circle':
            brush = new fabric.CircleBrush(canvas);
            break;
          case 'spray':
            brush = new fabric.SprayBrush(canvas);
            break;
          case 'pencil':
          default:
            brush = new fabric.PencilBrush(canvas);
            break;
        }
        
        brush.color = this.hexToRgba(this.currentColor, this.currentOpacity);
        brush.width = this.currentWidth;
        
        canvas.freeDrawingBrush = brush;
      },
      
      // Convert hex color to rgba with opacity
      hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      },
      
      // Set brush color
      setColor(color) {
        this.currentColor = color;
        this.applyBrushSettings();
        
        // Update UI
        const preview = document.getElementById('qt-draw-color-preview');
        if (preview) preview.style.backgroundColor = color;
      },
      
      // Set brush width
      setWidth(width) {
        this.currentWidth = Math.max(1, Math.min(50, width));
        this.applyBrushSettings();
        
        // Update quick toolbar
        const display = document.getElementById('qt-draw-size');
        if (display) display.innerText = this.currentWidth;
        
        // Update sidebar slider
        const slider = document.getElementById('draw-brush-width');
        if (slider) slider.value = this.currentWidth;
      },
      
      // Adjust brush width by delta
      adjustWidth(delta) {
        this.setWidth(this.currentWidth + delta);
        
        // Update sidebar display
        const display = document.getElementById('draw-width-display');
        if (display) display.innerText = this.currentWidth + 'px';
      },
      
      // Set opacity
      setOpacity(opacity) {
        this.currentOpacity = opacity;
        this.applyBrushSettings();
      },
      
      // Set brush type
      setBrushType(type) {
        this.currentBrushType = type;
        this.applyBrushSettings();
        
        // Update UI - reset all buttons
        const buttons = document.querySelectorAll('.brush-type-btn');
        buttons.forEach(btn => {
          btn.classList.remove('bg-cyan-50', 'border-cyan-500');
          btn.classList.add('bg-gray-50', 'border-gray-200');
          const icon = btn.querySelector('i');
          const span = btn.querySelector('span');
          if (icon) {
            icon.classList.remove('text-cyan-600');
            icon.classList.add('text-gray-600');
          }
          if (span) {
            span.classList.remove('text-cyan-600');
            span.classList.add('text-gray-600');
          }
        });
        
        // Highlight active button
        const activeBtn = document.getElementById('brush-' + type);
        if (activeBtn) {
          activeBtn.classList.remove('bg-gray-50', 'border-gray-200');
          activeBtn.classList.add('bg-cyan-50', 'border-cyan-500');
          const icon = activeBtn.querySelector('i');
          const span = activeBtn.querySelector('span');
          if (icon) {
            icon.classList.remove('text-gray-600');
            icon.classList.add('text-cyan-600');
          }
          if (span) {
            span.classList.remove('text-gray-600');
            span.classList.add('text-cyan-600');
          }
        }
      },
      
      // Cycle through brush types (for quick toolbar)
      cycleBrushType() {
        const currentIndex = this.brushTypes.indexOf(this.currentBrushType);
        const nextIndex = (currentIndex + 1) % this.brushTypes.length;
        this.setBrushType(this.brushTypes[nextIndex]);
      },
      
      // Show the quick toolbar
      showQuickToolbar() {
        if (this.quickToolbar) {
          this.quickToolbar.classList.remove('hidden');
          
          // Sync UI
          const preview = document.getElementById('qt-draw-color-preview');
          if (preview) preview.style.backgroundColor = this.currentColor;
          
          const sizeDisplay = document.getElementById('qt-draw-size');
          if (sizeDisplay) sizeDisplay.innerText = this.currentWidth;
          
          lucide.createIcons();
        }
      },
      
      // Hide the quick toolbar
      hideQuickToolbar() {
        if (this.quickToolbar) {
          this.quickToolbar.classList.add('hidden');
        }
      },
      
      // Clear all drawings from canvas
      clearDrawings() {
        const drawings = canvas.getObjects().filter(obj => obj.asset_type === 'drawing');
        drawings.forEach(obj => canvas.remove(obj));
        canvas.renderAll();
        History.save();
        UI.refreshLayers();
      }
    };

    Editor.init();
    
    // Initialize QuickToolbar after Editor
    setTimeout(() => {
      QuickToolbar.init();
      PenTool.init();
      // Show bg toolbar initially since no element is selected
      QuickToolbar.showBgToolbar();
    }, 100);
</script>
<script>
</script>
</body>
</html>